$RuOBSD: README,v 1.19 2004/04/19 12:53:40 form Exp $

------------------------------ цут хере ---------------------------------

cnupm
~~~~~

Йи-ик!
------
    Ну ладно, уломали... Эта программа в отличие от других  UNIX  программ,
написанных мной, будет поддерживаться.  Так что все замечания и предложения
можно слать мне на form@pdp-11.org.ru. :)


Чё это за фигня
---------------
  Как обычно, у моих UNIX программ слегка алкогольный уклон. :) Программа
cnupm заменяет ранее написанную мной программу  nuBo.  Можно сказать  что
после перегонки пива получился спирт. :)
  Итак,  программа  cnupm  предназначена  для подсчета IP/IPv6 трафика на
сетевом интерфейсе с  возможностью  указания  tcpdump-подобных  выражений
для указания какой именно трафик нужно  считать.  Основное  отличие cnupm
от других подобных программ состоит в гораздо меньшей загрузке процессора
во время работы и в корректной работе с tun и lo в OpenBSD.
  На данный момент вся эта фигня состоит  из  двух  программ:  собственно
cnupm - сборщика статистики трафика  и  cnupmstat - программы  распечатки
собранной статистики.


Сборка и установка
------------------
  В данный момент программа оформлена для сборки в BSD системах (OpenBSD,
FreeBSD, NetBSD), Linux (пробовалось в RedHat) и QNX (пробовалось на  QNX
Neutrino 6.2.1),  но  в  принципе  может  быть легко портирована в другие
системы, в которых есть поддержка libpcap.
  Сборка и установка программы очень проста:

# make depend && make && make install

  Далее  нужно  добавить  в пользователя и группу cnupm. Во время  работы
программа  cnupm  делает chroot в домашний каталог данного пользователя и
меняет свои права на него.

Для BSD систем, отредактируйте файлы /etc/group и /etc/master.passwd:

/etc/group:
  cnupm:*:666:

/etc/master.passwd:
  cnupm:*:666:666::0:0:Cnupm traffic collector:/var/cnupm:/sbin/nologin

Для Linux систем используйте команду:

# useradd -c 'Cnupm traffic collector' -u 666 -g cnupm -s /sbin/nologin \
  -d /var/cnupm cnupm

# install -o cnupm -g cnupm -m 750 -d /var/cnupm


Запуск программы
----------------

# cnupm [-deNOpPV] [-f family] [-F file] [-i interface] [-u user] [expression]

-d		- Не  отцепляться   от  терминала,   дублировать   syslog
		  сообщения программы на stderr
-e		- Делать запись в файле трафика даже если не было собрано
		  никакой статистики
-f family	- Собирать  статистику  только  для  заданного  семейства
		  адресов (inet/inet6)
-F file		- Читать  tcpdump  выражения  из  файла  вместо командной
		  строки
-i inerface	- Собирать  статистику   на   указанном   интерфейсе.  По
		  умолчанию  ищется  первый  попавшийся   в   системе  за
		  исключением loopback
-m maxentries	- Хранить в памяти не более maxentries  записей  трафика.
		  Допустимые значения от 1024 до 102400
-N		- Не  собирать  статистику  по  протоколам.  Данная опция
		  также запрещает сбор статистики по TCP/UDP портам
-O		- Не включать оптимизатор пакетного фильтра (нужно только
		  в случае если были обнаружены ошибки в bpf)
-p		- Не включать promiscuous mode на интерфейсе
-P		- Не собирать статистику по TCP/UDP портам
-q		- Не мучать syslog на предмет числа записей, сброшенных в
		  файл (полезно если такой сброс делается часто)
-u user		- Менять права на указанного пользователя и делать chroot
		  на его домашний каталог вместо пользователя cnupm
-V		- Напечатать версию программы и библиотеки libpcap.
expression	- Стандартное  tcpdump-подобное  выражение  для  указания
		  какой именно трафик следует учитывать

# cnupmstat [-BEFnNPV] [-d delim ] [-f family] [-p protocol] [-u user]
            interface [...]

-B		- Не выводить дату и время начала сбора статистики
-d delim	- Использовать символ delim  как  разделитель  полей  (по
		  умолчанию используется символ пробела)
-E		- Не выводить дату и время окончания сбора статистики
-f family	- Выводить  только  статистику  по  указанному  семейству
		  адресов (inet или inet6)
-F		- Указывает  что  аргументы,  перечисленные  в  командной
		  строке  являются   именами   файлов,   а   не   сетевых
		  интерфейсов
-n		- Выводить IP/IPv6 протокол  в  виде  цифрового  значения
		  (см. /etc/protocols)
-N		- Не выводить IP/IPv6 протокол
-p protocol	- Выводить  только  статистику  по  указанному  протоколу
		  (можно указывать в  виде  названия  протокола  или  его
		  цифровом значении (см. /etc/protocols))
-P		- Не выводить номера TCP/UDP портов
-u user		- Использовать домашний каталог  указанного  пользователя
		  для поиска файлов трафика вместо пользователя cnupm
interface	- Интерфейс для  которого  следует  печатать  статистику.
		  Можно указать несколько интерфейсов.

Формат вывода статистики cnupmstat:

<beg_date> <end_date> <src_addr> <dst_addr> <ip_proto> <nbytes>

<beg_date>	- Дата и время начала сбора статистики
<end_date>	- Дата и время окончания сбора статистики  (время  сброса
		  статистики в файл)
<src_addr>	- Адрес источника  (может  содержать  TCP/UDP  порт  если
		  программа скомпилирована с -DPORTS)
<dst_addr>	- Адрес приемника (может  содержать  TCP/UDP  порт  если
		  программа скомпилирована с -DPORTS)
<ip_proto>	- IP/IPv6  протокол.  Данное  поле   не   выводится  если
		  программа не была скомпилирована с -DPROTO
<nbytes>	- Число переданных байт

----------------------------- и хере цут --------------------------------

ЦОПЫРИГХТ (Ц) 2003-2004 ОЛЕГ САФИУЛЛИН <ФОРМЮПДП-11.ОРГ.РУ>
АЛЛ РИГХТС РЕСЕРЖЕД.

РЕДИСТРИБУТИОН  АНД  УСЕ  ИН  СОУРЦЕ  АНД  БИНАРЫ  ФОРМС,  ВИТХ ОР ВИТХОУТ
МОДИФИЦАТИОН,  АРЕ  ПЕРМИТТЕД  ПРОЖИДЕД  ТХАТ  ТХЕ  ФОЛЛОВИНГ   ЦОНДИТИОНС
АРЕ МЕТ:
1. РЕДИСТРИБУТИОНС  ОФ  СОУРЦЕ ЦОДЕ МУСТ РЕТАИН ТХЕ АБОЖЕ ЦОПЫРИГХТ НОТИЦЕ
   УНМОДИФИЕД, ТХИС ЛИСТ ОФ ЦОНДИТИОНС, АНД ТХЕ ФОЛЛОВИНГ ДИСЦЛАИМЕР.
2. РЕДИСТРИБУТИОНС  ИН  БИНАРЫ  ФОРМ  МУСТ  РЕПРОДУЦЕ  ТХЕ АБОЖЕ ЦОПЫРИГХТ
   НОТИЦЕ,  ТХИС  ЛИСТ  ОФ  ЦОНДИТИОНС АНД ТХЕ ФОЛЛОВИНГ ДИСЦЛАИМЕР ИН ТХЕ
   ДОЦУМЕНТАТИОН АНД/ОР ОТХЕР МАТЕРИАЛС ПРОЖИДЕД ВИТХ ТХЕ ДИСТРИБУТИОН.

ТХИС СОФТВАРЕ ИС ПРОЖИДЕД БЫ ТХЕ АУТХОР АНД ЦОНТРИБУТОРС ``АС ИС'' АНД АНЫ
ЕЬПРЕСС  ОР ИМПЛИЕД ВАРРАНТИЕС, ИНЦЛУДИНГ, БУТ НОТ ЛИМИТЕД ТО, ТХЕ ИМПЛИЕД
ВАРРАНТИЕС  ОФ  МЕРЦХАНТАБИЛИТЫ  АНД  ФИТНЕСС ФОР А ПАРТИЦУЛАР ПУРПОСЕ АРЕ
ДИСЦЛАИМЕД. ИН НО ЕЖЕНТ СХАЛЛ ТХЕ АУТХОР ОР ЦОНТРИБУТОРС БЕ ЛИАБЛЕ ФОР АНЫ
ДИРЕЦТ, ИНДИРЕЦТ, ИНЦИДЕНТАЛ, СПЕЦИАЛ, ЕЬЕМПЛАРЫ, ОР ЦОНСЕЯУЕНТИАЛ ДАМАГЕС
(ИНЦЛУДИНГ,  БУТ  НОТ  ЛИМИТЕД  ТО,  ПРОЦУРЕМЕНТ  ОФ  СУБСТИТУТЕ  ГООДС ОР
СЕРЖИЦЕС; ЛОСС ОФ УСЕ, ДАТА, ОР ПРОФИТС; ОР БУСИНЕСС ИНТЕРРУПТИОН) ХОВЕЖЕР
ЦАУСЕД  АНД  ОН  АНЫ  ТХЕОРЫ  ОФ  ЛИАБИЛИТЫ,  ВХЕТХЕР  ИН ЦОНТРАЦТ, СТРИЦТ
ЛИАБИЛИТЫ,  ОР ТОРТ (ИНЦЛУДИНГ НЕГЛИГЕНЦЕ ОР ОТХЕРВИСЕ) АРИСИНГ ИН АНЫ ВАЫ
ОУТ  ОФ  ТХЕ  УСЕ  ОФ ТХИС СОФТВАРЕ, ЕЖЕН ИФ АДЖИСЕД ОФ ТХЕ ПОССИБИЛИТЫ ОФ
СУЦХ ДАМАГЕ.
