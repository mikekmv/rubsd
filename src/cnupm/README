$RuOBSD: README,v 1.23 2004/04/26 04:06:43 form Exp $

------------------------------ цут хере ---------------------------------

cnupm
~~~~~

Йи-ик!
------
    Ну ладно, уломали... Эта программа в отличие от других UNIX программ,
написанных  мной,  будет  поддерживаться.  Так   что   все   замечания  и
предложения можно слать мне на form@pdp-11.org.ru. :)


Чё это за фигня
---------------
  Как обычно, у моих UNIX программ слегка алкогольный уклон. :) Программа
cnupm заменяет ранее написанную мной программу  nuBo.  Можно сказать  что
после перегонки пива получился спирт. :)
  Итак,  программа  cnupm  предназначена  для подсчета IP/IPv6 трафика на
сетевом интерфейсе с  возможностью  указания  tcpdump-подобных  выражений
для указания какой именно трафик нужно  считать.  Основное  отличие cnupm
от других подобных программ состоит в гораздо меньшей загрузке процессора
во время работы и в корректной работе с tun и lo в OpenBSD.
  На данный момент вся эта фигня состоит  из  двух  программ:  собственно
cnupm - сборщика статистики трафика  и  cnupmstat - программы  распечатки
собранной статистики.


Сборка и установка
------------------
  В данный момент программа оформлена для сборки в BSD системах (OpenBSD,
FreeBSD, NetBSD), Linux (пробовалось в RedHat),  QNX (пробовалось на  QNX
Neutrino 6.2.1) и Solaris (пробовалось на Solaris 7), но в принципе может
быть легко портирована в другие системы, в которых есть поддержка pcap.

Сборка и установка программы очень проста:

# make depend && make && make install

При сборке программы в Solaris и QNX следует использовать GNU make.

  Далее нужно создать группу cnupm, пользователя cnupm с основной группой
cnupm и домашний каталог для него. Во время работы программа cnupm делает
chroot  в  домашний  каталог  данного пользователя и меняет свои права на
него.

NetBSD/OpenBSD/Linux/Solaris:

# groupadd -g 666 cnupm
# useradd -u 666 -g 666 -d /var/cnupm -m -c 'Cnupm traffic collector' \
    -s /sbin/nologin cnupm
# chmod 750 /var/cnupm

FreeBSD:

# pw groupadd cnupm -g 666
# pw useradd cnupm -u 666 -g 666 -d /var/cnupm -m -s /sbin/nologin \
    -c 'Cnupm traffic collector'
# chmod 750 /var/cnupm

Для других систем можно отредактировать  файлы /etc/passwd, /etc/group  и
создать домашний каталог пользователя cnupm вручную. Также в системах где
нет утилиты /sbin/nologin (QNX, Solaris), shell пользователя cnupm  можно
заменить на какую-нибудь нейтральную утилиту (например /bin/false).


Запуск программы
----------------

# cnupm [-deNOpPV] [-a interval] [-f family] [-F file] [-i interface]
        [-u user] [expression]

-a interval	- Сохранять собранную информацию в  файл  через  заданное
		  число минут (от 1 до 525600)
-d		- Не  отцепляться   от  терминала,   дублировать   syslog
		  сообщения программы на stderr
-e		- Делать запись в файле трафика даже если не было собрано
		  никакой статистики
-f family	- Собирать  статистику  только  для  заданного  семейства
		  адресов (inet/inet6)
-F file		- Читать  tcpdump  выражения  из  файла  вместо командной
		  строки
-i inerface	- Собирать  статистику   на   указанном   интерфейсе.  По
		  умолчанию  ищется  первый  попавшийся   в   системе  за
		  исключением loopback
-m maxentries	- Хранить в памяти не более maxentries  записей  трафика.
		  Допустимые значения от 128 до 131072
-N		- Не  собирать  статистику  по  протоколам.  Данная опция
		  также запрещает сбор статистики по TCP/UDP портам
-O		- Не включать оптимизатор пакетного фильтра (нужно только
		  в случае если были обнаружены ошибки в bpf)
-p		- Не включать promiscuous mode на интерфейсе
-P		- Не собирать статистику по TCP/UDP портам
-q		- Не мучать syslog на предмет числа записей, сброшенных в
		  файл (полезно если такой сброс делается часто)
-u user		- Менять права на указанного пользователя и делать chroot
		  на его домашний каталог вместо пользователя cnupm
-V		- Напечатать версию программы и библиотеки libpcap.
expression	- Стандартное  tcpdump-подобное  выражение  для  указания
		  какой именно трафик следует учитывать

# cnupmstat [-BEFnNPV] [-d delim ] [-f family] [-p protocol] [-u user]
            interface [...]

-B		- Не выводить дату и время начала сбора статистики
-d delim	- Использовать символ delim  как  разделитель  полей  (по
		  умолчанию используется символ пробела)
-E		- Не выводить дату и время окончания сбора статистики
-f family	- Выводить  только  статистику  по  указанному  семейству
		  адресов (inet или inet6)
-F		- Указывает  что  аргументы,  перечисленные  в  командной
		  строке  являются   именами   файлов,   а   не   сетевых
		  интерфейсов
-n		- Выводить IP/IPv6 протокол  в  виде  цифрового  значения
		  (см. /etc/protocols)
-N		- Не выводить IP/IPv6 протокол
-p protocol	- Выводить  только  статистику  по  указанному  протоколу
		  (можно указывать в  виде  названия  протокола  или  его
		  цифровом значении (см. /etc/protocols))
-P		- Не выводить номера TCP/UDP портов
-u user		- Использовать домашний каталог  указанного  пользователя
		  для поиска файлов трафика вместо пользователя cnupm
interface	- Интерфейс для  которого  следует  печатать  статистику.
		  Можно указать несколько интерфейсов.

Формат вывода статистики cnupmstat:

<beg_date> <end_date> <src_addr> <dst_addr> <ip_proto> <nbytes>

<beg_date>	- Дата и время начала сбора статистики
<end_date>	- Дата и время окончания сбора статистики  (время  сброса
		  статистики в файл)
<src_addr>	- Адрес источника  (может содержать TCP/UDP порт)
<dst_addr>	- Адрес приемника (может содержать TCP/UDP порт)
<ip_proto>	- IP/IPv6  протокол.
<nbytes>	- Число переданных байт


Формат файла трафика (версия 3)
-------------------------------

Заголовок:

4 байта		версия файла (minor << 8 + major)
4 байта		дата/время начала сбора информации (формат ctime())
4 байта		дата/время окончания сбора информации (формат ctime())
4 байта		число записей трафика, следующих за заголовком

(все поля хранятся в сетевом порядке байт)

Запись трафика:

1 байт		семейство адресов (2 - inet, 24 - inet6)
1 байт		IP протокол (1 - ICMP, 6 - TCP, 17 - UDP)
2 байта		TCP/UDP порт источника (для TCP/UDP протоколов)
2 байта		TCP/UDP порт приемника (для TCP/UDP протоколов)
2 байта		зарезервировано
16 байт		IP/IPv6 адрес  источника.  Для inet используются первые 4
		байта
16 байт		IP/IPv6 адрес  приемника.  Для inet используются первые 4
		байта
8 байт		счетчик байт данных

(все поля хранятся в сетевом порядке байт)

----------------------------- и хере цут --------------------------------

ЦОПЫРИГХТ (Ц) 2003-2004 ОЛЕГ САФИУЛЛИН <ФОРМЮПДП-11.ОРГ.РУ>
АЛЛ РИГХТС РЕСЕРЖЕД.

РЕДИСТРИБУТИОН  АНД  УСЕ  ИН  СОУРЦЕ  АНД  БИНАРЫ  ФОРМС,  ВИТХ ОР ВИТХОУТ
МОДИФИЦАТИОН,  АРЕ  ПЕРМИТТЕД  ПРОЖИДЕД  ТХАТ  ТХЕ  ФОЛЛОВИНГ   ЦОНДИТИОНС
АРЕ МЕТ:
1. РЕДИСТРИБУТИОНС  ОФ  СОУРЦЕ ЦОДЕ МУСТ РЕТАИН ТХЕ АБОЖЕ ЦОПЫРИГХТ НОТИЦЕ
   УНМОДИФИЕД, ТХИС ЛИСТ ОФ ЦОНДИТИОНС, АНД ТХЕ ФОЛЛОВИНГ ДИСЦЛАИМЕР.
2. РЕДИСТРИБУТИОНС  ИН  БИНАРЫ  ФОРМ  МУСТ  РЕПРОДУЦЕ  ТХЕ АБОЖЕ ЦОПЫРИГХТ
   НОТИЦЕ,  ТХИС  ЛИСТ  ОФ  ЦОНДИТИОНС АНД ТХЕ ФОЛЛОВИНГ ДИСЦЛАИМЕР ИН ТХЕ
   ДОЦУМЕНТАТИОН АНД/ОР ОТХЕР МАТЕРИАЛС ПРОЖИДЕД ВИТХ ТХЕ ДИСТРИБУТИОН.

ТХИС СОФТВАРЕ ИС ПРОЖИДЕД БЫ ТХЕ АУТХОР АНД ЦОНТРИБУТОРС ``АС ИС'' АНД АНЫ
ЕЬПРЕСС  ОР ИМПЛИЕД ВАРРАНТИЕС, ИНЦЛУДИНГ, БУТ НОТ ЛИМИТЕД ТО, ТХЕ ИМПЛИЕД
ВАРРАНТИЕС  ОФ  МЕРЦХАНТАБИЛИТЫ  АНД  ФИТНЕСС ФОР А ПАРТИЦУЛАР ПУРПОСЕ АРЕ
ДИСЦЛАИМЕД. ИН НО ЕЖЕНТ СХАЛЛ ТХЕ АУТХОР ОР ЦОНТРИБУТОРС БЕ ЛИАБЛЕ ФОР АНЫ
ДИРЕЦТ, ИНДИРЕЦТ, ИНЦИДЕНТАЛ, СПЕЦИАЛ, ЕЬЕМПЛАРЫ, ОР ЦОНСЕЯУЕНТИАЛ ДАМАГЕС
(ИНЦЛУДИНГ,  БУТ  НОТ  ЛИМИТЕД  ТО,  ПРОЦУРЕМЕНТ  ОФ  СУБСТИТУТЕ  ГООДС ОР
СЕРЖИЦЕС; ЛОСС ОФ УСЕ, ДАТА, ОР ПРОФИТС; ОР БУСИНЕСС ИНТЕРРУПТИОН) ХОВЕЖЕР
ЦАУСЕД  АНД  ОН  АНЫ  ТХЕОРЫ  ОФ  ЛИАБИЛИТЫ,  ВХЕТХЕР  ИН ЦОНТРАЦТ, СТРИЦТ
ЛИАБИЛИТЫ,  ОР ТОРТ (ИНЦЛУДИНГ НЕГЛИГЕНЦЕ ОР ОТХЕРВИСЕ) АРИСИНГ ИН АНЫ ВАЫ
ОУТ  ОФ  ТХЕ  УСЕ  ОФ ТХИС СОФТВАРЕ, ЕЖЕН ИФ АДЖИСЕД ОФ ТХЕ ПОССИБИЛИТЫ ОФ
СУЦХ ДАМАГЕ.
