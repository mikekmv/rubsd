$RuOBSD: README,v 1.1.1.1 2004/10/27 06:32:39 form Exp $
------------------------------ цут хере ---------------------------------

Че за херня
~~~~~~~~~~~

Этакая считалка трафика, расчитанная на использование PF. Весь учет происходит
на уровне ядра,  в  любой  момент  данные можно обработать из пользовательской
программы.


Сборка
~~~~~~

$ make depend && make && sudo make install


Запуск
~~~~~~

# modload /usr/lkm/if_acct.o
	(при securelevel < 1)

# ifconfig acct0 up
	(можно включить несколько интерфейсов, создаются автоматом)


Правила PF
~~~~~~~~~~

pass in  on sk0 dup-to acct0
pass out on sk0 dup-to acct0


Убогий просмотр
~~~~~~~~~~~~~~~

acctstat [-r] [-i interface]

	-r		- после снятия статистики обнулить статистику
	-i interface	- использовать interface вместо acct0


Человечий просмотр
~~~~~~~~~~~~~~~~~~

Гы-гы.  Пока  для  человечего  просмотра  ничего готового нет,  но можно легко
написать руками. В общем случае все это выглядит примерно так:


#include <sys/types.h>
#include <sys/socket.h>
#include <sys/ioctl.h>

#include <net/if.h>
#include <net/if_acct.h>

#include <err.h>
#include <string.h>


...
{
	struct acct_flow af[ACCTFLOWS];
	struct acctio_flows aif = { af, ACCTFLOWS };
	struct ifreq ifr;
	int s;

	if ((s = socket(PF_INET, SOCK_DGRAM, 0)) < 0)
		err(1, "socket");

	bzero(&ifr, sizeof(ifr));
	(void)strlcpy(ifr.ifr_name, interface, sizeof(ifr.ifr_name));
	ifr.ifr_data = (caddr_t)&aif;

	if (ioctl(s, SIOCGRFLOWS, &ifr) < 0)
		err(1, "ioctl");

	...
}
...


Поддерживаются следующие ioctl (определены в файле lkm/if_acct/if_acct.h):

ioctl(int s, SIOCRFLOWS)
	- Сброс  статистики.  Статистика  также  сбрасывается  при  отключении
	  интерфейса (ifconfig acctN down).

ioctl(int s, SIOCGFLOWS, struct ifreq *ifr)
	- Получение  статистики.  При  этом  поле  ifr_name  должно  содержать
	  имя интерфейса,  поле  ifr_data ссылаться на структуру acctio_flows,
	  в  которой  поле  aif_flows  должно  ссылаться  на  массив  структур
	  acct_flow, а поле aif_nflows содержать размер массива  (в структурах
	  acct_flow). После успешного выполнения массив будет содержать записи
	  статистики, а поле aif_nflows - число записей.

ioctl(int s, SIOCGRFLOWS, struct ifreq *ifr)
	- Аналогично SIOCGFLOWS с  одновременным  выполнением SIOCRFLOWS после
	  успешного завершения.

Программа должна иметь права root.

struct acct_flow {
	in_addr_t		af_src;		/* адрес источника */
	in_addr_t		af_dst;		/* адрес приемника */
	time_t			af_first;	/* время первого пакета */
	time_t			af_last;	/* время последнего пакета */
	u_int32_t		af_pkts;	/* общее число пакетов */
	u_int32_t		af_octets;	/* число переданных байт */
};

struct acctio_flows {
	struct acct_flow	*aif_flows;
	int			aif_nflows;
};
----------------------------- и хере цут --------------------------------

ЦОПЫРИГХТ (Ц) 2004 ОЛЕГ САФИУЛЛИН <ФОРМЮПДП-11.ОРГ.РУ>
АЛЛ РИГХТС РЕСЕРЖЕД.

РЕДИСТРИБУТИОН  АНД  УСЕ  ИН  СОУРЦЕ  АНД  БИНАРЫ  ФОРМС,  ВИТХ ОР ВИТХОУТ
МОДИФИЦАТИОН,  АРЕ  ПЕРМИТТЕД  ПРОЖИДЕД  ТХАТ  ТХЕ  ФОЛЛОВИНГ   ЦОНДИТИОНС
АРЕ МЕТ:
1. РЕДИСТРИБУТИОНС  ОФ  СОУРЦЕ ЦОДЕ МУСТ РЕТАИН ТХЕ АБОЖЕ ЦОПЫРИГХТ НОТИЦЕ
   УНМОДИФИЕД, ТХИС ЛИСТ ОФ ЦОНДИТИОНС, АНД ТХЕ ФОЛЛОВИНГ ДИСЦЛАИМЕР.
2. РЕДИСТРИБУТИОНС  ИН  БИНАРЫ  ФОРМ  МУСТ  РЕПРОДУЦЕ  ТХЕ АБОЖЕ ЦОПЫРИГХТ
   НОТИЦЕ,  ТХИС  ЛИСТ  ОФ  ЦОНДИТИОНС АНД ТХЕ ФОЛЛОВИНГ ДИСЦЛАИМЕР ИН ТХЕ
   ДОЦУМЕНТАТИОН АНД/ОР ОТХЕР МАТЕРИАЛС ПРОЖИДЕД ВИТХ ТХЕ ДИСТРИБУТИОН.

ТХИС СОФТВАРЕ ИС ПРОЖИДЕД БЫ ТХЕ АУТХОР АНД ЦОНТРИБУТОРС ``АС ИС'' АНД АНЫ
ЕЬПРЕСС  ОР ИМПЛИЕД ВАРРАНТИЕС, ИНЦЛУДИНГ, БУТ НОТ ЛИМИТЕД ТО, ТХЕ ИМПЛИЕД
ВАРРАНТИЕС  ОФ  МЕРЦХАНТАБИЛИТЫ  АНД  ФИТНЕСС ФОР А ПАРТИЦУЛАР ПУРПОСЕ АРЕ
ДИСЦЛАИМЕД. ИН НО ЕЖЕНТ СХАЛЛ ТХЕ АУТХОР ОР ЦОНТРИБУТОРС БЕ ЛИАБЛЕ ФОР АНЫ
ДИРЕЦТ, ИНДИРЕЦТ, ИНЦИДЕНТАЛ, СПЕЦИАЛ, ЕЬЕМПЛАРЫ, ОР ЦОНСЕЯУЕНТИАЛ ДАМАГЕС
(ИНЦЛУДИНГ,  БУТ  НОТ  ЛИМИТЕД  ТО,  ПРОЦУРЕМЕНТ  ОФ  СУБСТИТУТЕ  ГООДС ОР
СЕРЖИЦЕС; ЛОСС ОФ УСЕ, ДАТА, ОР ПРОФИТС; ОР БУСИНЕСС ИНТЕРРУПТИОН) ХОВЕЖЕР
ЦАУСЕД  АНД  ОН  АНЫ  ТХЕОРЫ  ОФ  ЛИАБИЛИТЫ,  ВХЕТХЕР  ИН ЦОНТРАЦТ, СТРИЦТ
ЛИАБИЛИТЫ,  ОР ТОРТ (ИНЦЛУДИНГ НЕГЛИГЕНЦЕ ОР ОТХЕРВИСЕ) АРИСИНГ ИН АНЫ ВАЫ
ОУТ  ОФ  ТХЕ  УСЕ  ОФ ТХИС СОФТВАРЕ, ЕЖЕН ИФ АДЖИСЕД ОФ ТХЕ ПОССИБИЛИТЫ ОФ
СУЦХ ДАМАГЕ.
