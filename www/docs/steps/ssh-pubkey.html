<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=koi8-r">
<meta http-equiv="Content-Language" content="ru">
<meta name="copyright" content="Copyright (c) 2000-2005 by OpenBSD.ru">   
<title>OpenSSH: Использование аутентификации на базе публичного ключа</title>
</head>

<body bgcolor="#ffffff" text="#000000" link="#23238e">

<h2><font color="#e00000">OpenSSH: Использование аутентификации на базе публичного ключа</font></h2>
<hr>

<h3><font color="#0000e0">Мини-руководство "шаг за шагом"</font></h3>

<p>
<table border=0>
<tr><td nowrap bgcolor="#EEEEEE">
<blockquote>
<p>
Генерируем пару ключей (секретный и публичный):

<pre>
% <strong>ssh-keygen -t rsa</strong>
Generating public/private rsa key pair.
Enter file in which to save the key (/home/andrushock/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/andrushock/.ssh/id_rsa.
Your public key has been saved in /home/andrushock/.ssh/id_rsa.pub.
The key fingerprint is:
25:95:5b:a6:d7:26:b6:f5:f9:a7:49:d4:a8:2a:0d:7d andrushock@midian
</pre>

<p>
Проверяем корректность прав доступа к директории
<font color="#008000">.ssh</font> и RSA-ключам:

<pre>
% <strong>ls -la .ssh | egrep -v 'total|\.\.'</strong>
drwx------   2 andrushock  wsrc   512 Oct 19 20:42 ./
-rw-------   1 andrushock  wsrc  1743 Jun 11 03:35 id_rsa
-rw-r--r--   1 andrushock  wsrc   413 Jun 11 03:35 id_rsa.pub
</pre>

<p>
В случае, если файл <font color="#008000">.ssh/authorized_keys</font>
на удаленной системе не существует:

<pre>
% <strong>cat .ssh/id_rsa.pub | ssh remotehost "(mkdir -m 700 .ssh; cat > .ssh/authorized_keys)"</strong>
</pre>

<p>
Иначе:

<pre>
% <strong>cat .ssh/id_rsa.pub | ssh remotehost "cat >> .ssh/authorized_keys"</strong>
</pre>

<p>
Для сохранения парольных фраз к приватным ключам запускаем
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-agent&sektion=1">
ssh-agent(1)</a>:

<pre>
% <strong>eval `/usr/bin/ssh-agent`</strong>
Agent pid 3855
</pre>

<p>
С помощью
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-add&sektion=1">
ssh-add(1)</a> добавляем в память агента парольную фразу от нашего ключа:

<pre>
% <strong>ssh-add</strong>
Enter passphrase for /home/andrushock/.ssh/id_rsa:
Identity added: /home/andrushock/.ssh/id_rsa (/home/andrushock/.ssh/id_rsa)
</pre>

<p>
Для проверки просматриваем отпечаток секретного ключа:

<pre>
% <strong>ssh-add -l</strong>
2048 25:95:5b:a6:d7:26:b6:f5:f9:a7:49:d4:a8:2a:0d:7d /home/andrushock/.ssh/id_rsa (RSA)
</pre>

<p>
Выполняем вход на удаленный сервер без ввода пароля и парольной фразы:

<pre>
% <strong>ssh remotehost</strong>
OpenBSD 3.7-current (GENERIC) #1: Mon Aug  1 00:37:53 MSD 2005

Welcome to OpenBSD: The proactively secure Unix-like operating system.

$
</pre>

<p>
Пример использования функций оболочки для упрощения безпарольной аутентификации:

<pre>
% <strong>vi .profile</strong>
ssh_agent_start() {
	id1=$HOME/.ssh/identity
	id2=$HOME/.ssh/id_dsa
	id3=$HOME/.ssh/id_rsa
	if [ ! "$SSH_AGENT_PID" ] &amp;&amp; [ -f $id1 -o -f $id2 -o -f $id3 ]; then
		eval `/usr/bin/ssh-agent -s`
		/usr/bin/ssh-add &lt; /dev/null
		export SSH_AGENT_SHELL=$$
	fi
}

ssh_agent_stop() {
	if [ "$SSH_AGENT_PID" -a "$SSH_AGENT_SHELL"x = "$$"x ]; then
		/usr/bin/ssh-add -D &lt; /dev/null
		eval `/usr/bin/ssh-agent -sk`
	fi
}

ssh_agent_start
trap ssh_agent_stop 0 1
</pre>
</blockquote>

</td></tr>
</table>

<p>
<hr>
<a href="index.html"><img height=24 width=24 src="../../images/back.gif" border=0 alt="OpenBSD.ru"></a>
<a href="mailto:www@openbsd.ru">www@openbsd.ru</a>
<br>
<small>$RuOBSD: ssh-pubkey.html,v 1.14 2005/10/21 16:11:04 andrey Exp $</small>

</body>
</html>
