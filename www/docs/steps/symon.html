<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
<HEAD>
  <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=koi8-r">
  <META HTTP-EQUIV="Content-Language" CONTENT="ru">
  <META NAME="copyright" CONTENT="Copyright (c) 2009 by OpenBSD.ru">
  <TITLE>Система мониторинга на базе Symon</TITLE>
  <LINK REL="stylesheet" HREF="css/style.css" TYPE="text/css">
</HEAD>

<BODY BGCOLOR="#ffffff" TEXT="#000000" LINK="#23238e">

<H2><FONT COLOR="#e00000">Система мониторинга на базе Symon</FONT></H2>
<HR>

<H3><FONT COLOR="#0000e0">Мини-руководство "шаг за шагом"</FONT></H3>

<P>
<TABLE BORDER="0">
<TR><TD>

<P>
Перед установкой symon убедитесь, что Web-сервер Apache работает не в
chroot-окружении (httpd_flags=&quot;-u&quot; в /etc/rc.conf.local), модуль
mod_php5 подключен, а <a href="ftp://ftp.openbsd.org/pub/OpenBSD/snapshots/i386/xbase46.tgz">xbase46.tgz</a>
установлен (sudo tar zxvpf xbase46.tgz -C /).

<P>
Через переменную окружения PKG_PATH указываем расположение прекомпилированных
пакетов:

<PRE>
% <STRONG>export PKG_PATH=ftp://ftp.openbsd.org/pub/OpenBSD/snapshots/packages/i386</STRONG>
</PRE>

<P>
Устанавливаем пакет symon вместе с зависимостями:

<PRE>
% <STRONG>sudo pkg_add symon</STRONG>
</PRE>

<P>
Копируем примеры конфигурационных файлов в каталог /etc:

<PRE>
% <STRONG>sudo cp /usr/local/share/examples/symon/*.conf /etc</STRONG>
</PRE>

<P>
Редактируем конфигурационный файл системного монитора, в задачу которого входит
сбор и пересылка данных.

<PRE>
% <STRONG>sudo vi /etc/symon.conf</STRONG>
monitor { cpu(0),
	  mem,
	  mbuf,
	  pf,
	  io(wd0), df(wd0e),
	  if(enc0), if(bge0), if(rl0),
	  proc(squid), proc(httpd), proc(sshd)
} stream to 127.0.0.1 2100
</PRE>

<P>
Symux получает потоки symon и сохраняет их в RRD файлы. Конфигурируем:

<PRE>
% <STRONG>sudo vi /etc/symux.conf</STRONG>
# Указываем, на каком порту слушать входящие соединения symon
mux 127.0.0.1 2100
# Определяем входящие данные для каждого источника
source 127.0.0.1 {
# Описываем, какую именно информацию принимаем
# (здесь просто перечисляем источники из symon.conf)
	accept { cpu(0),
		 mem,
		 mbuf,
		 pf,
		 io(wd0), df(wd0e),
		 if(enc0), if(bge0), if(rl0),
		 proc(squid), proc(httpd), proc(sshd)
	}
# Каталог, в который будем сохранять данные
	datadir "/var/www/symon/rrds/localhost"
}
</PRE>

<P>
Создаем каталог для данных:

<PRE>
% <STRONG>sudo mkdir -p /var/www/symon/rrds/localhost</STRONG>
% <STRONG>sudo chown -R root:wheel /var/www/symon</STRONG>
% <STRONG>sudo chmod -R 755 /var/www/symon</STRONG>
% <STRONG>cd /var/www/symon/rrds/localhost</STRONG>
</PRE>

<P>
При необходимости подключаем динамические библиотеки из каталогов
/usr/local/lib и /usr/X11R6/lib:

<PRE>
% <STRONG>sudo ldconfig /usr/local/lib /usr/X11R6/lib</STRONG>
</PRE>

<P>
С помощью скрипта c_smrrds.sh, входящего в поставку symon, создаем необходимые
RRD-файлы:

<PRE>
% <STRONG>sudo /usr/local/share/symon/c_smrrds.sh all</STRONG>
/var/www/symon/rrds/localhost/proc_sshd.rrd created
/var/www/symon/rrds/localhost/proc_httpd.rrd created
/var/www/symon/rrds/localhost/proc_squid.rrd created
/var/www/symon/rrds/localhost/if_rl0.rrd created
/var/www/symon/rrds/localhost/if_bge0.rrd created
/var/www/symon/rrds/localhost/if_enc0.rrd created
/var/www/symon/rrds/localhost/df_wd0e.rrd created
/var/www/symon/rrds/localhost/io_wd0.rrd created
/var/www/symon/rrds/localhost/pf.rrd created
/var/www/symon/rrds/localhost/mbuf.rrd created
/var/www/symon/rrds/localhost/mem.rrd created
/var/www/symon/rrds/localhost/cpu0.rrd created
</PRE>

<P>
Для тестирования запускаем symux и symon в режиме отладки:

<PRE>
% <STRONG>sudo /usr/local/libexec/symux -d</STRONG>
symux version 2.79
program id=32039
debug: size of churnbuffer = 2361
debug: shm from 0x88cde000 to 0x89104ac0
debug: symux packet size=1642
listening for incoming symon traffic on udp 127.0.0.1 2100
listening for incoming connections on tcp 127.0.0.1 2100

% <STRONG>sudo /usr/local/libexec/symon -d</STRONG>
symon version 2.79
program id=25989
debug: symon packet size=821
sending packets to udp 127.0.0.1 2100
started module proc(sshd)
started module proc(httpd)
started module proc(squid)
started module if(rl0)
started module if(bge0)
started module if(enc0)
started module df(wd0e)
started module io(wd0)
started module pf()
started module mbuf()
started module mem()
started module cpu(0)
</PRE>

<P>
При возникновении ошибки &quot;symux: could not get a semaphore&quot;
попробуйте увеличить значения sysctl-переменных kern.seminfo.semmni и
kern.seminfo.semmns:

<PRE>
% <STRONG>sudo sysctl kern.seminfo.semmni=128</STRONG>
kern.seminfo.semmni: 10 -&gt; 128
% <STRONG>sudo sysctl kern.seminfo.semmns=256</STRONG>
kern.seminfo.semmns: 60 -&gt; 256
</PRE>

<P>
Если все в порядке, запускаем symux и symon в нормальном режиме:

<PRE>
% <STRONG>sudo /usr/local/libexec/symux</STRONG>
% <STRONG>sudo /usr/local/libexec/symon</STRONG>
</PRE>

<P>
Чтобы просмотреть собранную информацию, можно воспользоваться скриптом
getsymonitem.pl (в качестве последнего параметра используем информацию из
&laquo;man 8 symux&raquo;, применительно к CPU это: user, nice, system,
interrupt, idle):

<PRE>
% <STRONG>cd /usr/local/share/symon/client</STRONG>
% <STRONG>sudo ./getsymonitem.pl 127.0.0.1 2100 127.0.0.1 'cpu(0)' user</STRONG>
3.10
</PRE>

<P>
Теперь переходим к установке syweb:

<PRE>
% <STRONG>cd ~/devel</STRONG>
% <STRONG>ftp http://www.xs4all.nl/~wpd/symon/philes/syweb-0.58.tar.gz</STRONG>
% <STRONG>tar zxvf syweb-0.58.tar.gz</STRONG>
% <STRONG>cd syweb</STRONG>
% <STRONG>sudo cp -R symon /var/www/symon/layout</STRONG>
% <STRONG>sudo cp -R htdocs/syweb /var/www</STRONG>
% <STRONG>sudo mkdir /var/www/symon/cache</STRONG>
% <STRONG>sudo chown www:www /var/www/symon/cache</STRONG>
</PRE>

<P>
Изменяем параметры setup.inc под нашу конфигурацию:

<PRE>
% <STRONG>sudo vi /var/www/syweb/setup.inc</STRONG>
/* running OpenBSD, apache not chrooted: */
$symon['rrdtool_path']='/usr/local/bin/rrdtool';
$symon['cache_dir']='/var/www/symon/cache';
$symon['host_tree']='/var/www/symon/rrds';
$symon['layout_dir']='/var/www/symon/layout';
</PRE>

<P>
Конфигурируем Apache:

<PRE>
% <STRONG>sudo vi /var/www/conf/httpd.conf</STRONG>
Alias /syweb "/var/www/syweb/"

&lt;Directory &quot;/var/www/syweb&quot;&gt;
	Options None
	AllowOverride None
	DirectoryIndex index.php
	Order allow,deny
	Allow from all

# При желании можно ограничить доступ к этому каталогу
#	AuthType Basic
#	AuthName &quot;syweb zone&quot;
#	AuthUserFile /var/www/conf/.htpasswd
#	AuthGroupFile /dev/null
#	require valid-user

# А также разрешать вход только по протоколу https
#	SSLRequireSSL
#	SSLVerifyClient none
&lt;/Directory&gt;
</PRE>

<P>
В том случае, если требуется авторизация, следует создать пароль при помощи
утилиты htpasswd(1):

<PRE>
% <STRONG>sudo htpasswd -c /var/www/conf/.htpasswd admin</STRONG>
</PRE>

<P>
Выполняем останов и повторный запуск httpd(8):

<PRE>
# <STRONG>apachectl stop</STRONG>
# <STRONG>apachectl start</STRONG>
</PRE>

<P>
Выполняем проверку: http://192.168.1.1/syweb/configtest.php

<P>
Из соображений безопасности configtest.php можно удалить, либо запретить к нему
доступ:

<PRE>
% <STRONG>sudo chmod 000 configtest.php</STRONG>
</PRE>

<P>
Настройка завершена, смотрим на красивые графики: http://192.168.1.1/syweb/

<P>
Прописываем запуск symux и symon в сценарий загрузки:

<PRE>
% <STRONG>sudo vi /etc/rc.local</STRONG>
if [ -x /usr/local/libexec/symux -a -f /etc/symux.conf ]; then
	echo -n ' symux'; /usr/local/libexec/symux
fi

if [ -x /usr/local/libexec/symon -a -f /etc/symon.conf ]; then
	echo -n ' symon'; /usr/local/libexec/symon
fi
</PRE>

<P>
TODO:

<ul>
<li>создание своего layout-файла
<li>работа в Apache chroot
</ul>

<P>
Данное пошаговое руководство основано на статье &quot;<A HREF="http://www.synack.ru/articles/x_03_2009_synack_peredovoy_nabludatelnyi_punkt">Передовой наблюдательный пункт</A>&quot;, опубликованной в мартовском номере журнала &quot;<A HREF="http://www.xakep.ru/"> Хакер</A>&quot;
за 2009 год. Авторы оригинальной статьи: Сергей Яремчук и Андрей Матвеев.

</TD></TR>
</TABLE>

<P>
<HR>
<A HREF="index.html"><IMG HEIGHT="24" WIDTH="24" SRC="../../images/back.gif"
 BORDER="0" ALT="OpenBSD.ru"></A>
<A HREF="mailto:www@openbsd.ru">www@openbsd.ru</A>

<BR>
<SMALL>$RuOBSD: symon.html,v 1.3 2009/07/22 20:35:44 andrey Exp $</SMALL>

</BODY>
</HTML>
