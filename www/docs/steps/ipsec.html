<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=koi8-r">
<meta http-equiv="Content-Language" content="ru">
<meta name="copyright" content="Copyright (c) 2000-2005 by OpenBSD.ru">   
<title>IPsec: Защита передаваемых данных с помощью Isakmpd</title>
<link rel="stylesheet" href="css/style.css" type="text/css">
</head>

<body bgcolor="#ffffff" text="#000000" link="#23238e">

<h2><font color="#e00000">IPsec: Защита передаваемых данных с помощью Isakmpd</font></h2>
<hr>

<h3><font color="#0000e0">Мини-руководство "шаг за шагом"</font></h3>

<p>
<table border=0>
<tr><td>

<blockquote>
<p>
Пример обеспечения безопасности для обмена данными за счет шифрования пакетов
в незащищенной (в данном случае беспроводной) сети. Сервер: OpenBSD/i386,
сетевой интерфейс ral0, IP-адрес 192.168.2.1. Клиент: WinXP SP2 с установленным
TheGreenBow VPN Client, IP-адрес 192.168.2.2.

<p>
Редактируем главный конфигурационный файл isakmpd(8):

<pre>
# <strong>vi /etc/isakmpd/isakmpd.conf</strong>

# Секция общего назначения: количество повторов, продолжительность таймаутов,
# IP-адрес прослушиваемого интерфейса, абсолютный путь к файлу с IPsec-политиками.
#
[General]
Retransmits=		5
Exchange-max-time=	120
Listen-on=		192.168.2.1
Policy-File=		/etc/isakmpd/isakmpd.policy
#Renegotiate-on-HUP=	yes

# Перечисляем фазы соединений.
#
[Phase 1]
Default=		client

[Phase 2]
Passive-Connections=	server-client

# Создаем список IPsec-соединений.
#
[client]
Phase=			1
Local-address=		192.168.2.1
Authentication=		mypassword
Configuration=          Default-main-mode

[server-client]
Phase=			2
ISAKMP-peer=		client
Local-ID=		Net-server
Remote-ID=		Net-client
Configuration=		Default-quick-mode

# Задаем маршруты для инкапсулированных соединений.
#
[Net-server]
ID-type=		IPV4_ADDR_SUBNET
Network=		192.168.2.0
Netmask=		255.255.255.0

[Net-client]
ID-type=		IPV4_ADDR_SUBNET
Network=		192.168.2.0
Netmask=		255.255.255.0

# Указываем представление потоков, специальный тип обмена пакетами,
# и с помощью чего будем криптовать данные.
#
[Default-main-mode]
DOI=			IPSEC
EXCHANGE_TYPE=		ID_PROT
Transforms=		AES-SHA-GRP2,3DES-MD5

# Указываем протокол, шифр и устойчивую к коллизиям хэш-функцию.
#
[Default-quick-mode]
DOI=			IPSEC
EXCHANGE_TYPE=		QUICK_MODE
Suites=			QM-ESP-AES-SHA-PFS-GRP2-SUITE,QM-ESP-3DES-MD5-PFS-SUITE
</pre>

<p>
Теперь необходимо создать isakmpd.policy(5), содержащий политики для всех
IPsec-соединений:

<pre>
# <strong>vi /etc/isakmpd/isakmpd.policy</strong>
KeyNote-Version: 2
Authorizer: "POLICY"
Conditions: app_domain == "IPsec policy" &amp;&amp;
	doi == "ipsec" &amp;&amp;
	ah_present == "no" &amp;&amp;
	esp_present == "yes" &amp;&amp;
	((esp_enc_alg == "aes" &amp;&amp; esp_auth_alg == "hmac-sha") ||
	(esp_enc_alg == "3des" &amp;&amp; esp_auth_alg == "hmac-md5")) &amp;&amp;
	esp_encapsulation == "tunnel" &amp;&amp;
	pfs == "yes" -&gt; "true";
</pre>

<p>
Выставляем корректные права доступа для конфигурацонных файлов:

<pre>
# <strong>chown root:wheel /etc/isakmpd/isakmpd.{conf,policy}</strong>
# <strong>chmod 600 /etc/isakmpd/isakmpd.{conf,policy}</strong>
</pre>

<p>
Загружем демон, предварительно отказавшись от использования протокола IPv6
и реализации NAT-Traversal:

<pre>
# <strong>/sbin/isakmpd -4T</strong>
</pre>

<p>
Модифицируем правила файервола:

<pre>
# <strong>vi /etc/pf.conf</strong>
enc_if = "enc0"
int_if = "ral0"

vpn_client = "192.168.2.2/32"

pass in log quick on $int_if inet proto udp from $int_if:network \
	to $int_if port isakmp keep state

pass in on $int_if inet proto esp from $vpn_client to $int_if
pass out on $int_if inet proto esp from $int_if to $vpn_client

pass in on $enc_if inet proto ipencap all

pass in on $enc_if inet from $vpn_client to $int_if:network
pass out on $enc_if inet from $int_if:network to $vpn_client
</pre>

<p>
Даем указание pfctl(8) перечитать набор рулесетов:

<pre>
# <strong>pfctl -f /etc/pf.conf</strong>
</pre>

<p>
Таблицу маршрутизации для инкапсулированных соединений можно получить с
помощью netstat(1):

<pre>
% <strong>netstat -nr -f encap</strong>
Routing tables

Encap:
Source             Port  Destination        Port  Proto SA(Address/Proto/Type/Direction)
192.168.2.2/32     0     192.168.2.1/32     0     0     192.168.2.2/50/use/in
192.168.2.1/32     0     192.168.2.2/32     0     0     192.168.2.2/50/require/out
</pre>

<p>
Чтобы удалить все IPsec-потоки:

<pre>
# <strong>ipsecadm flush</strong>
</pre>

<p>
Посмотреть прохождение зашифрованных пакетов можно вот таким образом:

<pre>
# <strong>tcpdump -n -e -ttt -vv -i enc0</strong>
</pre>

</blockquote>

</td></tr>
</table>

<p>
<hr>
<a href="index.html"><img height=24 width=24 src="../../images/back.gif" border=0 alt="OpenBSD.ru"></a>
<a href="mailto:www@openbsd.ru">www@openbsd.ru</a>
<br>
<small>$RuOBSD: ipsec.html,v 1.2 2005/11/28 21:33:52 andrey Exp $</small>

</body>
</html>
