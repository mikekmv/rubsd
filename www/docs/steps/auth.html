<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=koi8-r">
<meta http-equiv="Content-Language" content="ru">
<meta name="copyright" content="Copyright (c) 2005 by OpenBSD.ru">
<title>Sendmail: Поддержка базового механизма аутентификации SASL</title>
<link rel="stylesheet" href="css/style.css" type="text/css">
</head>

<body bgcolor="#ffffff" text="#000000" link="#23238e">

<h2><font color="#e00000">Sendmail: Поддержка базового механизма аутентификации SASL</font></h2>
<hr>

<h3><font color="#0000e0">Мини-руководство "шаг за шагом"</font></h3>

<p>
<table border=0>
<tr><td>

<p>
Устанавливаем <tt>cyrus-sasl2</tt> из портов:

<pre>
# <strong>cd /usr/ports/security/cyrus-sasl2</strong>
# <strong>make install clean</strong>
</pre>

<p>
Для проведения безопасной аутентификации (CRAM/DIGEST-MD5) предпочтительно использовать Berkeley DB:

<pre>
# <strong>cd /usr/ports/databases/db/v4</strong>
# <strong>env FLAVOR=no_tcl make install clean</strong>
# <strong>cd /usr/ports/security/cyrus-sasl2</strong>
# <strong>env FLAVOR=db4 make install clean CLEANDEPENDS=Yes</strong>
</pre>

<p>
Библиотеку <tt>cyrus-sasl2</tt> также можно установить с помощью прекомпилированного
пакета:

<pre>
# <strong>pkg_add ftp://ftp.openbsd.org/pub/OpenBSD/3.8/packages/i386/cyrus-sasl-2.1.20p4.tgz</strong>
</pre>

<p>
В случае с Berkeley DB:

<pre>
# <strong>pkg_add ftp://ftp.openbsd.org/pub/OpenBSD/3.8/packages/i386/cyrus-sasl-2.1.20p4-db4.tgz</strong>
</pre>

<p>
Включаем поддержку SASL в
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sendmail&amp;sektion=8">
sendmail(8)</a>:

<pre>
# <strong>echo WANT_SMTPAUTH=yes &gt;&gt; /etc/mk.conf</strong>
# <strong>cd /usr/src/gnu/usr.sbin/sendmail</strong>
# <strong>make cleandir</strong>
# <strong>make obj</strong>
# <strong>make depend</strong>
# <strong>make</strong>
# <strong>make install</strong>
</pre>

<p>
Переходим в каталог с примерами конфигурационных mc-файлов:

<pre>
# <strong>cd /usr/share/sendmail/cf</strong>
</pre>

<p>
Перечисляем опции и возможные механизмы аутентификации:

<pre>
# <strong>vi server.mc</strong>

# Указываем опции аутентификации.
#
dnl define(`confAUTH_OPTIONS', `A p y')dnl

# В данном случае пароли по сети будут передаваться в открытом виде.
# Рекомендуется использовать совместно с STARTTLS и опцией `p'.
#
define(`confAUTH_MECHANISMS', `PLAIN LOGIN')dnl
TRUST_AUTH_MECH(`PLAIN LOGIN')dnl

# Альтернативный вариант с поддержкой безопасных механизмов аутентификации
# (внимание: пароли в /etc/sasldb2 хранятся в открытом виде).
#
define(`confAUTH_MECHANISMS', `DIGEST-MD5 CRAM-MD5 PLAIN LOGIN')dnl
TRUST_AUTH_MECH(`DIGEST-MD5 CRAM-MD5 PLAIN LOGIN')dnl

# При необходимости изменяем почтовые заголовки.
#
dnl define(`confRECEIVED_HEADER', `$?sfrom $g
	$.$?{auth_type}(authenticated with ${auth_type})
	$.by $j (Server)$?r with $r$.$?{daemon_family}/${daemon_family}$. id $i$?{tls_version}
	(using ${tls_version} with cipher ${cipher} (${cipher_bits} bits) verified ${verify})$.$?u
	for $u; $.$b$?g')dnl
</pre>

<p>
Пересобираем mc-файл, предварительно сделав копию исходного
<font color="#008000">/etc/mail/sendmail.cf</font>:

<pre>
# <strong>cp /etc/mail/sendmail.cf /etc/mail/sendmail.cf.bak</strong>
# <strong>m4 ../m4/cf.m4 server.mc > /etc/mail/sendmail.cf</strong>
</pre>

<p>
Создаем файл конфигурации SASL:

<pre>
# <strong>echo 'pwcheck_method: saslauthd' &gt; /usr/local/lib/sasl2/Sendmail.conf</strong>
</pre>

<p>
Для демона аутентификации создаем необходимую директорию:

<pre>
# <strong>mkdir -p /var/sasl2</strong>
</pre>

<p>
Запускаем <tt>saslauthd</tt>:

<pre>
# <strong>/usr/local/sbin/saslauthd -a getpwent -n 0 -O /usr/local/lib/sasl2/Sendmail.conf</strong>
</pre>

<p>
Запускаем <tt>sendmail</tt>:

<pre>
# <strong>/usr/sbin/sendmail -L sm-mta -bd -q30m</strong>
</pre>

<p>
Либо заставляем демона перечитать свой cf-конфиг:

<pre>
# <strong>kill -HUP `head -1 /var/run/sendmail.pid`</strong>
</pre>

<p>
Для проверки подключаемся к MTA с помощью
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=telnet&amp;sektion=1">
telnet(1)</a>:

<pre>
% <strong>telnet localhost 25</strong>
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
220 mail.domain.ru ESMTP mail server ready at Sun, 16 Oct 2005 01:21:41 +0400 (MSD)
<b>ehlo mail.domain.ru</b>
250-mail.domain.ru Hello localhost.domain.ru [127.0.0.1], pleased to meet you
250-ENHANCEDSTATUSCODES
250-PIPELINING
250-8BITMIME
250-SIZE 20971520
250-DSN
250-ETRN
<b>250-AUTH DIGEST-MD5 CRAM-MD5 PLAIN LOGIN</b>
250-STARTTLS
250-DELIVERBY
250 HELP
</pre>

<p>
Чтобы пользователь andrushock мог проводить безопасную аутентификацию, выполняем:

<pre>
# <strong>saslpasswd2 -c -u domain.ru andrushock</strong>
</pre>

<p>
Посмотреть список пользователей можно с помощью команды:

<pre>
# <strong>sasldblistusers2</strong>
andrushock@domain.ru: userPassword
andrushock@domain.ru: cmusaslsecretOTP
</pre>

<p>
Пример запуска <tt>saslauthd</tt> из стартового rc-скрипта:

<pre>
# <strong>vi /etc/rc.local</strong>
if [ -x /usr/local/sbin/saslauthd ]; then
	echo -n ' saslauthd'; /usr/local/sbin/saslauthd -a getpwent \
	    -n 0 -O /usr/local/lib/sasl2/Sendmail.conf
fi
</pre>

<p>
<br>
<font color="#008000"><b>Примечание</b></font>. В случае, когда <tt>sendmail</tt>
выступает в роли клиента, демон <tt>saslauthd</tt> и поддержка Berkeley DB не
требуются. В mc-файл вносим необходимые изменения:

<pre>
# <strong>vi server.mc</strong>
define(`SMART_HOST', `smtp: smtp.domain.ru')dnl
define(`confAUTH_MECHANISMS', `DIGEST-MD5 CRAM-MD5 PLAIN LOGIN')dnl
FEATURE(`authinfo', `hash /etc/mail/authinfo')dnl
</pre>

<p>
Пересобираем mc-файл, предварительно сделав копию исходного
<font color="#008000">/etc/mail/sendmail.cf</font>:

<pre>
# <strong>cp /etc/mail/sendmail.cf /etc/mail/sendmail.cf.bak</strong>
# <strong>m4 ../m4/cf.m4 server.mc > /etc/mail/sendmail.cf</strong>
</pre>

<p>
Указываем SMTP-сервер, имя и пароль пользователя, а также метод аутентификации:

<pre>
# <strong>vi /etc/mail/authinfo</strong>
AuthInfo:smtp.domain.ru "U:username@domain.ru" "P:noidea" "M:CRAM-MD5"
</pre>

<p>
Создаем хэшированную базу данных <font color="#008000">/etc/mail/authinfo</font>:

<pre>
# <strong>makemap hash /etc/mail/authinfo &lt; /etc/mail/authinfo</strong>
</pre>

<p>
И даем указание демону перечитать свой конфиг:

<pre>
# <strong>kill -HUP `head -1 /var/run/sendmail.pid`</strong>
</pre>

</td></tr>
</table>

<p>
<hr>
<a href="index.html"><img height=24 width=24 src="../../images/back.gif" border=0 alt="OpenBSD.ru"></a>
<a href="mailto:www@openbsd.ru">www@openbsd.ru</a>
<br>
<small>$RuOBSD: auth.html,v 1.15 2007/10/04 18:26:34 form Exp $</small>

</body>
</html>
