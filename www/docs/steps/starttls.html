<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=koi8-r">
<meta http-equiv="Content-Language" content="ru">
<meta name="copyright" content="Copyright (c) 2000-2005 by OpenBSD.ru">   
<title>Sendmail: Обеспечение безопасности сообщений за счет использования STARTTLS</title>
<link rel="stylesheet" href="css/style.css" type="text/css">
</head>

<body bgcolor="#ffffff" text="#000000" link="#23238e">

<h2><font color="#e00000">Sendmail: Безопасность сообщений за счет использования STARTTLS</font></h2>
<hr>

<h3><font color="#0000e0">Мини-руководство "шаг за шагом"</font></h3>

<p>
<table border=0>
<tr><td>

<blockquote>
<p>
Создаем специальную директорию:

<pre>
# <strong>mkdir -p /etc/mail/certs</strong>
# <strong>cd /etc/mail/certs</strong>
</pre>

<p>
Генерируем секретный DSA-ключ и почтовый сертификат:

<pre>
# <strong>openssl dsaparam 1024 -out dsa1024.pem</strong>
# <strong>openssl req -x509 -nodes -days 365 -newkey dsa:dsa1024.pem -out mycert.pem -keyout mykey.pem</strong>
Country Name (2 letter code) []:<b>RU</b>
State or Province Name (full name) []:<b>Russia</b>
Locality Name (eg, city) []:<b>Moscow</b>
Organization Name (eg, company) []:<b>MyORG</b>
Organizational Unit Name (eg, section) []:<b>IT</b>
Common Name (eg, fully qualified host name) []:<b>mail.domain.ru</b>
Email Address []:<b>postmaster@domain.ru</b>
</pre>

<p>
Удаляем временный файл:

<pre>
# <strong>rm dsa1024.pem</strong>
</pre>

<p>
Выставляем корректные права доступа к директории и файлам:

<pre>
# <strong>chmod -R go-rwx /etc/mail/certs</strong>
</pre>

<p>
Переходим в каталог с примерами конфигурационных mc-файлов:

<pre>
# <strong>cd /usr/share/sendmail/cf</strong>
</pre>

<p>
Указываем абсолютные пути к сертификату и приватному ключу:

<pre>
# <strong>vi server.mc</strong>
define(`CERT_DIR', `MAIL_SETTINGS_DIR`'certs')dnl
define(`confCACERT_PATH', `CERT_DIR')dnl
define(`confCACERT', `CERT_DIR/mycert.pem')dnl
define(`confSERVER_CERT', `CERT_DIR/mycert.pem')dnl
define(`confSERVER_KEY', `CERT_DIR/mykey.pem')dnl
define(`confCLIENT_CERT', `CERT_DIR/mycert.pem')dnl
define(`confCLIENT_KEY', `CERT_DIR/mykey.pem')dnl
</pre>

<p>
При необходимости вот таким образом можно изменять почтовые заголовки:

<pre>
define(`confRECEIVED_HEADER', `$?sfrom $g
	$.$?{auth_type}(authenticated with ${auth_type})
	$.by $j (Server)$?r with $r$.$?{daemon_family}/${daemon_family}$. id $i$?{tls_version}
	(using ${tls_version} with cipher ${cipher} (${cipher_bits} bits) verified ${verify})$.$?u
	for $u; $.$b$?g')dnl
</pre>

<p>
Пересобираем mc-файл, предварительно сделав копию исходного
<font color="#008000">sendmail.cf</font>:

<pre>
# <strong>cp /etc/mail/sendmail.cf /etc/mail/sendmail.cf.bak</strong>
# <strong>m4 ../m4/cf.m4 server.mc > /etc/mail/sendmail.cf</strong>
</pre>

<p>
Запускаем
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sendmail&sektion=8">
sendmail(8)</a>:

<pre>
# <strong>/usr/sbin/sendmail -L sm-mta -bd -q30m</strong>
</pre>

<p>
Либо заставляем демона перечитать свой cf-конфиг:

<pre>
# <strong>kill -HUP `head -1 /var/run/sendmail.pid`</strong>
</pre>

<p>
Для проверки подключаемся к MTA с помощью
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=telnet&sektion=1">
telnet(1)</a>:

<pre>
% <strong>telnet localhost 25</strong>
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
220 mail.domain.ru ESMTP mail server ready at Sun, 16 Oct 2005 01:21:41 +0400 (MSD)
<b>ehlo mail.domain.ru</b>
250-mail.domain.ru Hello localhost.domain.ru [127.0.0.1], pleased to meet you
250-ENHANCEDSTATUSCODES
250-PIPELINING
250-8BITMIME
250-SIZE 20971520
250-DSN
250-ETRN
<b>250-STARTTLS</b>
250-DELIVERBY
250 HELP
</pre>
</blockquote>

</td></tr>
</table>

<p>
<hr>
<a href="index.html"><img height=24 width=24 src="../../images/back.gif" border=0 alt="OpenBSD.ru"></a>
<a href="mailto:www@openbsd.ru">www@openbsd.ru</a>
<br>
<small>$RuOBSD: starttls.html,v 1.6 2005/11/20 19:11:18 andrey Exp $</small>

</body>
</html>
