<!--#set var="DOC_TITLE" value="RSA/DSA протоколы в OpenSSH" -->
<!--#set var="DOC_ROOT" value="../" -->
<!--#include virtual="../header.html" -->

<p>OpenSSH замена стандартных уязвимых протоколов, таких как telnet или rsh.
OpenSSH использует шифрованный канал для передачи данных. В нем могут быть
использованы протоколы аутентификации RSA или DSA.
</p>

<p>Эти протоколы основаны на базе специально созданной паре ключей, а именно
публичном и приватном ключей. RSA/DSA симмитречные алгоритмы шифрования, то
есть мы можем зашифровать информацию одним ключом, а расшифровать только
другим, в отличие например DES где используется один и тот же ключ для
шифрования и расшифровки информации.
</p>

<p>Для работоспособности этих протоколов нам необходима их начальная настройка.
Во-первых, нам необходимо сгенерировать пару ключей:
<p>

<ul>
<table border=0 width=600>
	<tr><td nowrap bgcolor="#EEEEEE">
	<pre><strong>
% ssh-keygen
Generating public/private rsa1 key pair.
Enter file in which to save the key (~/.ssh/identity): 
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in ~/.ssh/identity.
Your public key has been saved in ~/.ssh/identity.pub.
The key fingerprint is:
a4:e7:f2:39:a7:eb:fd:f8:39:f1:f1:7b:fe:48:a1:09 user@localhost
	</strong></pre>
	</td></tr>
</table>
</ul>

<p>По умолчанию генерируется RSA ключи для протокола SSH версии 1. Мы можем
задать тип генерируемых ключей используя параметр <code>-t dsa</code> и
<code>-t rsa</code> для DSA/RSA протокола SSH версии 2 или <code>-t rsa1</code>
для RSA протокола SSH версии 1, который генерируется по умолчанию.
</p>

<ul>
<table border=0 width=600>
	<tr><td nowrap bgcolor="#EEEEEE">
	<pre><strong>
% ssh-keygen -t dsa
Generating public/private dsa key pair.
Enter file in which to save the key (~/.ssh/id_dsa):
[...]
	</strong></pre>
	</td></tr>
</table>
</ul>

<p>Указываем место куда сохранить ключи, далее нас спросят пароль, вы можете
использовать безпарольную аутентификацию для этого пароль вводить не надо, или
же по паролю, то есть ваш приватный ключ будет зашифрован парольной фразой,
и чтобы воспользоваться им вам необходимо будет ввести этот пароль. (Это не
тот пароль который записан в /etc/master.password или /etc/shadow)
</p>

<p>Использование безпарольной аутентификации повышает риск того, что если кто-то
получит доступ к вашему приватному ключу, он беспрепятственно сможет проникнуть
на удаленную машину для которой этот ключ используется.
</p>

<p>Публичный ключ не так важен, мы можем пересылать его по email или по ftp.
</p>

<p>Ниже приведен способ аутентификации с использованием
<a href="#agent">ssh-agent</a>, при котором приватный ключ может быть
зашифрован, но не будет требовать ввода пароля каждый раз при соединении с
удаленной машиной, за вас это будет делать другая запущенная программа.
</p>

<h3>Безпарольная аутентификация</h3>

<p>После успешной генерации ключей, нам необходимо установить наш публичный
ключ на удаленную машину в ~/.ssh/authorized_keys . После этого сервер
sshd сможет найти его там. (Для протокола SSH версии 2, раньше необходимо было
помещать RSA или DSA публичные ключи в ~/.ssh/authorized_keys2 . Но сейчас
этого можно не делать.) Публичный ключ имеет суффикс .pub на конце.
</p>

<ul>
<table border=0 width=600>
	<tr><td nowrap bgcolor="#EEEEEE">
	<pre><strong>
% scp identity.pub remote.server:~/.ssh/authorized_keys
user@remote.server password:
identity.pub         100% |**********************|   331  00:00
	</strong></pre>
	</td></tr>
</table>
</ul>

<p>Теперь нам надо разрешить использовать RSA/DSA аутентификацию на удаленной
машине и на машине клиента для этого в конфигурационном файле сервера и
клиента должна быть разрешена следующая строчка (по умолчанию разрешена
в файле конфигурации сервера sshd):
</p>

<ul>
<pre><strong>
RSAAuthentication yes
</strong></pre>
</ul>

<p>Пример файла конфигурации клиента, файл ~/.ssh/config</p>

<ul>
<pre><strong>
Host remote.server
Port 22
User user
Protocol 1,2
EscapeChar ~
Compression no
IdentityFile ~/.ssh/identity
RSAAuthentication yes
</strong></pre>
</ul>

<p>Пробуем присоединится к удаленной машине не вводя пароль:
</p>

<ul>
<table border=0 width=600>
	<tr><td nowrap bgcolor="#EEEEEE">
	<pre><strong>
% ssh remote.server
OpenBSD 2.9-stable (GENERIC) #256 Wed Sep 12 00:01:19 UTC 2001

No mail.
%
	</strong></pre>
	</td></tr>
</table>
</ul>

<a name="agent"><h3>Парольная аутентификация с использованием ssh-agent</h3></a>

<p>ssh-agent специальная программа-демон, разработанная для протоколов аутентификации
RSA/DSA, используется для хранения парольной фразы приватного ключа. Используя
эту программу вы можете присоединится к удаленной машине не набирая пароль и при
этом ваши приватные ключи остаются защищенными. В ssh встроена поддержка ssh-agent,
которая позволяет этим программам взаимодействовать между собой.</p>

<p>Ключи и их пароли добавляются в ssh-agent только 1 раз, используя ssh-add, и далее
ssh будет общаться с ssh-agent для определения пароля к данному приватному ключу.</p>

<p>При запуске, ssh-agent становится демоном и в зависимости от вашего shell,
выводит команды для установки нескольких переменных окружения (это НЕПРАВИЛЬНЫЙ
запуск ssh-agent, мы используем его для демонстрационных целей):</p>

<ul>
<table border=0 width=600>
	<tr><td nowrap bgcolor="#EEEEEE">
	<pre><strong>
% ssh-agent
setenv SSH_AUTH_SOCK /tmp/ssh-IwBf5763/agent.5763;
setenv SSH_AGENT_PID 17522;
echo Agent pid 17522;
%
	</strong></pre>
	</td></tr>
</table>
</ul>

<p>Итак, ssh-agent открывает сокет для общения с ssh и сообщает нам об этом, через
переменную окружения SSH_AUTH_SOCK, а так же сообщает нам свой pid, который
также установлен в переменной окружения SSH_AGENT_PID и выводится в команде echo.
Далее ssh будет использовать эти переменные окружения для определения того, что мы
действительно хотим использовать ssh-agent и взаимодействия с ним.</p>

<p>Правельный запуск ssh-agent. Используя shell команду eval</p>

<ul>
<table border=0 width=600>
	<tr><td nowrap bgcolor="#EEEEEE">
	<pre><strong>
% eval `ssh-agent`
Agent pid 17522
%
	</strong></pre>
	</td></tr>
</table>
</ul>

<p>или задав программу использующею ssh, как аргумент в ssh-agent. В данном случае
это обычный shell.</p>

<ul>
<table border=0 width=600>
	<tr><td nowrap bgcolor="#EEEEEE">
	<pre><strong>
% ssh-agent /bin/ksh
$ env | grep SSH
SSH_AUTH_SOCK=/tmp/ssh-SAe17087/agent.17087
SSH_AGENT_PID=20652
$
	</strong></pre>
	</td></tr>
</table>
</ul>

<p>Теперь нам надо добавить ключ и парольную фразу к нему, используем ssh-add.</p>

<ul>
<table border=0 width=600>
	<tr><td nowrap bgcolor="#EEEEEE">
	<pre><strong>
% ssh-add ~/.ssh/identity
Enter passphrase for user@localhost: (здесь вводим парольную фразу для нашего приватного ключа)
Identity added: identity (user@localhost)
%
	</strong></pre>
	</td></tr>
</table>
</ul>

<p>Проверяем:</p>

<ul>
<table border=0 width=600>
	<tr><td nowrap bgcolor="#EEEEEE">
	<pre><strong>
% ssh remote.server
OpenBSD 2.9-stable (GENERIC) #256 Wed Sep 12 00:01:20 UTC 2001

No mail.
%
	</strong></pre>
	</td></tr>
</table>
</ul>

<hr><small>
<em>$RuOBSD: ssh.html,v 1.2 2001/09/12 06:52:18 dfa Exp $</em>
</small>
            
</body>
</html>
