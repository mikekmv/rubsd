<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=koi8-r">
<meta http-equiv="Content-Language" content="ru">
<meta name="copyright" content="Copyright (c) 2006 by OpenBSD.ru">
<title>Сборка custom ядра</title>
</head>

<body bgcolor="#ffffff" text="#000000" link="#23238e">

<h2><font color="#e00000">Сборка custom ядра</font></h2>
<hr>

<p>
<strong>Содержание</strong>:<br>
<ul>
<li><a href="#intro">Зачем это нужно?</a>
<li><a href="#required">Основные опции</a>
<li><a href="#debug">Опции, используемые при отладке</a>
<li><a href="#diag">Статистика и диагностика</a>
<li><a href="#ip">Стеки протоколов IPv4 и IPv6</a>
<li><a href="#crypto">Криптография в ядре. Использование криптографии в сетевых протоколах</a>
<li><a href="#filesystem">Файловые системы</a>
<li><a href="#xwindow">X Window System</a>
<li><a href="#sysctl">Изменение параметров ядра через sysctl</a>
</ul>

<hr>

<a name="intro">
<h3><font color="#0000e0">Зачем это нужно?</font></h3>

<p>
Причин для сборки custom ядра может быть много, но основные это:

<ul>
<li>оптимизация по размеру;
<li>оптимизация по скорости;
<li>связанные с драйверами устройств (добавление, удаление или изменение
режима работы).
</ul>

<p>
<strong>Внимание:</strong> настройка custom ядра - это операция, предполагающая
определенный уровень понимания своих действий и способная привести систему
в нерабочее состояние. Данное руководство призвано прояснить некоторые детали
и помочь в настройке ядра подготовленным пользователям.

<p>
Основная идея оптимизации ядра по размеру - удаление неиспользуемого кода.
Это, прежде всего, неиспользуемые драйверы устройств и различные подсистемы.
Для поиска используемых драйверов устройств можно использовать вывод
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dmesg&sektion=8">dmesg(8)</a>,
а так же специализированные программы, например,
<a href="http://www.sentia.org/projects/dmassage/">dmassage</a>.

<p>
Неиспользуемые подсистемы ядра отключаются удалением соответствующих
<em>опций</em>, например, если не используется двоичная совместимость с
исполняемыми файлами Linux, можно удалить опцию <code>COMPAT_LINUX</code>
и т. д. Список всех опций приведен в руководстве
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=options&sektion=4">options(4)</a>.

<a name="required">
<h3><font color="#0000e0">Основные опции</font></h3>

Ниже приведен список <em>опций</em>, без которых работа ОС будет осложнена
или невозможна:

<p>
<table border="1" width="100%" cellpadding="10">
<tr valign="top">
<td width="20%">
<code>I386_CPU</code><br>
<code>I486_CPU</code><br>
<code>I586_CPU</code><br>
<code>I686_CPU</code>
</td>
<td>
Поддержка соответствующего семейства CPU (для архитектуры i386).
</td>
</tr>
<tr valign="top">
<td>
<code>FIFO</code>
</td>
<td>
Поддержка именованных каналов, достаточно распространенное средство
межпроцессорного взаимодействия (IPC).
</td>
</tr>
<tr valign="top">
<td>
<code>SYSVMSG</code><br>
<code>SYSVSEM</code><br>
<code>SYSVSHM</code>
</td>
<td>
Средства IPC из UNIX SystemV (очереди сообщений, семафоры, разделяемая память).
</td>
</tr>
<tr valign="top">
<td>
<code>FFS</code>
</td>
<td>
Файловая система Berkeley Fast File System.
</td>
</tr>
<tr valign="top">
<td>
<code>INET</code>
</td>
<td>
Поддержка протоколов стека IPv4.
</td>
</tr>
<tr valign="top">
<td>
<code>WSDISPLAY_COMPAT_USL</code><br>
<code>WSDISPLAY_DEFAULTSCREENS</code>
</td>
<td>
Поддержка виртуальных экранов в консоле.
</td>
</tr>
</table>
<p>
Остальные опции ядра включаются, если необходим соответствующий функционал.

<a name="debug">
<h3><font color="#0000e0">Опции, используемые при отладке</font></h3>

<p>
Отладка ядра OpenBSD может выполняться в двух режимах: непосредственно после
аварийного останова с использованием встроенного отладчика
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ddb&sektion=8">ddb(4)</a>
или отладка дампа памяти ядра в
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=gdb&sektion=1">gdb(1)</a>
с использованием дополнительного ядра, содержащего отладочные символы.
Возможно использование обоих методов. За возможность использования <font
color="#008000">ddb</font> отвечает опция <code>DDB</code>, для того чтобы
отлаживать ядро по дампу памяти, необходимо соблюдение двух условий:

<ul>
<li>размер swap вмещает полный дамп памяти с некоторым запасом;
<li>ядро собрано с опцией <code>makeoptions DEBUG="-g"</code>.
</ul>

<p>
Для отладки пользовательских процессов удобно использовать
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ktrace&sektion=1">ktrace(1)</a>
или
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=gdb&sektion=1">gdb(1)</a>.
Для этого необходимо включить опции <code>KTRACE</code> и <code>PTRACE</code>.

<a name="diag">
<h3><font color="#0000e0">Статистика и диагностика</font></h3>

<p>
OpenBSD поддерживает ряд опций, связанных со сбором статистики и
дополнительными проверками в коде ядра:

<p>
<table border="1" width="100%" cellpadding="10">
<tr valign="top">
<td width="20%">
<code>ACCOUNTING</code>
</td>
<td>
Поддержка сборки общей статистики работы системы (сюда входят данные по
нагрузке на процессор, дисковую подсистему и так далее). Реальное включение
сборки статистики производится с помощью
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=accton&sektion=8">accton(8)</a>.
</td>
</tr>
<tr valign="top">
<td>
<code>DIAGNOSTIC</code>
</td>
<td>
Включить дополнительные проверки в коде. Обычно это незначительные проверки,
которые могут привести к kernel panic. Можно попробовать отключить данную
опцию для достижения большей надежности системы, однако это может привести и
к нежелательным последствиям.
</td>
<tr valign="top">
<td>
<code>KMEMSTATS</code>
</td>
<td>
Сборка статистики по аллокации памяти. Может быть отключена на рабочих
системах, поскольку требует дополнительных затрат процессора и памяти.
</td>
</tr>
</table>

<p>
Для достижеия повышеной скорости работы эти опции могут быть почти
безболезнено удалены из конфигурации ядра.

<a name="ip">
<h3><font color="#0000e0">Стеки протоколов IPv4 и IPv6</font></h3>

<p>
<table border="1" width="100%" cellpadding="10">
<tr valign="top">
<td width="20%">
<code>INET</code>
</td>
<td>
Поддержка стека протоколов IPv4. Во многих случаях опция необходима.
</td>
</tr>
<tr valign="top">
<td>
<code>INET6</code>
</td>
<td>
Поддержка стека протоколов IPv6. Требует IPv4. Если вы не работаете с IPv6,
данную опцию можно отключить.
</td>
</tr>
<tr valign="top">
<td>
<code>TCP_SACK</code>
</td>
<td>
Поддержка механизма выборочного подтверждения TCP пакетов (Selective
Acknowledgements, RFC 2018). Позволяет повысить эффективность передачи TCP
сегментов. TCP SACK должен поддерживаться сервером и клиентами.
</td>
</tr> 
<tr valign="top">
<td>
<code>TCP_ECN</code>
</td> 
<td>
Поддержка явных уведомлений о перегрузках в сети (Explicit Congestion
Notification, RFC 3168). Позволяет дополнительно регулировать скорость
передачи TCP сегментов между двумя сторонами в следствии перегрузок в
канале передачи. TCP ECN должен поддерживаться обоими сторонами.
</td>
</tr>
</table>

<p>
Пакетный фильтр
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&sektion=4">pf</a>,
работающий на сетевом уровне (Networking Layer) стека TCP/IP, поддерживает
работу как с IPv4, так и с IPv6 в зависимости от конфигурации ядра. Поддержка
<font color="#008000">pf</font> в ядре включается добавлением псевдоустройства:

<pre>
pseudo-device pf
</pre>

<p>
Для того, чтобы в
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&sektion=5">правилах pf</a>
можно было использовать директиву <code>log</code>, необходимо добавить
поддержку псевдоинтерфейса
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflog&sektion=4">pflog(4)</a>:

<pre>
pseudo-device pflog
</pre>

<a name="crypto">
<h3><font color="#0000e0">Криптография в ядре. Использование криптографии в сетевых протоколах</font></h3>

<p>
Криптография очень широко используется в ядре OpenBSD. В основу положено
обобщенное
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=crypto&sektion=9">OpenBSD 
Cryptographic Framework (OCF)</a>,
которое включается в сборку при указании опции <code>CRYPTO</code> - это базис
для всего кода, использующего криптографию в ядре.

<p>
Опция <code>UVM_SWAP_ENCRYPT</code> включает шифрование страниц памяти до
попадания в swap. По результатам тестирования на это затрачивается сравнительно
немного ресурсов, но для повышения быстродействия на слабых машинах,
возможно имеет смысл исключить эту опцию из файла конфигурации ядра. Отключить
шифрование можно также через
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&sektion=8">sysctl(8)</a>:

<pre>
vm.swapencrypt.enable=0
</pre>

<p>
OpenBSD поддерживает ряд устройств, называемых крипто-акселераторами
(<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hifn&sektion=4">hifn(4)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ubsec&sektion=4">ubsec(4)</a>
и др.), которые способны регистрировать в OCF поддерживаемые алгоритмы, и ядро
в состоянии разгрузить работу по криптованию на такие устройства. Доступ
пользовательских программ (таких как
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=openssl&sektion=1">OpenSSL</a>)
к этой подсистеме организуется через псевдоустройство
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=crypto&sektion=4">crypto(4)</a>:

<pre>
pseudo-device crypto
</pre>

<p>
Практика показывает, что использование подобных устройств способно реально
повысить быстродействие только в определенных случаях. Узкими местами
являются пропускная способность шины PCI и медлительность самих устройств,
по сравнению с современными CPU. Крипто-акселераторы могут повысить
быстродействие в тех случаях, когда используются медленные CPU, шина PCI
разгружена, а также при больших блоках шифруемых данных и при определенных
алгоритмах шифрования (чаще всего - блочных симметричных шифрах, например 3DES).
Однако, весьма эффективными являются криптографические средства, встроенные
непосредственно в CPU. Ярким примером является процессор
<a href="http://www.via.com.tw/en/products/processors/eden-n/">VIA Eden-N</a>,
поддерживающий инструкции работы с блочным симметричным шифрованием AES.

<p>
Поддержка IPsec включается опцией <code>IPSEC</code>. Требуется поддержка
IPv4 стека (опция <code>INET</code>), OCF (опция <code>CRYPTO</code>) и
специализированного псевдоинтерфейса
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=enc&sektion=4">enc(4)</a>,
предназначенного для фильтрации ``внутри'' IPsec туннеля (а на самом деле, до
шифрования пакетов и после их дешифрования):

<pre>
pseudo-device enc
</pre>

<p>
Средства криптографии также применяются в ряде сетевых протоколов. При
использовании BGP маршрутизации очень часто используются подписанные TCP
сегменты для обеспечения аутентификации источника сообщений. В OpenBSD это
делается добавлением опции <code>TCP_SIGNATURE</code> (это требует
включенных опций <code>INET</code>, <code>CRYPTO</code>, <code>IPSEC</code>).

<p>
Протоколы
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync&sektion=4">pfsync(4)</a>
и
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=carp&sektion=4">carp(4)</a>
также используют криптографическую подпись пакетов, поэтому нуждаются в
поддержке OCF и зависят от ряда компонент IPsec.

<a name="filesystem">
<h3><font color="#0000e0">Файловые системы</font></h3>

<p>
Основной файловой системой в OpenBSD является Berkeley Fast File System.
Также поддерживаются FAT, NTFS, Linux Extended 2, ISO-9660, UDF и две
сетевые файловые системы: NFS и XFS.

<p>
<table border="1" width="100%" cellpadding="10">
<tr valign="top">
<td width="20%">
<code>FFS</code>
</td>
<td>
Файловая система Berkeley Fast File System.
</td>
</tr>
<tr valign="top">
<td>
<code>FFS_SOFTUPDATES</code>
</td>
<td>
Поддержка SoftUpdates для FFS. За счет системы буферизации заметно
увеличивает скорость записи на диск.
</td>
</tr>
<tr valign="top">
<td>
<code>UFS_DIRHASH</code>
</td>
<td>
Хеширование содержимого директорий, повышает скорость доступа к директориям
с большим количеством файлов.
</td>
</tr>
<tr valign="top">
<td>
<code>QUOTA</code>
</td>
<td>
Поддержка квот на файловой системе FFS.
</td>
</tr>
<tr valign="top">
<td>
<code>MFS</code>
</td>
<td>
Поддержка создания файловой системы в оперативной памяти, способной к
переходу в свап.
</td>
</tr>
<tr valign="top">
<td>
<code>MSDOSFS</code>
</td>
<td>
Поддержка FAT12, FAT16 и FAT32.
</td>
</tr>
<tr valign="top">
<td>
<code>NTFS</code>
</td>
<td>
Поддержка NTFS4 (Windows NT 4.0) и NTFS5 (Windows 2000 и более поздние) в
режиме только для чтения. <em>Нестабильно</em>.
</td>
</tr>
<tr valign="top">
<td>
<code>EXT2FS</code>
</td>
<td>
Поддержка Linux Extended 2 File System.
</td>
</tr>
<tr valign="top">
<td>
<code>CD9660</code>
</td>
<td>
Поддержка файловой системы ISO-9660, используемой на CD и DVD дисках
(мультисессионные диски не поддерживаются).
</td>
</tr>
<tr valign="top">
<td>
<code>UDF</code>
</td>
<td>
Поддержка файловой системы DVD. Обычно DVD диски могут быть смонтированы как
обычные CD.
</td>
</tr>
<tr valign="top">
<td>
<code>NFSCLIENT</code><br>
<code>NFSSERVER</code>
</td>
<td>
Поддержка сетевой файловой системы NFS в режимах клиента и сервера.
</td>
</tr>
<tr valign="top">
<td>
<code>XFS</code>
</td>
<td>
Поддержка сетевой распределенной файловой системы Andrew FS (AFS).
Практически не используется.
</td>
</tr>
</table>

<a name="xwindow">
<h3><font color="#0000e0">X Window System</font></h3>

Для корректной работы X Window System необходимы или желательны следующие
опции (платформа i386):

<p>
<table border="1" width="100%" cellpadding="10">
<tr valign="top">
<td width="20%">
<code>APERTURE</code>
</td>
<td>
Драйвер апертуры ядра, позволяет X серверу получать прямой доступ к видео
памяти и регистрам PCI устройств.
</td>
</tr>
<tr valign="top">
<td>
<code>USER_PCICONF</code>
</td>
<td>
Предоставляет прикладным процессам (например, X серверу) возможность получения
доступа к конфигурации PCI шины.
</td>
</tr>
<tr valign="top">
<td>
<code>PCIAGP</code>
</td>
<td>
Позволяет получать доступ X сервера к GART (Graphics Address Remapping Table).
</td>
</tr>
<tr valign="top">
<td>
<code>WSDISPLAY_COMPAT_RAWKBD</code><br>
<code>WSDISPLAY_COMPAT_PCVT</code>
</td>
<td>
Позволяет получить доступ к клавиатуре.
</td>
</tr>
</table>

<a name="sysctl">
<h3><font color="#0000e0">Изменение параметров ядра через sysctl</font></h3>

<p>
Настройка ядра через sysctl происходит при загрузке системы, но после загрузки
некоторые значения являются недоступными при конкретном уровне безопасности
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=securelevel&sektion=7">securelevel(7)</a>.
Понизить <font color="#008000">securelevel</font> можно, отредактировав
файл <font color="#008000">/etc/rc.securelevel</font>:

<pre>
# <strong>vi /etc/rc.securelevel</strong>
securelevel=-1
</pre>

<p>
Для работы X сервера необходимо разрешить использование апертуры ядра:

<pre>
machdep.allowaperture=2
</pre>

<p>
<hr>
<a href="index.html"><img height=24 width=24 src="../images/back.gif" border=0 alt="OpenBSD.ru"></a>
<a href="mailto:www@openbsd.ru">www@openbsd.ru</a>
<br>
<small>$RuOBSD: howto-kernconf.html,v 1.11 2006/02/28 21:11:29 andrey Exp $</small>

</body>
</html>
