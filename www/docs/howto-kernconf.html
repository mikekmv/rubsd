<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=koi8-r">
<meta http-equiv="Content-Language" content="ru">
<meta name="copyright" content="Copyright (c) 2006, 2007 by OpenBSD.ru">
<title>Сборка custom ядра</title>
</head>

<body bgcolor="#ffffff" text="#000000" link="#23238e">

<h2><font color="#e00000">Сборка custom ядра</font></h2>
<hr>

<p>
<strong>Содержание</strong>:<br>
<ul>
<li><a href="#intro">Зачем это нужно?</a>
<li><a href="#required">Основные опции (на примере архитекруты i386)</a>
<li><a href="#mp">Поддержка многопроцессорности для архитектуры i386</a>
<li><a href="#arch">Поддержка расширенных возможностей архитектуры i386</a>
<li><a href="#debug">Опции, используемые при отладке</a>
<li><a href="#diag">Статистика и диагностика</a>
<li><a href="#ip">Стеки протоколов IPv4 и IPv6</a>
<li><a href="#crypto">Криптография в ядре. Использование криптографии в
сетевых протоколах</a>
<li><a href="#filesystem">Файловые системы</a>
<li><a href="#compat">Совместимость с ранними версиями</a>
<li><a href="#emul">Двоичная совместимость с другими системами</a>
<li><a href="#xwindow">X Window System</a>
<li><a href="#example">Пример конфигурации ядра</a>
</ul>

<hr>

<a name="intro"></a>
<h3><font color="#0000e0">Зачем это нужно?</font></h3>

<p>
Причин для сборки custom ядра может быть много, но основные это:

<ul>
<li>оптимизация по размеру;
<li>оптимизация по скорости;
<li>связанные с драйверами устройств (добавление, удаление или изменение
режима работы).
</ul>

<p>
<strong>Внимание:</strong> настройка custom ядра - это операция, предполагающая
определенный уровень понимания своих действий и способная привести систему
в нерабочее состояние. Данное руководство призвано прояснить некоторые детали
и помочь в настройке ядра подготовленным пользователям.

<p>
Основная идея оптимизации ядра по размеру - удаление неиспользуемого кода.
Это, прежде всего, неиспользуемые драйверы устройств и различные подсистемы.
Для поиска используемых драйверов устройств можно использовать вывод
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dmesg&amp;sektion=8">dmesg(8)</a>,
а так же специализированные программы, например,
<a href="http://www.sentia.org/projects/dmassage/">dmassage</a>.

<p>
Неиспользуемые подсистемы ядра отключаются удалением соответствующих
<em>опций</em>, например, если не используется двоичная совместимость с
исполняемыми файлами Linux, можно удалить опцию <code><b>COMPAT_LINUX</code></b>
и т. д. Список всех опций приведен в руководстве
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=options&amp;sektion=4">options(4)</a>.

<a name="required"></a>
<h3><font color="#0000e0">Основные опции (на примере архитектуры i386)</font></h3>

Ниже приведен список <em>опций</em>, без которых работа ОС будет осложнена
или невозможна:

<p>
<table border="1" width="100%" cellpadding="10">
<tr valign="top">
<td>
<code><b>KVM86</code></b>
</td>
<td>
Поддержка эмуляции виртуального режима 8086-совместимого процессора.
Требуется для устройства
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=piixpcib&amp;sektion=4&amp;arch=i386">piixpcib(4)</a>. Возможно будет также использоваться для
разработки бэкенда для драйвера wsfb(4).
</td>
</tr>
<tr valign="top">
<td>
<code><b>FIFO</code></b>
</td>
<td>
Поддержка именованных каналов,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mkfifo&amp;sektion=2">mkfifo(2)</a>.
</td>
</tr>
<tr valign="top">
<td>
<code><b>SYSVMSG</code></b><br>
<code><b>SYSVSEM</code></b><br>
<code><b>SYSVSHM</code></b>
</td>
<td>
Средства IPC из UNIX SystemV (очереди сообщений, семафоры, разделяемая память).
</td>
</tr>
<tr valign="top">
<td>
<code><b>FFS,FFS2</code></b>
</td>
<td>
Файловая система Berkeley Fast File System с поддержкой 2-ой версии.
</td>
</tr>
<tr valign="top">
<td>
<code><b>INET</code></b>
</td>
<td>
Поддержка протоколов стека IPv4.
</td>
</tr>
<tr valign="top">
<td>
<code><b>WSDISPLAY_COMPAT_USL</code></b><br>
<code><b>WSDISPLAY_DEFAULTSCREENS</code></b>
</td>
<td>
Поддержка виртуальных экранов.
</td>
</tr>
</table>
<p>
Остальные опции ядра включаются, если необходим соответствующий функционал.

<a name="mp"></a>
<h3><font color="#0000e0">Поддержка многопроцессорности для архитектуры i386</font></h3>

<p>
Для того чтобы собрать ядро с поддержкой SMP для архитектуры i386 необходимо
добавить в конфигурацио ядра опцию <code><b>MULTIPROCESSOR</code></b>,
поддержку
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ioapic&sektion=4&arch=i386">I/O APIC</a>
и устройств для дополнительных процессоров:

<b><pre>
option		MULTIPROCESSOR

cpu*		at mainbus?
ioapic*		at mainbus?
</pre></b>

<a name="arch"></a>
<h3><font color="#0000e0">Поддержка расширенных возможностей архитектуры i386</font></h3>

<p>
За долгое время развития, архитектура i386 процессора вобрала в себя множество
различных возможностей. Некоторые фундаментальны, некоторые опциональны. Ряд
опциональных возможностей архитектуры i386 в OpenBSD представлен отдельными
опциями или устройствами.

<p>
<table border="1" width="100%" cellpadding="10">
<tr valign="top">
<td width="20%">
<code><b>USER_LDT</code></b>
</td>
<td>
Добавляет возможность процессам менять локальную таблицу дескрипторов (LDT).
Обычно ядро OpenBSD полагается на глобальную таблицу дескрипторов (GDT) и
отдельные процессы не могут менять LDT. Однако, в ряде случаев, необходимо
иметь возможность изменять её. Чаще всего это связано с работой файлов и
библиотек других систем, например использование эмулятора Wine или Win32
кодеков в mplayer. Возможность изменения LDT должна быть явно задана
sysctl-флагом <code><i>machdep.userldt</i></code>.
</td>
</tr>
</table>

<p>
Также поддерживаются два псевдо-устройства, связанные с дополнительными
возможностями процессоров семейства i386. Прежде всего это поддержка
регистров атрибутов областей памяти,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mtrr&amp;sektion=4&amp;arch=i386">mtrr(4)</a>,
управляющих параметрами кэширования:

<b><pre>
pseudo-device mtrr
</pre></b>

<p>
Эти регистры используются X Window System и теоретически ускоряют работу
с видео подсистемой.

<p>
Второе псевдо-устройство предоставляет доступ к "счетчикам производительности"
процессоров Intel и к счетчикам времени TSC на других процессорах,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pctr&amp;sektion=4&amp;arch=i386">pctr(4)</a>:

<b><pre>
pseudo-device pctr
</pre></b>

<p>
"Счетчики производительности" процессоров Intel поддерживают широкие
возможности по наблюдению за прерываниями, кэшированием и др., в то
время как счетчик времени содержит монотонно возрастающее 64-битное
значение, обнуляемое при включении процессора или при естественном
переполнении разрядной сетки.

<p>
Эти средства часто используются в программах, измеряющих скорость
работы каких-либо процессов. Просмотреть текущие значения счетчиков
и запрограммировать их можно с помощью утилиты
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pctr&amp;sektion=1&amp;arch=i386">pctr(1)</a>.

<a name="debug"></a>
<h3><font color="#0000e0">Опции, используемые при отладке</font></h3>

<p>
Отладка ядра OpenBSD может выполняться в двух режимах: непосредственно после
аварийного останова с использованием встроенного отладчика
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ddb&amp;sektion=4">ddb(4)</a>
или отладка дампа памяти ядра в
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=gdb&amp;sektion=1">gdb(1)</a>
с использованием дополнительного ядра, содержащего отладочные символы.
Возможно использование обоих методов. За возможность использования <font
color="#008000">ddb</font> отвечает опция <code><b>DDB</code></b>,
для того чтобы отлаживать ядро по дампу памяти, необходимо соблюдение
двух условий:

<ul>
<li>размер swap вмещает полный дамп памяти с некоторым запасом;
<li>ядро собрано с опцией <code><b>makeoptions DEBUG="-g"</code></b>.
</ul>

<p>
Для отладки пользовательских процессов удобно использовать
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ktrace&amp;sektion=1">ktrace(1)</a>
или
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=gdb&amp;sektion=1">gdb(1)</a>.
Для этого необходимо включить опции <code><b>KTRACE</code></b> и
<code><b>PTRACE</code></b>.

<p>
Важной является и опция <code><b>BOOT_CONFIG</code></b>, разрешающая
изменение параметров ядра на этапе загрузки через
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=boot_config&amp;sektion=8&amp;arch=i386">User Kernel Config (UKC)</a>.

<a name="diag"></a>
<h3><font color="#0000e0">Статистика и диагностика</font></h3>

<p>
OpenBSD поддерживает ряд опций, связанных со сбором статистики и
дополнительными проверками в коде ядра:

<p>
<table border="1" width="100%" cellpadding="10">
<tr valign="top">
<td width="20%">
<code><b>ACCOUNTING</code></b>
</td>
<td>
Поддержка сбора статистики работы системы по процессам (сюда входят данные
по нагрузке на процессор, дисковую подсистему и так далее). Реальное включение
сбора статистики производится с помощью
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=accton&amp;sektion=8">accton(8)</a>.
</td>
</tr>
<tr valign="top">
<td>
<code><b>DIAGNOSTIC</code></b>
</td>
<td>
Включить дополнительные проверки в коде. Обычно это незначительные проверки,
которые могут привести к kernel panic. Можно попробовать отключить данную
опцию для достижения большей надежности системы, однако это может привести и
к нежелательным последствиям.
</td>
<tr valign="top">
<td>
<code><b>KMEMSTATS</code></b>
</td>
<td>
Сбор статистики по использованию памяти. Может быть отключен на рабочих
системах, поскольку требует дополнительных затрат процессора и памяти.
</td>
</tr>
</table>

<p>
Для достижения повышенной скорости работы эти опции могут быть почти
безболезненно удалены из конфигурации ядра.

<a name="ip"></a>
<h3><font color="#0000e0">Стеки протоколов IPv4 и IPv6</font></h3>

<p>
<table border="1" width="100%" cellpadding="10">
<tr valign="top">
<td width="20%">
<code><b>INET</code></b>
</td>
<td>
Поддержка стека протоколов IPv4. Во многих случаях опция необходима.
</td>
</tr>
<tr valign="top">
<td>
<code><b>INET6</code></b>
</td>
<td>
Поддержка стека протоколов IPv6. Требует IPv4. Если вы не работаете с IPv6,
данную опцию можно отключить.
</td>
</tr>
<tr valign="top">
<td>
<code><b>TCP_SACK</code></b>
</td>
<td>
Поддержка механизма выборочного подтверждения TCP сегментов (Selective
Acknowledgements, RFC 2018). Позволяет повысить эффективность передачи TCP
сегментов. TCP SACK должен поддерживаться сервером и клиентами.
</td>
</tr>
<tr valign="top">
<td>
<code><b>TCP_ECN</code></b>
</td>
<td>
Поддержка явных уведомлений о перегрузках в сети (Explicit Congestion
Notification, RFC 3168). Позволяет дополнительно регулировать скорость
передачи TCP сегментов между двумя сторонами в следствии перегрузок в
канале передачи. TCP ECN должен поддерживаться обоими сторонами.
</td>
</tr>
<tr valign="top">
<td>
<code><b>TCP_SIGNATURE</code></b>
</td>
<td>
Поддержка подписи сегментов TCP с использованием MD5 хэш сумм
(Protection of BGP Sessions via the TCP MD5 Signature Option, RFC 2385).
Используется протоколом внешней маршрутизации BGP для установления
подлиности отправителя. Возможность подписи сегментов TCP должна
поддерживаться обоими сторонами. Требует наличия опции
<code><b>CRYPTO</code></b>.
</td>
</tr>
<tr valign="top">
<td>
<code><b>ALTQ</code></b>
</td>
<td>
Поддержка механизмов обеспечения качества обслуживания (Quality of Service,
QoS). Включает в себя ряд дисциплин трафика: приоритетную, классовую и
иерархическую. Управление очередями осуществляется посредством соответствующих
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&amp;sektion=5#QUEUEING">правил
pf</a>.
</td>
</tr>
</table>

<p>
Пакетный фильтр
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4">pf</a>,
работающий на межсетевом уровне (Internetworking) стека TCP/IP, поддерживает
работу как с IPv4, так и с IPv6 в зависимости от конфигурации ядра. Поддержка
<font color="#008000">pf</font> в ядре включается добавлением псевдо-устройства:

<b><pre>
pseudo-device pf
</pre></b>

<p>
Для того, чтобы в
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&amp;sektion=5">правилах pf</a>
можно было использовать директиву <code><b>log</code></b>, необходимо добавить
поддержку псевдо-интерфейса
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflog&amp;sektion=4">pflog(4)</a>:

<b><pre>
pseudo-device pflog
</pre></b>

<p>
Синхронизация таблицы состояний соединений (connection state table)
реализуется через интерфейс
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync&amp;sektion=4">pfsync(4)</a>,
поддержка которого в ядре реализуется через псевдо-устройство:

<b><pre>
pseudo-device pfsync
</pre></b>

<p>
На основе
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync&amp;sektion=4">pfsync(4)</a>,
построен протокол Common Address Redundancy Protocol (CARP), реализуемый в
OpenBSD через псевдо-устройство
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=carp&amp;sektion=4">carp(4)</a>:

<b><pre>
pseudo-device carp
</pre></b>

<a name="crypto"></a>
<h3><font color="#0000e0">Криптография в ядре. Использование криптографии в
сетевых протоколах</font></h3>

<p>
Криптография очень широко используется в ядре OpenBSD. В основу положено
обобщенное
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=crypto&amp;sektion=9">OpenBSD 
Cryptographic Framework (OCF)</a>,
которое включается в сборку при указании опции <code><b>CRYPTO</code></b> -
это базис для всего кода, использующего криптографию в ядре.

<p>
Опция <code><b>UVM_SWAP_ENCRYPT</code></b> включает шифрование страниц
памяти до попадания в swap. По результатам тестирования на это затрачивается
сравнительно немного ресурсов, но для повышения быстродействия на слабых
машинах, возможно имеет смысл исключить эту опцию из файла конфигурации ядра.
Отключить шифрование можно также через
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=8">sysctl(8)</a>:

<b><pre>
# sysctl vm.swapencrypt.enable=0
</pre></b>

<p>
OpenBSD поддерживает ряд устройств, называемых крипто-акселераторами
(<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hifn&amp;sektion=4">hifn(4)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ubsec&amp;sektion=4">ubsec(4)</a>
и др.), которые способны регистрировать в OCF поддерживаемые алгоритмы, и ядро
в состоянии разгрузить работу по шифрованию на такие устройства. Доступ
пользовательских программ (таких как
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=openssl&amp;sektion=1">OpenSSL</a>)
к этой подсистеме организуется через псевдоустройство
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=crypto&amp;sektion=4">crypto(4)</a>:

<b><pre>
pseudo-device crypto
</pre></b>

<p>
Практика показывает, что использование подобных устройств способно реально
повысить быстродействие только в определенных случаях. Узкими местами
являются пропускная способность шины PCI и медлительность самих устройств,
по сравнению с современными CPU. Крипто-акселераторы могут повысить
быстродействие в тех случаях, когда используются медленные CPU, шина PCI
разгружена, а также при больших блоках шифруемых данных и при определенных
алгоритмах шифрования (чаще всего - блочных симметричных шифрах, например 3DES).
Однако, весьма эффективными являются криптографические средства, встроенные
непосредственно в CPU. Ярким примером является процессор
<a href="http://www.via.com.tw/en/products/processors/eden-n/">VIA Eden-N</a>,
поддерживающий инструкции работы с блочным симметричным шифрованием AES.

<p>
Поддержка IPsec включается опцией <code><b>IPSEC</code></b>. Требуется
поддержка IPv4 стека (опция <code><b>INET</code></b>), OCF (опция
<code><b>CRYPTO</code></b>) и специализированного псевдо-интерфейса
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=enc&amp;sektion=4">enc(4)</a>,
позволяющего фильтровать пакеты до и после их обработки кодом IPsec:

<b><pre>
pseudo-device enc
</pre></b>

<p>
Средства криптографии также применяются в ряде сетевых протоколов. При
использовании BGP маршрутизации очень часто используются подписанные TCP
сегменты для обеспечения аутентификации источника сообщений. В OpenBSD это
делается добавлением опции <code><b>TCP_SIGNATURE</code></b> (это требует
включенных опций <code><b>INET</code></b>, <code><b>CRYPTO</code></b>,
<code><b>IPSEC</code></b>).

<p>
Протоколы
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync&amp;sektion=4">pfsync(4)</a>
и
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=carp&amp;sektion=4">carp(4)</a>
также используют криптографическую подпись пакетов, поэтому нуждаются в
поддержке OCF и зависят от ряда компонент IPsec.

<a name="filesystem"></a>
<h3><font color="#0000e0">Файловые системы</font></h3>

<p>
Основной файловой системой в OpenBSD является Berkeley Fast File System.
Также поддерживаются FAT, NTFS, Linux Extended 2, ISO-9660, UDF и две
сетевые файловые системы: NFS и XFS.

<p>
<table border="1" width="100%" cellpadding="10">
<tr valign="top">
<td width="20%">
<code><b>FFS,FFS2</code></b>
</td>
<td>
Файловая система Berkeley Fast File System с поддержкой 2-ой версии.
</td>
</tr>
<tr valign="top">
<td>
<code><b>FFS_SOFTUPDATES</code></b>
</td>
<td>
Поддержка SoftUpdates для FFS и FFS2. За счет системы буферизации заметно
увеличивает скорость записи на диск.
</td>
</tr>
<tr valign="top">
<td>
<code><b>UFS_DIRHASH</code></b>
</td>
<td>
Хеширование содержимого директорий, повышает скорость доступа к директориям
с большим количеством файлов.
</td>
</tr>
<tr valign="top">
<td>
<code><b>QUOTA</code></b>
</td>
<td>
Поддержка квот на файловых системах FFS и FFS2.
</td>
</tr>
<tr valign="top">
<td>
<code><b>MFS</code></b>
</td>
<td>
Поддержка создания файловой системы в оперативной памяти, способной к
переходу в свап.
</td>
</tr>
<tr valign="top">
<td>
<code><b>MSDOSFS</code></b>
</td>
<td>
Поддержка FAT12, FAT16 и FAT32.
</td>
</tr>
<tr valign="top">
<td>
<code><b>NTFS</code></b>
</td>
<td>
Поддержка NTFS4 (Windows NT 4.0) и NTFS5 (Windows 2000 и более поздние) в
режиме только для чтения.
</td>
</tr>
<tr valign="top">
<td>
<code><b>EXT2FS</code></b>
</td>
<td>
Поддержка Linux Extended 2 File System (и Extended 3 без журналирования).
</td>
</tr>
<tr valign="top">
<td>
<code><b>CD9660</code></b>
</td>
<td>
Поддержка файловой системы ISO-9660, используемой на CD и DVD дисках
(мультисессионные диски не поддерживаются).
</td>
</tr>
<tr valign="top">
<td>
<code><b>UDF</code></b>
</td>
<td>
Поддержка файловой системы DVD. Некоторые DVD диски могут быть смонтированы
как обычные CD.
</td>
</tr>
<tr valign="top">
<td>
<code><b>NFSCLIENT</code></b><br>
<code><b>NFSSERVER</code></b>
</td>
<td>
Поддержка сетевой файловой системы NFS в режимах клиента и сервера.
</td>
</tr>
<tr valign="top">
<td>
<code><b>XFS</code></b>
</td>
<td>
Поддержка сетевой распределенной файловой системы Andrew FS (AFS).
Практически не используется.
</td>
</tr>
</table>

<p>
Существуют и несколько виртуальных файловых систем: PROCFS и PORTAL.
Однако, из-за архитектурных особенностей системы они являются
необязательными. Файловая система PROCFS используется в основном с эмуляцией
Linux, а поддержка PORTAL осталась со времен BSD UNIX и не несет в себе
никакой смысловой нагрузки. Ранее также существовали файловые системы KERNFS,
NULLFS, UMAPFS и другие, но были удалены по причине нестабильности или
отсутствия в них нужды.

<a name="compat"></a>
<h3><font color="#0000e0">Совместимость с ранними версиями</font></h3>

<p>
OpenBSD, как и любая развивающаяся система, эволюционирует, но в тоже
время пытается оставаться совместимой с прежними интерфейсами ядра и
двоичными файлами, скомпилированными для ранних версий системы.
Для этого существует ряд опций:

<p>
<table border="1" width="100%" cellpadding="10">
<tr valign="top">
<td width="20%">
<code><b>COMPAT_43</code></b>
</td>
<td>
Самая старая из опций совместимости. Отвечает за поддержку ряда устаревших
ioctl'ей для терминальных устройств и других незначительных интерфейсов.
В настоящее время, в подавляющем большинстве случаев может быть опущена.
</td>
</tr>
<tr valign="top">
<td>
<code><b>COMPAT_O43</code></b>
</td>
<td>
Опции совместимости с соответствующей версией OpenBSD. Они вводились, когда
менялись интерфейсы ядра. Более подробно о том, для чего введены эти опции
написано в руководстве
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=options&amp;sektion=4">options(4)</a>.
</td>
</tr>
<tr valign="top">
<td> 
<code><b>COMPAT_AOUT</code></b>
</td>
<td>
Поддержка двоичных файлов, собранных для OpenBSD/i386 версий ниже 3.4 (т.е.
двоичные файлы формата <em>a.out</em>). Возможно будет необходимо также
включить опции совместимости с предыдущими версиями OpenBSD. Эмуляция
активизируется при включении опции <code><i>kern.emul.aout</i></code>.
</td>
</tr>
</table>

<a name="emul"></a>
<h3><font color="#0000e0">Двоичная совместимость с другими системами</font></h3>

<p>
OpenBSD поддерживает эмуляцию системных вызовов для некоторых систем.
Основным требованием является принадлежность двоичного файла и хостовой
системе к одной архитектуре. Например OpenBSD поддерживает исполняемые
файлы от Solaris, но программы, оттранслированные для архитектуры SPARC
не загрузятся на i386-совместимом процессоре.

<p>
Подсистемы эмуляции опциональны и при желании могут не включаться в ядро.

<p>
Рассмотрим опции двоичной совместимости, предоставляемые для архитектуры i386.
По умолчанию эмуляция всех систем является отключенной. Для активизации,
необходимо выставить соответствующий sysctl-флаг.

<p>
<table border="1" width="100%" cellpadding="10">
<tr valign="top">
<td width="20%">
<code><b>COMPAT_LINUX</code></b>
</td>
<td>
Поддержка запускаемых файлов ОС Linux. (Возможно придется так же установить
порт с библиотеками Linux системы,
<font color="#008000">/usr/ports/emulators/redhat/</font>). Эмуляция
активизируется при включении <code><i>kern.emul.linux</i></code>.
Подробную информацию можно получить из
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_linux&amp;sektion=8">страницы
руководства</a>. 
</td>
</tr>
<tr valign="top">
<td>
<code><b>COMPAT_FREEBSD</code></b>
</td>
<td>
Поддержка запускаемых файлов ОС FreeBSD. (Существует порт, содержащий
библиотеки FreeBSD,
<font color="#008000">/usr/ports/emulators/freebsd_lib/</font>). Эмуляция
активизируется при включении <code><i>kern.emul.freebsd</i></code>.
Подробную информацию можно получить из
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_freebsd&amp;sektion=8">страницы
руководства</a>.
</td>
</tr>
<tr valign="top">
<td>
<code><b>COMPAT_BSDOS</code></b><br>
<code><b>COMPAT_IBCS2</code></b><br>
<code><b>COMPAT_SVR4</code></b>
</td>
<td>
Поддержка запускаемых файлов систем BSDI, Solaris, SCO и др. Подробную
информацию можно найти в руководствах:
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_bsdos&amp;sektion=8">compat_bsdos(8)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_ibcs2&amp;sektion=8">compat_ibcs2(8)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_svr4&amp;sektion=8">compat_svr4(8)</a>.
</td>
</tr>
</table>

<p>
Если вы не используете двоичную совместимость с другими системами, настоятельно
рекомендуется не включать эмуляцию, поскольку история проекта уже насчитывает
ряд уязвимостей, выявленных в подсистеме эмуляции файлов iBCS2 и др.

<a name="xwindow"></a>
<h3><font color="#0000e0">X Window System</font></h3>

Для корректной работы X Window System необходимы или желательны следующие
опции (платформа i386):

<p>
<table border="1" width="100%" cellpadding="10">
<tr valign="top">
<td width="20%">
<code><b>APERTURE</code></b>
</td>
<td>
Драйвер апертуры ядра, позволяет X серверу получать прямой доступ к видео
памяти и регистрам PCI устройств. Непосредственное разрешение использования
апертуры ядра осуществляется через sysctl-переменную:
<code><i>machdep.allowaperture=2</i></code>.
</td>
</tr>
<tr valign="top">
<td>
<code><b>USER_PCICONF</code></b>
</td>
<td>
Предоставляет прикладным процессам (например, X серверу) возможность получения
доступа к конфигурации PCI устройств.
</td>
</tr>
<tr valign="top">
<td>
<code><b>PCIAGP</code></b>
</td>
<td>
Позволяет получать доступ X сервера к GART (Graphics Address Remapping Table).
</td>
</tr>
<tr valign="top">
<td>
<code><b>WSDISPLAY_COMPAT_RAWKBD</code></b><br>
<code><b>WSDISPLAY_COMPAT_PCVT</code></b>
</td>
<td>
Позволяет получить доступ к клавиатуре.
</td>
</tr>
</table>

<p>
На архитектуре i386 система X Window System может использовать регистры
атрибутов областей памяти,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mtrr&amp;sektion=4&amp;arch=i386">mtrr(4)</a>,
управляющих параметрами кэширования. Использование этого механизма теоретически
позволяет ускорить работу с видео подсистемой.

<a name="example"></a>
<h3><font color="#0000e0">Пример конфигурации ядра</font></h3>

<p>
Теперь приведем укороченный пример конфигурации ядра для маршрутизатора
на платформе i386 с поддержкой IPsec. Драйверы устройств опущены.

<pre>
<strong>
machine 	i386

maxusers	32

makeoptions	DEBUG="-g"

option		BOOT_CONFIG
option		PCIVERBOSE,USBVERBOSE

option		ACCOUNTING,CRYPTO,LKM
option		KTRACE,PTRACE
option		FIFO,SYSVMSG,SYSVSEM,SYSVSHM

option		WSDISPLAY_COMPAT_USL,WSDISPLAY_COMPAT_RAWKBD
option		WSDISPLAY_DEFAULTSCREENS=6,WSDISPLAY_COMPAT_PCVT
option		WS_KERNEL_FG=WSCOL_WHITE,WS_KERNEL_BG=WSCOL_BLACK

option		FFS,FFS2,MFS,FFS_SOFTUPDATES,UFS_DIRHASH
option		CD9660

option		INET,ALTQ,IPSEC
option		TCP_SACK,TCP_ECN,TCP_SIGNATURE
option		MROUTING

pseudo-device	pf
pseudo-device	pflog
pseudo-device	pfsync
pseudo-device	carp
pseudo-device	bpfilter
pseudo-device	loop
pseudo-device	enc
pseudo-device	gif
pseudo-device	gre
pseudo-device	tun
pseudo-device	vlan
pseudo-device	trunk

pseudo-device	ksyms
pseudo-device	systrace
pseudo-device	pty		16
pseudo-device	vnd		4
</strong>
</pre>

<p>
<hr>
<a href="index.html"><img height=24 width=24 src="../images/back.gif" border=0 alt="OpenBSD.ru"></a>
<a href="mailto:www@openbsd.ru">www@openbsd.ru</a>
<br>
<small>$RuOBSD: howto-kernconf.html,v 1.28 2007/10/06 15:35:11 form Exp $</small>

</body>
</html>
