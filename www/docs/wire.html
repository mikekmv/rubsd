<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=koi8-r">
<meta http-equiv="Content-Language" content="ru">
<meta name="copyright" content="Copyright (c) 2006 by OpenBSD.ru">
<title>Создание безопасной точки доступа беспроводной сети с помощью OpenBSD и OpenVPN</title>
</head>

<h2><font color="#e00000">Создание безопасной точки доступа беспроводной сети с помощью OpenBSD и OpenVPN</font></h2>
<hr>

Перевод выполнен Михаилом Сгибневым (msgibnev at gmail dot com), любые
комментарии и замечания просьба высылать автору перевода. Автор
<a href="http://software.newsforge.com/software/05/11/21/175249.shtml">
оригинального документа</a>: Манолис Тзанидакис.

<p>
Вы знаете, насколько беззащитны беспроводные сети стандартов 802.11x. В этой
статье мы создадим безопасную точку доступа на базе OpenBSD, что позволит
предотвратить несанкционированный доступ и шифровать трафик используя VPN
туннель. OpenBSD - одна из самых безопасных операционных систем, она удобна и
включает почти все, в чем вы нуждаетесь для реализации задуманного в поставке
по умолчанию. 

<p>
Если Вы плохо знакомы с OpenBSD, то советую вам посмотреть 
<a href="http://os.newsforge.com/os/05/11/01/1710223.shtml?tid=152">обзор 3.8</a> и 
<a href="http://www.openbsd.org/">сайт проекта</a>. Тоже самое относится к
<a href="http://www.openvpn.net/">OpenVPN</a>, также рекомендуюю просмотреть
нашу прошлую
<a href="http://software.newsforge.com/software/05/09/22/164231.shtml?tid=78">
статью</a>.

<p>
OpenBSD поддерживает широкий диапазон аппаратных платформ и для реализации
этого проекта совсем не обязательно мощной машины - мне хватает 166MHz Pentium,
также все хорошо работать на одноплатных компьютерах
<a href="http://www.soekris.com/">Soekris</a> и
<a href="http://www.pcengines.ch/wrap.htm">PC Engines WRAP</a>. Однако, если
предполагается одновременная работа большого числа клиентов, то придется
озаботиться установкой более мощного центрального процессора или платы
crypto-акселератора, подобно используемой в Soekris.

<p>
Для создания беспроводной сети можно использовать беспроводной адаптер из числа
поддерживаемых OpenBSD или, я рекомендую, использовать аппаратную точку
доступа, связанную с сервером кроссоверным кабелем. Если вы выбрали аппаратную
точку доступа, то учтите, что большинство из них предоставляют незащищенный
доступ к интерфейсу управления.   

<p>
Для конфигурирования беспроводного адаптера в OpenBSD просто создайте файл
<font color="#008000">/etc/hostname.ral0</font> (замените ral0 на ваше
устройство).

<blockquote><pre>
# /etc/hostname.ral0
inet 192.168.2.254 255.255.255.0 NONE media autoselect mediaopt hostap mode 11g nwid my_secure_wlan chan 11
</pre></blockquote>

<p>
И выполните с правами пользователя root следующую команду:

<blockquote><pre>
sh /etc/netstart ral0
</pre></blockquote>

<p>
Если вы никогда не устанавливали OpenBSD, то советуем прочитать
<a href="http://www.openbsd.org/faq/faq4.html">4 главу</a> превосходного FAQ.
Для нашей установки требуется минимальная инсталляция bsd:
<font color="#008000">base38.tgz</font> и <font color="#008000">etc38.tgz</font>
будет вполне достаточно, но не стесняйтесь устанавливать что-нибудь еще, если
оно вам нужно.

<p>
Для нашего VPN мы могли использовать реализацию OpenBSD IPsec (включенную в
основную систему), но мы будем использовать OpenVPN, так как эта схема легко
реализуется и на сервере и на большом числе клиентов, таких как *BSD, Linux,
Windows и Mac OS X. Программное обеспечение уже включено в порты OpenBSD,
поэтому берем прекомпилированный пакет и устанавливаем его.

<h2>Аутентификация и конфигурация пакетного фильтра</h2>

<p>
Для аутентификации беспроводных клиентов, соединяющихся с нашей точкой доступа,
мы будем использовать <a href="http://www.openssh.com/">OpenSSH</a> и пакетный
фильтр OpenBSD, pf(4), объединенный с authpf(8). Добавим в файл
<font color="#008000">/etc/ssh/sshd_config</font> конфигурации демона SSH
следущие строки:

<blockquote><pre>
Protocol 2
ClientAliveInterval 15
ClientAliveCountMax 3
PermitRootLogin no
StrictModes yes
MaxAuthTries 6
AllowUsers YOUR_USERNAMES_SPACE_SEPARATED 
</pre></blockquote>

<p>
Прежде чем прописать запуск sshd при начальной загрузке, убедитесь, что в файле
<font color="#008000">/etc/rc.conf.local</font> существует строка
"sshd_flags =". При необходимости, запустите sshd с правами пользователя root.

<p>
Наш сервер точки доступа имеет три интерфейса: ext_if, подключенный к Internet
(например к ADSL модему), int_if, соединенный с локальной сетью и wlan_if,
беспроводный интерфейс. Также есть виртуальный интерфейс, tun0, необходимый для
работы VPN. Удостоверьтесь, что вы заменили rl0, pppoe0 и ral0 в файлах
конфигурации на имена интерфейсов вашей системы.

<br><br>
<center><img src="../images/wire_figure1.png" border="0" alt="Схема"></center>

<p>
Теперь мы приступаем к конфигурированию нашего пакетного фильтра, 
<font color="#008000">/etc/pf.conf</font>. В нашей установке мы разрешаем 
беспроводной трафик, VPN и loopback, ограничивая доступ по SSH. Так же у нас
работает NAT на внешнем интерфейсе.

<blockquote><pre>
# /etc/pf.conf: pf configuration file.

# macros
ext_if = "pppoe0"
int_if = "rl0"
wlan_if = "ral0"
vpn_if = "tun0"
tcp_flags = "flags S/SA keep state"

# abusers table
table &lt;abusers> persist
# authpf table
table &lt;authpf_users> persist

# traffic normalization
scrub in all

# nat
nat on $ext_if from !($ext_if) -> ($ext_if:0)

# authpf
nat-anchor "authpf/*"
rdr-anchor "authpf/*"
binat-anchor "authpf/*"
anchor "authpf/*"

# block everything by default
block log all
# block everything from abusers table
block log quick from &lt;abusers>

# allow outgoing packets to the internet
pass out on $ext_if proto tcp all flags S/SA modulate state
pass out on $ext_if proto { udp, icmp } all keep state

# wireless interface (allow limited ssh to avoid brute-force attacks)
pass in quick on $wlan_if proto tcp to ($wlan_if) port ssh $tcp_flags (max-src-conn 10, \
<br>max-src-conn-rate 15/5, overload &lt;abusers> flush global)

# allow everything from wired lan, vpn and loopback
pass quick on { lo, $int_if, $vpn_if }

# antispoof protection for all interfaces
antispoof quick for { lo, $int_if, $wlan_if, $vpn_if }

# End of /etc/pf.conf 
</pre></blockquote>

<p>
Активируем пакетный фильтр командой:

<blockquote><pre>
pfctl -e -f /etc/pf.conf 
</pre></blockquote>

<p>
Для запуска фильтра на этапе начальной загрузки необходимо 
добавить следущие строки в файл <font color="#008000">/etc/rc.conf.local</font>:

<blockquote><pre>
pf=YES
pf_rules=/etc/pf.conf 
</pre></blockquote>

<p>
Для получения дополнительной информации по pf, обратитесь к страницам
руководства man pf(4), pf.conf(5) и pfctl(4),
<a href="http://www.openbsd.org/faq/pf/index.html">PF User Guide</a> и 
<a href="http://www.bgnett.no/~peter/pf/en/">Firewalling with OpenBSD's PF
packet filter</a>, включающее в себя руководство по authpf.

<p>
Выполните команду 

<blockquote><pre>
touch /etc/authpf/authpf.conf 
</pre></blockquote>

для того, чтобы создать пустой файл,необхо authpf, затем создаем 
<font color="#008000">/etc/authpf/authpf.rules</font>:

<blockquote><pre>
# /etc/authpf/authpf.rules: firewall rules for authenticated hosts.

# macros
wlan_if = ral0

# allow authenticated hosts to connect to openvpn daemon
pass in quick on $wlan_if proto udp from $user_ip to ($wlan_if) port 1194 keep state

# End of /etc/authpf/authpf.rules 
</pre></blockquote>

Чтобы добавить класс входа в систему для authpf, добавьте эти строки в
<font color="#008000">/etc/login.conf</font>:

<blockquote><pre>
authpf:\
:shell=/usr/sbin/authpf:\
:tc=default: 
</pre></blockquote>

Также необходимо добавить строку "/usr/sbin/authpf" в файл
<font color="#008000">/etc/shells</font>. Для получения дополнительной
информации обратитесь к страницам руководства login.conf(5) и chpass(1).

<p>
Теперь необходимо создать пользователей командой adduser, удостоверяясь, что
вы установили authpf в качестве оболочки и класс входа в систему. Также
необходимо добавить имя пользователя в строку AllowUsers файла
<font color="#008000">/etc/ssh/sshd_config</font>. Если вы разрешили SSH
подключения из Internet, то добавьте их в формате USER@WIRELESS_SUBNET:

<blockquote><pre>
AllowUsers roadwarrior@192.168.2.*
</pre></blockquote>

Если все работает должным образом, то соединившись с вашей точкой доступа с
беспроводного клиента, использующего OpenSSH или PuTTY, вы получите доступ к
OpenVPN, который мы сейчас настроим.

<h2>Конфигурация VPN</h2>

прежде, чем вы начнете, рекомендую прочесть
<a href="http://openvpn.net/howto.html">OpenVPN HOWTO</a>. Мы будем
использовать OpenVPN в bridged mode, соединяя беспроводной интерфейс с VPN
таким образом, чтобы для таких сервисов как Samba или CUPS шифрование трафика
проходило незаметно.

<p>
После установки OpenVPN из портов или пакетов OpenBSD, необходимо создать
сертификаты для сервера и клиентов. Выполните следующие команды с правами
пользователя root:

<blockquote><pre>
# mkdir -p /etc/openvpn/keys
# cp -r /usr/local/share/examples/openvpn/easy-rsa /etc/openvpn
# chown -R root:wheel /etc/openvpn
# chmod 700 /etc/openvpn/keys
# cd /etc/openvpn/easy-rsa
# . ./vars
# ./clean-all
# ./build-ca
# ./build-key-server server
# ./build-key client1
# ./build-key client2 etc.
# ./build-dh
# /usr/local/sbin/openvpn --genkey --secret ta.key
# cd keys
# mv ca.crt dh1024.pem server.crt server.key ta.key /etc/openvpn/keys
# chmod 644 /etc/openvpn/keys/{ca.crt,dh1024.pem,server.crt}
# chmod 600 /etc/openvpn/keys/{server.key,ta.key} 
</pre></blockquote>

Распространите среди клиентов на безопасных носителях файлы ca.crt,
clientXX.crt, clientXX.key и ta.key.

<p>
Создайте файл  <font color="#008000">/etc/openvpn/server.conf</font> следующего
содержания:

<blockquote><pre>
# /etc/openvpn/server.conf: OpenVPN server configuration

daemon openvpn
writepid /var/openvpn/pid
status /var/openvpn/status 10
local 192.168.2.254 # change to your wlan if's IP
port 1194
proto udp
dev tun0
dev-type tap
client-to-client
ca /etc/openvpn/keys/ca.crt
cert /etc/openvpn/keys/server.crt
key /etc/openvpn/keys/server.key
dh /etc/openvpn/keys/dh1024.pem
server-bridge 192.168.1.254 255.255.255.0 192.168.1.100 192.168.1.120 # change to your setup
ifconfig-pool-persist /var/openvpn/ipp.txt
push "redirect-gateway local def1"
keepalive 10 120
tls-auth /etc/openvpn/keys/ta.key 0
cipher BF-CBC # Blowfish (default)
max-clients 5
user _openvpn
group _openvpn
persist-key
persist-tun
verb 3
mute 20
chroot /var/empty

# End of /etc/openvpn/server.conf 
</pre></blockquote>

Теперь необходимо создать пользователя и группу _openvpn (с правами которого
будет запускаться демон), каталог /var/openvpn и интерфейс tun0, служащий
мостом между ним и беспроводной сетью.

<blockquote><pre>
# groupadd -g 500 _openvpn
# useradd -u 500 -g 500 -c 'OpenVPN Server' -s /sbin/nologin -d /var/openvpn -m _openvpn
# echo 'link0 up' > /etc/hostname.tun0
# echo -e 'add rl0\nadd tun0\nup' > /etc/bridgename.bridge0
# sh /etc/netstart tun0
# sh /etc/netstart bridge0 
</pre></blockquote>

Запустите OpenVPN командой: 

<blockquote><pre>
/usr/local/sbin/openvpn --config <font color="#008000">/etc/openvpn/server.conf</font> 
</pre></blockquote>

и добавьте следующие строки в <font color="#008000">/etc/rc.local</font>:

<blockquote><pre>
if [ -x /usr/local/sbin/openvpn ]; then
/usr/local/sbin/openvpn --config /etc/openvpn/server.conf
fi 
</pre></blockquote>

Проверьте файл <font color="#008000">/var/log/daemon</font> на наличие ошибок.
Их быть НЕ ДОЛЖНО! :-)

<p>
Теперь сконфигурируем нашего первого клиента, на базе Linux. Необходимо создать
каталог /etc/openvpn/keys, установить права пользователя и группы для OpenVPN,
скопировать туда сгенерированные ключи и создать
<font color="#008000">/etc/openvpn/client1.conf</font>:

<blockquote><pre>
# /etc/openvpn/client1.conf: OpenVPN client configuration

client
dev tap
proto udp
remote 192.168.2.254 1194 # replace with your access point's IP
resolv-retry infinite
nobind
user openvpn
group openvpn
persist-key
persist-tun
mute-replay-warnings
ca /etc/openvpn/keys/ca.crt
cert /etc/openvpn/keys/client1.crt
key /etc/openvpn/keys/client1.key
ns-cert-type server
tls-auth /etc/openvpn/keys/ta.key 1
cipher BF-CBC
verb 3
mute 20
chroot /var/empty

# End of /etc/openvpn/client1.conf 
</pre></blockquote>

Снова, проверьте <font color="#008000">/var/log/messages</font>, чтобы
удостовериться, что все - OK. Попробуйте выполнить команду

<blockquote><pre>
openvpn --config /etc/openvpn/client1.conf 
</pre></blockquote>

для того, чтобы соединиться с сервером. Воспользуйтесь утилитой ping для
проверки работоспособности соединения.

<p>
Необходимо убедиться в том, что весь беспроводной трафик шифруется, для этого
воспользуемся утилитой tcpdump:

<blockquote><pre>
# tcpdump -env -ttt -i ral0
tcpdump: listening on ral0, link-type EN10MB
Nov 15 21:01:28.865218 0:11:6b:34:91:59 0:e:35:e3:ff:51 0800 223: \
192.168.2.254.1194 > 192.168.2.1.32875: udp 181 (ttl 64, id 20205, len 209) 

# tcpdump -env -ttt -i tun0
tcpdump: WARNING: tun0: no IPv4 address assigned
tcpdump: listening on tun0, link-type EN10MB
Nov 15 21:05:46.569068 be:88:12:eb:0:4b 0:80:48:1d:e:28 0800 98: \
192.168.1.100 > 192.168.1.254: icmp: echo request (id:0926 seq:1) (DF) (ttl 64, id 0, len 84)
Nov 15 21:05:46.569375 0:80:48:1d:e:28 be:88:12:eb:0:4b 0800 98: \
192.168.1.254 > 192.168.1.100: icmp: echo reply (id:0926 seq:1) (DF) (ttl 255, id 44123, len 84) 
</pre></blockquote>

Если клиентская машина работает под управлением OpenBSD, замените "dev tap" на
"dev tun0 dev-type tap" в <font color="#008000">/etc/openvpn/client1.conf</font>.
Настройка Windows клиента аналогична настройке клиента Linux, но я рекомендую
почитать соответствующий раздел OpenVPN HOWTO.

<p>
Удачи!

<p>
<hr>
<a href="index.html"><img height=24 width=24 src="../images/back.gif" border=0 alt="OpenBSD.ru"></a>
<a href="mailto:www@openbsd.ru">www@openbsd.ru</a><br>
<small>$RuOBSD$</small>

</body>
</html>
