<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
<HEAD>
  <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=koi8-r">
  <META HTTP-EQUIV="Content-Language" CONTENT="ru">
  <META NAME="copyright" content="Copyright (c) 2004 by OpenBSD.ru">
  <TITLE>Настрока IPSec</TITLE>
</HEAD>

<BODY BGCOLOR="#ffffff" TEXT="#000000" LINK="#23238e">

<H2><FONT COLOR="#e00000">Настройка IPSec</FONT></H2>
<HR>

<UL>
  <LI><A HREF="#manual">Как настроить IPSec с фиксированными ключами</A>
  <LI><A HREF="#isakmpd">Как настроить ISAKMPD (IKE)</A>
  <LI><A HREF="#windows">Как связать OpenBSD и Windows</A>
</UL>
<HR>


<A NAME="manual">
<H3><FONT COLOR="#0000e0">Как настроить IPSec с фиксированными ключами</FONT></H3>

&nbsp; &nbsp; &nbsp; &nbsp;
В данном примере рассматривается настройка IPSec с фиксированными ключами.
Смотрите также вопрос <A HREF="#isakmpd">как настроить ISAKMPD (IKE)</A>.

<P>
Исходные данные:
хост <STRONG>A</STRONG> (адрес <STRONG>192.168.64.1</STRONG>),
хост <STRONG>B</STRONG> (адрес <STRONG>192.168.64.15</STRONG>).

<P>
Для настройки IPSec с фиксированными ключами, нам потребуется их сгенерировать.
Для этого следует выполнить следующие команды:

<STRONG>
<PRE>
# mkdir -m 700 /etc/ipsec
# openssl rand 24 | perl -pe 's/./unpack(&quot;H2&quot;,$&amp;)/ges' \
	> /etc/ipsec/esp-enc-key
# openssl rand 20 | perl -pe 's/./unpack(&quot;H2&quot;,$&amp;)/ges' \
	> /etc/ipsec/esp-auth-key
# chmod 600 /etc/ipsec/*
</PRE>
</STRONG>

В зависимости от выбранного алгоритма шифрования, число байт в первой команде
<FONT COLOR="#008000">openssl</FONT> должно быть следующим:
<FONT COLOR="#008000">DES</FONT> - 8, <FONT COLOR="#008000">3DES</FONT> - 24,
<FONT COLOR="#008000">AES</FONT> - переменное (рекомендуется 16),
<FONT COLOR="#008000">BLF</FONT> - переменное (рекомендуется 20),
<FONT COLOR="#008000">CAST</FONT> - переменное, максимум 16
(рекомендуется 16), <FONT COLOR="#008000">SKIPJACK</FONT> - 10.
<I>Использовать алгоритмы <FONT COLOR="#008000">DES</FONT> и
<FONT COLOR="#008000">SKIPJACK</FONT> не рекомендуется из-за их слабости.</I>

<P>
Далее нам понадобится файл <FONT COLOR="#008000">/usr/share/ipsec/rc.vpn</FONT>,
который следует скопировать в <FONT COLOR="#008000">/etc</FONT> и
отредактировать следующим образом:

<P>
Файл <FONT COLOR="#008000">/etc/rc.vpn</FONT> для хоста
<STRONG>A</STRONG>:

<STRONG>
<PRE>
# Эта строка должна быть закоментирована. Раскоментировав ее можно посмотреть
# какие команды выдает скрипт без реального их выполнения.
#DEBUG=echo

GW_LOCAL=192.168.64.1
GW_REMOTE=192.168.64.15

# В этих переменных можно перечислить через пробелы сети (в формате CIDR),
# которые находятся за каждой из сторон.
LOCAL_NETWORKS=&quot;&quot;
REMOTE_NETWORKS=&quot;&quot;

# Здесь можно выбрать алгоритмы шифрования и авторизации.
ENC=3des
AUTH=sha1

SPI_OUT=1000
SPI_IN=1001
KEYFILE=/etc/ipsec/esp-enc-key
AUTHKEYFILE=/etc/ipsec/esp-auth-key
</PRE>
</STRONG>

<P>
Файл <FONT COLOR="#008000">/etc/rc.vpn</FONT> для хоста
<STRONG>B</STRONG>:

<STRONG>
<PRE>
# Эта строка должна быть закоментирована. Раскоментировав ее можно посмотреть
# какие команды выдает скрипт без реального их выполнения.
#DEBUG=echo

GW_LOCAL=192.168.64.15
GW_REMOTE=192.168.64.1

# В этих переменных можно перечислить через пробелы сети (в формате CIDR),
# которые находятся за каждой из сторон.
LOCAL_NETWORKS=&quot;&quot;
REMOTE_NETWORKS=&quot;&quot;

# Здесь можно выбрать алгоритмы шифрования и авторизации.
ENC=3des
AUTH=sha1

SPI_OUT=1001
SPI_IN=1000
KEYFILE=/etc/ipsec/esp-enc-key
AUTHKEYFILE=/etc/ipsec/esp-auth-key
</PRE>
</STRONG>

Теперь достаточно запустить данные скрипты на каждом из хостов:

<STRONG>
<PRE>
# sh /etc/rc.vpn
</PRE>
</STRONG>

Для автоматического запуска добавьте следующую строку в
<FONT COLOR="#008000">/etc/rc.local</FONT>:

<STRONG>
<PRE>
[ -f /etc/rc.vpn ] && sh /etc/rc.vpn
</PRE>
</STRONG>

<P>
Смотрите также по данной теме:
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&sektion=8">ipsecadm(8)</A>,
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=vpn&sektion=8">vpn(8)</A>,
<FONT COLOR="#008000">/usr/share/ipsec/rc.vpn</FONT>.


<A NAME="isakmpd">
<H3><FONT COLOR="#0000e0">Как настроить ISAKMP (IKE)</FONT></H3>

&nbsp; &nbsp; &nbsp; &nbsp;
В данном примере рассматривается настройка IPSec для защиты трафика между
двумя хостами с использованием протокола обмена ключами ISAKMP
(<FONT COLOR="#008000">RFC 2407</FONT>, <FONT COLOR="#008000">RFC 2408</FONT>,
<FONT COLOR="#008000">RFC 2409</FONT>). Здесь рассматривается один
вариант настройки ISAKMP для защиты трафика между двумя хостами. Более
подробную информацию о других вариантах настройки можно получить по указанным
ниже ссылкам. Смотрите также вопрос
<A HREF="#manual">как настроить IPSec с фиксированными ключами</A>.


<P>
Создаем файл <FONT COLOR="#008000">/etc/isakmpd.policy</FONT> на каждом хосте.
Этот файл будет одинаковым для хостов <STRONG>A</STRONG> и <STRONG>B</STRONG>:

<STRONG>
<PRE>
KeyNote-Version: 2
Authorizer: &quot;POLICY&quot;
Licensees: &quot;passphrase:mekmitasdigoat&quot;
Conditions: app_domain == &quot;IPsec policy&quot; &&
            esp_present == &quot;yes&quot; &&
            esp_enc_alg == &quot;aes&quot; &&
            esp_auth_alg == &quot;hmac-sha&quot; -> &quot;true&quot;;
</PRE>
</STRONG>

Вместо &quot;mekmitasdigoat&quot; следует указать фразу, которая будет
использоваться в качестве ключа для установки соединения. Эта фраза должна
совпадать для хостов <STRONG>A</STRONG> и <STRONG>B</STRONG>. Далее нам
потребуется файлы <FONT COLOR="#008000">/etc/isakmpd.conf</FONT> для
каждого из хостов:

<STRONG>
<PRE>
[General]
Listen-on=		192.168.64.1
Shared-SADB=		Defined

[Phase 1]
192.168.64.15=		ISAKMP-peer-B
Default=		ISAKMP-peer-B-aggressive

[Phase 2]
Connections=		IPsec-A-B

[ISAKMP-peer-B]
Phase=			1
Transport=              udp
Local-address=		192.168.64.1
Address=		192.168.64.15
Configuration=		Default-main-mode
Authentication=		mekmitasdigoat

[ISAKMP-peer-B-aggressive]
Phase=			1
Transport=		udp
Local-address=		192.168.64.1
Address=		192.168.64.15
Configuration=		Default-aggressive-mode
Authentication=		mekmitasdigoat

[IPsec-A-B]
Phase=			2
ISAKMP-peer=		ISAKMP-peer-B
Configuration=		Default-quick-mode
Local-ID=		Net-A
Remote-ID=		Net-B

[Net-B]
ID-type=		IPV4_ADDR_SUBNET
Network=		192.168.64.15
Netmask=		255.255.255.255

[Net-A]
ID-type=		IPV4_ADDR_SUBNET
Network=		192.168.64.1
Netmask=		255.255.255.255

[Default-main-mode]
DOI=			IPSEC
EXCHANGE_TYPE=		ID_PROT
Transforms=		3DES-SHA

[Default-aggressive-mode]
DOI=			IPSEC
EXCHANGE_TYPE=		AGGRESSIVE
Transforms=		3DES-SHA-RSA

[Default-quick-mode]
DOI=			IPSEC
EXCHANGE_TYPE=		QUICK_MODE
Suites=			QM-ESP-AES-SHA-PFS-SUITE
</PRE>
</STRONG>

<P>
Файл <FONT COLOR="#008000">/etc/isakmpd.conf</FONT> для хоста
<STRONG>B</STRONG>:

<STRONG>
<PRE>
[General]
Listen-on=		192.168.64.15
Shared-SADB=		Defined

[Phase 1]
192.168.64.1=		ISAKMP-peer-A
Default=		ISAKMP-peer-A-aggressive

[Phase 2]
Connections=		IPsec-B-A

[ISAKMP-peer-A]
Phase=			1
Transport=		udp
Local-address=		192.168.64.15
Address=		192.168.64.1
Configuration=		Default-main-mode
Authentication=		mekmitasdigoat

[ISAKMP-peer-A-aggressive]
Phase=			1
Transport=		udp
Local-address=		192.168.64.15
Address=		192.168.64.1
Configuration=		Default-aggressive-mode
Authentication=		mekmitasdigoat

[IPsec-B-A]
Phase=			2
ISAKMP-peer=		ISAKMP-peer-A
Configuration=		Default-quick-mode
Local-ID=		Net-B
Remote-ID=		Net-A

[Net-B]
ID-type=		IPV4_ADDR_SUBNET
Network=		192.168.64.15
Netmask=		255.255.255.255

[Net-A]
ID-type=		IPV4_ADDR_SUBNET
Network=		192.168.64.1
Netmask=		255.255.255.255

[Default-main-mode]
DOI=			IPSEC
EXCHANGE_TYPE=		ID_PROT
Transforms=		3DES-SHA

[Default-aggressive-mode]
DOI=			IPSEC
EXCHANGE_TYPE=		AGGRESSIVE
Transforms=		3DES-SHA-RSA

[Default-quick-mode]
DOI=			IPSEC
EXCHANGE_TYPE=		QUICK_MODE
Suites=			QM-ESP-AES-SHA-PFS-SUITE
</PRE>
</STRONG>

Не забудьте установить права, запрещающие чтение файлов конфигурации isakmpd
простыми пользователями:

<STRONG>
<PRE>
# chmod 600 /etc/isakmpd/isakmpd.conf /etc/isakmpd/isakmpd.policy
</PRE>
</STRONG>

Теперь остается только запустить <FONT COLOR="#008000">isakmpd</FONT> на
каждом из хостов:

<STRONG>
<PRE>
# isakmpd -4
</PRE>
</STRONG>

Для автоматического запуска isakmpd следует отредактировать файл
<FONT COLOR="#008000">/etc/rc.conf</FONT> или
<FONT COLOR="#008000">/etc/rc.conf.local</FONT>:

<STRONG>
<PRE>   
isakmpd_flags=&quot;-4&quot;
</PRE>
</STRONG>

Для гарантии защиты трафика следует также добавить правила
<FONT COLOR="#008000">Packet Filter</FONT>, разрешающие трафик между данными
хостами только по протоколам <FONT COLOR="#008000">ESP</FONT> и
<FONT COLOR="#008000">UDP (порты источника и приемника 500)</FONT>.

<P>
Смотрите также по данной теме:
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd&sektion=5">isakmpd.conf(5)</A>,
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd.policy&sektion=5">isakmpd.policy(5)</A>,
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=isakmpd&sektion=8">isakmpd(8)</A>,
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=vpn&sektion=8">vpn(8)</A>,
<A HREF="http://www.openbsdsupport.org/vpn-ipsec.html">http://www.openbsdsupport.org/vpn-ipsec.html</A>,
<FONT COLOR="#008000">/usr/share/ipsec/isakmpd</FONT>.


<A NAME="windows">
<H3><FONT COLOR="#0000e0">Как связать OpenBSD и Windows</FONT></H3>

&nbsp; &nbsp; &nbsp; &nbsp;
В данном примере рассказывается как установить защищенное IPSec соединение
между OpenBSD и Microsoft Windows с использованием протокола ISAKMP. Пример
описывает соединение с Windows XP, однако тем же способом можно настроить
Windows 2000 (возможно с небольшими изменениями).

<P>
Исходные данные:
хост <STRONG>A</STRONG> (<STRONG>OpenBSD</STRONG>, адрес <STRONG>192.168.64.1</STRONG>),
хост <STRONG>B</STRONG> (<STRONG>Windows XP</STRONG>, адрес <STRONG>192.168.64.15</STRONG>).

<P>
Информацию о настройке <STRONG>OpenBSD</STRONG> хоста <STRONG>A</STRONG>
смотрите в описании вопроса <A HREF="#isakmpd">как настроить ISAKMPD (IKE)</A>.
Для настройки <STRONG>Windows XP</STRONG> хоста <STRONG>B</STRONG> выполните
следующие действия:

<UL>
  <LI>Запустите команду <FONT COLOR="#008000">mmc</FONT> из меню
    <FONT COLOR="#008000">Start</FONT> / <FONT COLOR="#008000">Run</FONT>
     панели задач.
  <LI>Выберите пункт меню <FONT COLOR="#008000">File</FONT> /
    <FONT COLOR="#008000">Add/Remove Snap-in...</FONT>
  <LI>Кликните кнопку <FONT COLOR="#008000">Add</FONT>, в открывшемся окне
    выберите пункт <FONT COLOR="#008000">IP Security Policy Management</FONT>
    и кликните кнопку <FONT COLOR="#008000">Add</FONT>
  <LI>Пройдите пошагово открывшийся wizard. При этом следует выбрать следующие
    настройки:
    <UL>
      <LI><FONT COLOR="#008000"><I>Select which computer or domain this snap-in
        will manage</I></FONT> - <FONT COLOR="#008000">Local computer</FONT>
    </UL>
  <LI>Выберите пункт меню <FONT COLOR="#008000">Action</FONT> /
    <FONT COLOR="#008000">Create IP Security Policy...</FONT>
  <LI>Пройдите открывшийся wizard. При этом ВЫКЛЮЧИТЕ следующую настройку:
    <UL>
      <LI><FONT COLOR="#008000"><I>Request for Secure Communication</I></FONT> -
        <FONT COLOR="#008000">Activate the default responce rule</FONT>
    </UL>
  <LI>При завершении wizardа, включите настройку:
    <UL>
      <LI><FONT COLOR="#008000"><I>Completing the IP Security wizard</I></FONT> -
      <FONT COLOR="#008000">Edit properties</FONT>
    </UL>
  <LI>В открывшемся окне кликните кнопку <FONT COLOR="#008000">Add</FONT>
  <LI>Пройдите открывшийся wizard, установите следующие настройки:
    <UL>
      <LI><FONT COLOR="#008000"><I>Tunnel Endpoint</I></FONT> -
        <FONT COLOR="#008000">This rule does not specify a tunnel</FONT>
      <LI><FONT COLOR="#008000"><I>Network Type</I></FONT> -
        <FONT COLOR="#008000">Local Area Network (LAN)</FONT>
      <LI><FONT COLOR="#008000"><I>Authentication Method</I></FONT> -
        <FONT COLOR="#008000">Use this string to protect the key exchange
        (preshared key)</FONT> - здесь введите ключевую фразу, которая
        использовалась при настройке OpenBSD хоста
      <LI><FONT COLOR="#008000"><I>IP Filter List</I></FONT> -
        кликните кнопку <FONT COLOR="#008000">Add</FONT>
      <LI>В открывшемся окне кликните кнопку <FONT COLOR="#008000">Add</FONT>
      <LI>Пройдите wizard, введите следующие настройки:
        <UL>
          <LI><FONT COLOR="#008000"><I>IP Traffic Source</I></FONT> -
            <FONT COLOR="#008000">My IP Address</FONT>
          <LI><FONT COLOR="#008000"><I>IP Traffic Destination</I></FONT> -
            <FONT COLOR="#008000">A Specific IP Address</FONT> -
            <FONT COLOR="#008000">192.168.64.1</FONT>
          <LI><FONT COLOR="#008000"><I>IP Protocol Type</I></FONT> -
            <FONT COLOR="#008000">Any</FONT>
        </UL>
      <LI>Выберите созданное правило и кликните кнопку
        <FONT COLOR="#008000">Next</FONT>
      <LI><FONT COLOR="#008000"><I>Filter Action</I></FONT> -
        <FONT COLOR="#008000">Require Security</FONT> - кликните кнопку
         <FONT COLOR="#008000">Edit</FONT>
      <LI>Установите следующие настройки:
        <UL>
          <LI><FONT COLOR="#008000">Negotiate security</FONT>
          <LI><FONT COLOR="#008000">Seccion key perfect forward secrecy (PFS)</FONT>
        </UL>
    </UL>
  <LI>Перезапустить сервис <FONT COLOR="#008000">IPSEC Services</FONT>
  <LI>В правом окне приложения <FONT COLOR="#008000">mmc</FONT> выберите
    созданное правило и кликните кнопку <FONT COLOR="#008000">Assign</FONT>
    в панели инструментов (поднятый вверх переключатель)
</UL>

Проверьте результат настройки командой <FONT COLOR="#008000">ping</FONT>
(на Windows хосте) - она должна ругнуться несколько раз
&quot;Negotiating IP Security&quot;, после чего все должно заработать.


<HR>
<A HREF="../index.html"><IMG HEIGHT="24" WIDTH="24" SRC="../../images/back.gif"
  BORDER="0" ALT="OpenBSD.ru"></A>
<A HREF="mailto:www@openbsd.ru">www@openbsd.ru</A><BR>
<SMALL>$RuOBSD: ipsec.html,v 1.7 2004/11/26 21:49:24 form Exp $</SMALL>

</BODY>
</HTML>
