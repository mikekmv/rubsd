<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
<HEAD>
  <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=koi8-r">
  <META HTTP-EQUIV="Content-Language" CONTENT="ru">
  <META NAME="copyright" content="Copyright (c) 2004 by OpenBSD.ru">
  <TITLE>Администрирование</TITLE>
</HEAD>

<BODY BGCOLOR="#ffffff" TEXT="#000000" LINK="#23238e">

<H2><FONT COLOR="#e00000">Администрирование</FONT></H2>
<HR>

<UL>
  <LI><A HREF="#conf">Зачем нужен файл /etc/rc.conf.local если
    есть /etc/rc.conf</A>
  <LI><A HREF="#wheel">Почему su говорит &quot;you are not in group wheel&quot;
    при попытке сменить права на root</A>
  <LI><A HREF="#fscopy">Как скопировать файловую систему</A>
  <LI><A HREF="#ftponly">Как создать учетную запись только для ftp</A>
  <LI><A HREF="#ftpchroot">Как ограничить пространство, доступное пользователю
    по FTP его домашним каталогом</A>
  <LI><A HREF="#hideproc">Как запретить пользователям смотреть чужие
    процессы</A>
  <LI><A HREF="#lkmperm">Почему при загрузке LKM выдается сообщение
    &quot;modload: can't reserve memory: Operation not permitted&quot;</A>
</UL>
<HR>


<A NAME="conf"></A>
<H3><FONT COLOR="#0000e0">Зачем нужен файл /etc/rc.conf.local если есть
  /etc/rc.conf</FONT></H3>

&nbsp; &nbsp; &nbsp; &nbsp;
Файл <FONT COLOR="#008000">/etc/rc.conf.local</FONT> используется для того,
чтобы изменить настройки по умолчанию (прописанные в
<FONT COLOR="#008000">/etc/rc.conf</FONT>). Использование отдельного файла
позволяет при обновлении системы просто заменить файл
<FONT COLOR="#008000">/etc/rc.conf</FONT> новым, сохранив при этом ранее
сделанные настройки.


<A NAME="wheel"></A>
<H3><FONT COLOR="#0000e0">Почему su говорит
  &quot;you are not in group wheel&quot; при попытке сменить права на root</FONT></H3>

&nbsp; &nbsp; &nbsp; &nbsp;
По умолчанию в BSD системах из соображений дополнительной защиты переход
на права <FONT COLOR="#008000">root</FONT> с помощью
<FONT COLOR="#008000">su</FONT> возможен только для пользователей, входящих
в группу <FONT COLOR="#008000">wheel</FONT>. При этом в OpenBSD в отличие
например от FreeBSD пользователь должен быть явно добавлен в группу в файле
<FONT COLOR="#008000">/etc/group</FONT>. Установки группы
<FONT COLOR="#008000">wheel</FONT> в качестве базовой группы недостаточно.
Можно также разрешить всем пользователям переход на права
<FONT COLOR="#008000">root</FONT>. Для этого достаточно удалить всех
пользователей (включая <FONT COLOR="#008000">root</FONT>) из группы
<FONT COLOR="#008000">wheel</FONT> в файле
<FONT COLOR="#008000">/etc/group</FONT>.


<A NAME="fscopy"></A>
<H3><FONT COLOR="#0000e0">Как скопировать файловую систему</FONT></H3>

&nbsp; &nbsp; &nbsp; &nbsp;
Для копирования файловой системы целиком лучше использовать команды
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=dump&amp;sektion=8">dump(8)</A>
и <A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=restore&amp;sektion=8">restore(8)</A>.
Если требуется скопировать только часть файловой системы следует воспользоваться
командой <A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=tar&amp;sektion=1">tar(1)</A>.
Ниже приведены примеры копирования файловой системы целиком и отдельной части
файловой системы.

<P>
Копируем /usr в раздел <FONT COLOR="#008000">g</FONT> диска
<FONT COLOR="#008000">wd1</FONT>:

<PRE>
<STRONG>
# newfs wd1g
# mount -o async /dev/wd1g /mnt
# dump 0f - /usr | (cd /mnt; restore rf -)
</STRONG>
</PRE>

В данном примере мы смонтировали новую файловую систему с опцией
<FONT COLOR="#008000">async</FONT> для ускорения копирования. Не забудьте
перемонтировать файловую систему без этой опции если планируется оставить ее
смонтированной во избежание потерь в случае сбоя.

<P>
Копируем /usr/src в каталог /mnt/usr:

<PRE>
<STRONG>
# cd /usr
# tar cf - src | (cd /mnt/usr; tar xpf -)
</STRONG>
</PRE>

При копировании небольших объемов информации для которых не требуется точного
сохранения структуры жестких ссылок и распределенного пространства под файлы
можно воспользоваться командой
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=cp&amp;sektion=1">cp(1)</A>:

<PRE>
<STRONG>
# cp -RPp mydir otherdir
</STRONG>
</PRE>


<A NAME="ftponly"></A>
<H3><FONT COLOR="#0000e0">Как создать учетную запись только для ftp</FONT></H3>

&nbsp; &nbsp; &nbsp; &nbsp;
Очень часто для решения данного вопроса пользователю устанавливают в качестве
shell что-нибудь вроде <FONT COLOR="#008000">/bin/false</FONT> и добавляют его
в <FONT COLOR="#008000">/etc/shells</FONT>. Такое решение является неверным
и очень часто бесполезным так как по сути позволяет пользователю поменять
shell с помощью файла <FONT COLOR="#008000">.forward</FONT> (если на хосте
запущен sendmail и не используется опция smrsh). Существуют также другие
соображения против такого решения. Не вдаваясь в подробности, предложим
другие варианты решения данного вопроса.

<P>
Чаще всего при разрешении доступа по FTP реальным пользователям, им
ограничивают доступное пространство домашним каталогом из соображений защиты
(см. вопрос <A HREF="#ftpchroot">как ограничить пространство, доступное
пользователю по FTP его домашним каталогом</A>).
В этом случае создание учетной записи только для ftp сводится к установке
пользователю <FONT COLOR="#008000">/sbin/nologin</FONT> в качестве shell и
добавление опции <FONT COLOR="#008000">-A</FONT> в командную строку запуска
ftpd в файле <FONT COLOR="#008000">/etc/inetd.conf</FONT> или в
<FONT COLOR="#008000">/etc/rc.conf.local</FONT> (если ftpd запускается как
самостоятельный сервер).

<P>
Другим решением вопроса может быть установка альтернативного FTP сервера,
который разрешает вход пользователям, независимо от установленного shell.
В OpenBSD портах в категории <FONT COLOR="#008000">net</FONT> есть
FTP сервер <FONT COLOR="#008000">vsftpd</FONT> который позволяет выключить
проверку shell для пользователя.

<P>
Еще одним вариантом решения вопроса может быть установка пользователю
обычного shell с одновременным добавлением в login класс для которого в
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=login.conf&amp;sektion=5">
login.conf(5)</A> shell переустанавливается на
<FONT COLOR="#008000">/sbin/nologin</FONT>.


<A NAME="ftpchroot"></A>
<H3><FONT COLOR="#0000e0">Как ограничить пространство, доступное пользователю
по FTP его домашним каталогом</FONT></H3>

&nbsp; &nbsp; &nbsp; &nbsp;
По умолчанию ftpd позволяет реальным пользователям перемещаться по всему
дереву каталогов системы. Чтобы ограничить доступное пространство домашним
каталогом пользователя достаточно добавить его имя в файл
<FONT COLOR="#008000">/etc/ftpchroot</FONT> или добавить пользователя в
login класс для которого установлена опция
<FONT COLOR="#008000">ftp-chroot</FONT>
(см. <A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=login.conf&amp;sektion=5">
login.conf(5)</A>).

<P>
Смотрите также вопрос
<A HREF="#ftponly">как создать учетную запись только для ftp</A>.


<A NAME="hideproc"></A>
<H3><FONT COLOR="#0000e0">Как запретить пользователям смотреть
чужие процессы</FONT></H3>

&nbsp; &nbsp; &nbsp; &nbsp;
Любой пользователь в системе может посмотреть список процессов с помощью
команды
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=ps&amp;sektion=1">ps(1)</A>.
Чтобы граничить просмотр процессами, работающими с правами пользователя,
подавшего команду можно воспользоваться загружаемым
модулем <FONT COLOR="#008000">hideproc</FONT>, который можно скачать
<A HREF="http://pdp-11.org.ru/~form/openbsd/">отсюда</A>.

<P>
Сначала следует собрать и установить модуль:

<PRE>
<STRONG>
# make depend &amp;&amp; make &amp;&amp; make install
</STRONG>
</PRE>

Помните что для сборки загружаемых модулей необходимы исходные тексты ядра
системы, которые должны находиться в <FONT COLOR="#008000">/usr/src/sys</FONT>.

<P>
Далее нужно добавить следующую строку в файл
<FONT COLOR="#008000">/etc/rc.securelevel</FONT>:

<PRE>
<STRONG>
[ -f /usr/lkm/hideproc.o ] &amp;&amp; modload /usr/lkm/hideproc.o
</STRONG>
</PRE>

По умолчанию модуль разрешает просмотр чужих процессов только для
пользователей, входящих в группу <FONT COLOR="#008000">wheel</FONT>.
Чтобы изменить настройки модуля добавьте в
<FONT COLOR="#008000">/etc/rc.local</FONT> следующие строки:

<PRE>
<STRONG>
#
# Пользователи, входящие в группу staff, имеют право смотреть чужие процессы.
#
if [ -c /dev/hideproc -a -x /usr/local/sbin/hideprocctl ]; then
	/usr/local/sbin/hideprocctl staff
fi
</STRONG>
</PRE>

Можно также задать обратное условие - запретить просмотр чужих процессов
пользователям, входящим в заданную группу:

<PRE>
<STRONG>
#
# Пользователи, входящие в группу users, не имеют права смотреть чужие процессы.
#
if [ -c /dev/hideproc -a -x /usr/local/sbin/hideprocctl ]; then
	/usr/local/sbin/hideprocctl \!users
fi
</STRONG>
</PRE>


<A NAME="lkmperm"></A>
<H3><FONT COLOR="#0000e0">Почему при загрузке LKM выдается сообщение
&quot;modload: can't reserve memory: Operation not permitted&quot;</FONT></H3>

&nbsp; &nbsp; &nbsp; &nbsp;
В BSD системах используется механизм уровней защиты ядра (securelevel).
По умолчанию OpenBSD работает на уровне защиты 1, не позволяющем загружать
или выгружать модули
(см.
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=securelevel&amp;sektion=7">
securelevel(7)</A>). Поэтому все команды загрузки LKM должны выполняться в
однопользовательском режиме или из файла
<FONT COLOR="#008000">/etc/rc.securelevel</FONT>. Если требуется часто
загружать и выгружать модули (например для отладки), можно отредактировать
<FONT COLOR="#008000">/etc/rc.securelevel</FONT>, запретив повышать
securelevel при загрузке:

<PRE>
<STRONG>
securelevel=-1
</STRONG>
</PRE>


<HR>
<A HREF="../index.html"><IMG HEIGHT="24" WIDTH="24" SRC="../../images/back.gif"
  BORDER="0" ALT="OpenBSD.ru"></A>
<A HREF="mailto:www@openbsd.ru">www@openbsd.ru</A><BR>
<SMALL>$RuOBSD: admin.html,v 1.9 2007/10/04 20:08:03 form Exp $</SMALL>

</BODY>
</HTML>
