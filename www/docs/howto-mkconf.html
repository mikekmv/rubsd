<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=koi8-r">
<meta http-equiv="Content-Language" content="ru">
<meta name="copyright" content="Copyright (c) 2000-2002 by OpenBSD.ru">
<title>Использование файла mk.conf</title>
</head>

<body bgcolor="#ffffff" text="#000000" link="#23238e">

<h2><font color="#e00000">Использование файла mk.conf</font></h2>
<hr>

<h3><font color="#0000e0">Зачем это надо?</font></h3>

<p>&nbsp; &nbsp; &nbsp; &nbsp;
Многие администраторы OpenBSD предпочитают собирать систему самостоятельно,
из исходных текстов, а также собирать и устанавливать packages из дерева
портов.  При этом часто используется файл <code>/etc/mk.conf</code>,
позволяющий указать, какие именно возможности требуются от системы.
Наиболее часто этот файл используется, чтобы отключить KerberosIV или
KerberosV, которые нужны довольно редко.  Но это далеко не единственная
область где возможно применения файла <code>mk.conf</code>.

<p>&nbsp; &nbsp; &nbsp; &nbsp;
Часто нам хочется включить в систему некоторые возможности, которые не
включены в системных компонентах, но поддерживаются этими компонентами
(например SMTP Authentication в sendmail).  Однако ставить для этого
данные компоненты &quot;вручную&quot; из исходных кодов неудобно:

<ol>
<li>То, что идёт с системой, лучше проверено именно с OpenBSD.
<li>После каждой пересборки системы, нужно следить, чтобы установленное
    &quot;вручную&quot; ПО продолжало работать в новой системе.
</ol>

<p>&nbsp; &nbsp; &nbsp; &nbsp;
Очень часто мы бываем недовольны некоторыми особенностями программ,
устанавливаемых из портов или просто хотим немного подправить
устанавливаемую программу под свои конкретные цели... Словом иногда
бывает ситуация когда есть потребность сделать что-то ради чего не стоит
беспокоить народ из ports@openbsd.org. :)

<p>
И здесь нам снова поможет <code>mk.conf</code>.
<h3><font color="#0000e0">Примеры использования mk.conf.</font></h3>

<p>&nbsp; &nbsp; &nbsp; &nbsp;
Рассмотрим некоторые варианты использования <code>mk.conf</code> на примере
набора для облегчения жизни <a href="../files/site.tar.gz">site.tar.gz</a>.
Данный набор состоит собственно из файла <code>mk.conf</code> и набора
патчей, используемых им в своих целях. Данный набор можно установить в
свою систему и дополнять по мере надобности. Для установки достаточно
скачать файл <a href="../files/site.tar.gz">site.tar.gz</a> и выполнить
следующие команды:

<pre>
	# cd /etc
	# tar xfz <путь-до-файла>/site.tar.gz
	# ln -sf site/mk.conf .
</pre>

<p>
Состав набора:

<table width="100%" border="0" cellpadding="0" cellspacing="5">
<tr>
  <td width="25%"><a href="../files/site/mk.conf">mk.conf</a></td>
  <td valign="top">Собственно файл mk.conf.</td>
</tr>
<tr>
  <td><a href="../files/site/patches/hypermail.patch">patches/hypermail.patch</a></td>
  <td valign="top">Патч для порта mail/hypermail, улучшающий spamprotect feature.</td>
</tr>
<tr>
  <td><a href="../files/site/patches/ipfm.patch">patches/ipfm.patch</a></td>
  <td valign="top">Патч для порта net/ipfm, позволяющий работать с несколькими
    сетевыми интерфейсами одновременно.</td>
</tr>
<tr>
  <td><a href="../files/site/patches/suexec.patch">patches/suexec.patch</a><br>
    <a href="../files/site/patches/suexec.sh">patches/suexec.sh</a>
  </td>
  <td valign="top">Патчики для suexec, позволяющие ему использовать login
    классы.</td>
</tr>
<tr>
  <td><a href="../files/site/patches/sylpheed-charset.patch">patches/sylpheed-charset.patch</a></td>
  <td valign="top">Патч для порта mail/sylpheed, довольно грубо решающий
    проблему отсутствия locale в OpenBSD. :)</td>
</tr>
</table>

<p>
После установки данного набора, остается только отредактировать файл mk.conf
и настроить его под свои нужды:

<p>
<pre>
# Настройки собираемой системы.
#
SKEY?=			Yes		# Включать поддержку S/Key
KERBEROS5?=		Yes		# Включать поддержку Kerberos V
YP?=			Yes		# Включать поддержку NIS
TCP_WRAPPERS?=		Yes		# Включать поддержку libwrap и tcpd
AFS?=			Yes		# Включать поддержку AFS
</pre>
<em>
Данные настройки определяют какие стандартные компоненты должны быть
включены в собираемую из исходных текстов систему.
</em>

<pre>
# Настройки suexec для хостинга
#
PATCH_SUEXEC?=		Yes		# Научить suexec понимать login.conf
SUEXEC_DOCROOT?=	/home/www	# Корневой каталог серверов
SETUID_SUEXEC?=		Yes		# Устанавливать как setuid
</pre>
<em>
Данные настройки определяют требуется ли поддержка login классов в
suexec, корневой каталог для документов с точки зрения suexec и следует
ли его устанавливать как setuid программу (необходимо если планируется
использование suexec).
</em>

<pre>
SENDMAIL_SASL?=		No		# Включить поддержку SASL или SASL2
SENDMAIL_LIBMILTER?=	No		# Включить поддержку libmilter
INSTALL_LIBMILTER?=	No		# Устанавливать libmilter
</pre>
<em>
Данные настройки определяют следует ли собирать sendmail с поддержкой SASL
или SASL2 для использование возможности авторизации SMTP (в системе должен
быть установлен порт security/cyrus-sasl или secuity/cyrus-sasl2 соответственно), а
также следует ли собирать включить поддержку Milter API и устанавливать
библиотеку libmilter (обычно требуется для почтовых антивирусных программ
и некоторых спам-фильтров).
</em>

<pre>
# Качать distfiles для портов сначала отсюда
#
MASTER_SITE_OVERRIDE?=	ftp://vell.nsc.ru/OpenBSD/distfiles/$DIST_SUBDIR}/ \
			ftp://pdp11.org.ru/pub/OpenBSD/distfiles/$DIST_SUBDIR}/
</pre>
<em>
Данная настройка позволяет указать сервера, которые должны просматриваться
в первую очередь в поисках distfiles для портов.
</em>

<pre>
PIPE?=			-pipe		# Использовать pipes вместо /tmp при
#					# компиляции
</pre>
<em>
Данная настройка заставляет gcc использовать unix pipes вместо временных
файлов в /tmp.
</em>

<pre>
SITEDIR?=		/etc/site	# Где все это лежит
BSDSRCDIR?=		/usr/src	# Где находится src
BSDOBJDIR?=		/usr/obj	# Где находится obj
PORTSDIR?=		/usr/ports	# Где находится ports
</pre>
<em>
Данный настройки указывают расположение исходных текстов системы, дерева
портов и других каталогов, используемых при сборке.
</em>

<pre>
# Научка GQmpeg конвертировать windows-1251 заголовки в koi8-r
#
.if ${.CURDIR} == ${PORTSDIR}/audio/gqmpeg
CONFIGURE_ARGS+=	--enable-russian
.endif
</pre>
<em>
Данный фрагмент включает автоматическую перекодировку заголовков MP3
файлов windows-1251 в koi8-r в программе GQMpeg, собираемой из порта
audio/gqmpeg.
</em>

<pre>
# Установка IRC сервера по умолчанию для BitchX и IrcII на pdp11.org.ru
#
.if ${.CURDIR} == ${PORTSDIR}/net/ircII || ${.CURDIR} == ${PORTSDIR}/net/bitchx
CONFIGURE_ARGS+=	--with-default-server=irc.pdp11.org.ru
.endif
</pre>
<em>
Данный фрагмент устанавливает IRC сервер поумолчанию для ircII и BitchX,
собираемых из портов net/ircII и net/bitchx соответственно.
</em>

<pre>
# Научка ipfm запускать несколько копий и создавать pidfile в виде
# /var/run/ipfm-<interface>.pid
#
.if ${.CURDIR} == ${PORTSDIR}/net/ipfm
post-patch:
	@${PATCH} ${PATCH_ARGS} < ${SITEDIR}/patches/ipfm.patch
.endif
</pre>
<em>
Данный фрагмент исправляет порт net/ipfm, добавляя в него поддержку
одновременной работы с несколькими сетевыми интерфейсами. При этом
PID файл будет создаваться в виде /var/run/ipfm-&lt;интерфейс&gt;.pid
</em>

<pre>
# Отучка courier-imap писать IPv4->IPv6 mapped адреса в логе (и от IPv6 :)
#
.if ${.CURDIR} == ${PORTSDIR}/mail/courier-imap
CONFIGURE_ARGS+=	--without-ipv6
.endif
</pre>
<em>
Данный фрагмент убирает из логов все что похоже на IPv6 для порта
mail/courier-imap.
</em>

<pre>
# Улучшение SPAM-protect feature в hypermail
#
.if ${.CURDIR} == ${PORTSDIR}/mail/hypermail
post-patch:
	@${ECHO_MSG} "===>  Applying SPAM-protect patch"
	@cd ${WRKSRC} && ${PATCH} -sp0 < ${SITEDIR}/patches/hypermail.patch
.endif
</pre>
<em>
Данный фрагмент улучшает spamprotect feature для порта mail.hypermail.
При этом вместо почтовых адресов в HTML документах будут фигурировать
только имя пользователя без указания почтового домена.
</em>

<pre>
# Грязный хак для sylpheed чтобы subject не поганил
#
.if ${.CURDIR} == ${PORTSDIR}/mail/sylpheed
post-patch:
	@${ECHO_MSG} "===>  Applying ugly charset hack"
	@cd ${WRKSRC} && ${PATCH} -sp0 < \
		${SITEDIR}/patches/sylpheed-charset.patch
.endif
</pre>
<em>
Данный фрагмент с помощью грубой физической силы заставляет порт
mail/sylpheed писать поле Subject по русски. Криво, но на безлокальи
сойдет. :)
</em>

<pre>
# Разборки с suexec
#
.if ${.CURDIR} == ${BSDSRCDIR}/usr.sbin/httpd && defined(PATCH_SUEXEC) \
    && ${PATCH_SUEXEC:U} == YES && exists(${SITEDIR}/patches/suexec.patch)
prereq:	${.OBJDIR}/config.status
	@if [ -L src/support/suexec.c ]; then \
		sh ${SITEDIR}/patches/suexec.sh ${SUEXEC_DOCROOT}; \
		echo "Patching suexec"; \
		rm -f src/support/suexec.c; \
		cp ${.CURDIR}/src/support/suexec.c src/support; \
		patch -sp0 < ${SITEDIR}/patches/suexec.patch; \
		rm -f src/support/suexec.c.orig; \
	fi
.endif

.if ${.CURDIR} == ${BSDSRCDIR}/usr.sbin && defined(SETUID_SUEXEC) && \
    ${SETUID_SUEXEC:U} == YES
afterinstall:
	@chmod u+s ${DESTDIR}/usr/sbin/suexec
.endif
</pre>
<em>
Данный фрагмент занимается разборками с suexec на тему вышеописанных настроек.
</em>

<pre>
# Разборки с sendmail
#
.if ${.CURDIR} == ${BSDSRCDIR}/gnu/usr.sbin/sendmail/sendmail && \
    exists(/usr/local/include/sasl/sasl.h) && \
    defined(SENDMAIL_SASL) && ${SENDMAIL_SASL:U} == YES
ENVDEF+=		-DSASL -I/usr/local/include/sasl
.if exists(/usr/local/lib/sasl2)
LDADD+=			-L/usr/local/lib -lsasl2
.else
LDADD+=			-L/usr/local/lib -lsasl
.endif
.endif

.if ${.CURDIR} == ${BSDSRCDIR}/gnu/usr.sbin/sendmail && \
    defined(SENDMAIL_LIBMILTER) && ${SENDMAIL_LIBMILTER:U} == YES
WANT_LIBMILTER=		1
.if !make(install)
SUBDIR:=		libmilter ${SUBDIR}
.elif defined(INSTALL_LIBMILTER) && ${INSTALL_LIBMILTER:U} == YES
SUBDIR:=		libsm libmilter ${SUBDIR} 

afterinstall:
	install -o ${BINOWN} -g ${BINGRP} -d ${DESTDIR}/usr/include/libmilter
	install -o ${BINOWN} -g ${BINGRP} -m ${NONBINMODE} \
		${.CURDIR}/include/libmilter/*.h \
		${DESTDIR}/usr/include/libmilter
.endif
.endif

.if (${.CURDIR} == ${BSDSRCDIR}/gnu/usr.sbin/sendmail/libmilter || \
    ${.CURDIR} == ${BSDSRCDIR}/gnu/usr.sbin/sendmail/sendmail) && \
    defined(SENDMAIL_LIBMILTER) && ${SENDMAIL_LIBMILTER:U} == YES
WANT_LIBMILTER=		1
.endif
</pre>
<em>
Разборки с sendmail на тему вышеописанных настроек.
</em>

<p>
<hr>
<a href="index.html"><img height=24 width=24 src="../images/back.gif" border=0 alt="OpenBSD.ru"></a>
<a href="mailto:www@openbsd.ru">www@openbsd.ru</a>
<br>
<small>$RuOBSD: howto-mkconf.html,v 1.19 2003/10/07 08:01:37 cruz Exp $</small>

</body>
</html>
