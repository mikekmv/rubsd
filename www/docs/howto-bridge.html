<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=koi8-r">
<meta http-equiv="Content-Language" content="ru">
<meta name="copyright" content="Copyright (c) 2000-2004 by OpenBSD.ru">
<title>Настройка Ethernet Bridge</title>
</head>

<body bgcolor="#ffffff" text="#000000" link="#23238e">

<h2><font color="#e00000">Настройка Ethernet Bridge</font></h2>
<hr>

Использование Ethwrnet Bridge позволяет объединить несколько сегментов
Ethernet в один логический сегмент. При этом допустимо использование
правил фильтрации pf, что позволяет превратить OpenBSD в прозрачный IP
фильтр.

<p>
Чтобы настроить OpenBSD в качестве Ethernet Bridge, нужно
выполнить следующие шаги:
<ol>
  <li>Сконфигурировать ядро OpenBSD, включив в него псевдо-устройство
  &quot;bridge&quot;. Файл конфигурации ядра должен содержать строку
  &quot;<strong>pseudo-device bridge</strong>&quot;.
  <li>Создать файл конфигурации <code>/etc/bridgename.bridge0</code>,
  содержащий команды конфигурации Bridge, например:
<pre>
	add rl0
	add fxp0
	up
</pre>
  В данном случае мы объявляем интерфейсы fxp0 и rl0 одним логическим
  Ethernet сегментом. Подробнее о командах конфигурирования Bridge
  можно прочитать в <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=brconfig&section=8">brconfig(8)</a>.
  При использовании нескольких логических сегментов, следует создать
  файл конфигурации для каждого псевдоустройства bridge.
  <p>
  <li>Создать файлы конфигурации сетевых интерфейсов:<br>
  <p><code>/etc/hostname.fxp0</code>:
<pre>
	inet 194.226.170.3 255.255.255.0 NONE media 100baseTX
</pre>
  <p><code>/etc/hostname.rl0</code>:
<pre>
	up media 100baseTX
</pre>
  Подробнее о файлах конфигурации сетевых интерфейсов можно прочитать в
  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hostname.if&section=5">hostname.if(5)</a>
  <p>
  Обратите внимание, что IP адрес присваивается только одному интерфейсу.
  Допускается также создание Bridge, не имеющего своего IP адреса.
  <p>
  <li>Перезагрузить машину.
</ol>

<p>
Ethernet Bridge также позволяет с помощью протокола Ethernet-over-IP
объединить в один логический сегмент сети, физически находящиеся далеко
друг от друга. Рассмотрим следующий пример:

<p>
<ul>
  <li>Хост <strong>A</strong>, адрес 81.1.212.10,
    внутренний интерфейс <strong>em0</strong>
  <li>Хост <strong>B</strong>, адрес 81.1.226.48,
    внутренний интерфейс <strong>rl0</strong>
</ul>

Чтобы объединить сегменты интерфейса <strong>em0</strong> хоста
<strong>A</strong> и <strong>rl0</strong> хоста <strong>B</strong>
в один логический Ethernet сегмент нужно подать следующие команды:

<p>
Для хоста <strong>A</strong>:
<pre>
	# sysctl -w net.inet.etherip.allow=1
	# ifconfig gif0 tunnel 81.1.212.10 81.1.226.48
	# ifconfig bridge0 create
	# brconfig bridge0 add em0 add gif0 up
</pre>

<p>
Для хоста <strong>B</strong>:
<pre>
	# sysctl -w net.inet.etherip.allow=1
	# ifconfig gif0 tunnel 81.1.226.48 81.1.212.10
	# ifconfig bridge0 create
	# brconfig bridge0 add rl0 add gif0 up
</pre>

<h3><font color="#0000e0">Замечания</font></h3>

<ul>
  <li>При использовании OpenBSD Packet Filter, пакет проходящий через
  Bridge попадает под проверку PF два раза, при входе на одном интерфейсе
  и при выходе на другом. Чтобы производить keep-state фильтрацию, нам
  необходимо разрешить все входящие и исходящие пакеты на одном
  интерфейсе, а на другом производить фильтрацию. Пример правил:
<pre>
	# фильтрация производится на rl0, поэтому пропускаем все пакеты на rl1
	pass in  quick on rl1 all
	pass out quick on rl1 all

	# по умолчанию мы блокируем все пакеты, и пропускаем только
	# icmp запросы с получившимися keep-state ответами в обе стороны.
	block in  on rl0 all
	block out on rl0 all
	pass in  on rl0 inet proto icmp all icmp-type echoreq keep state
	pass out on rl0 inet proto icmp all icmp-type echoreq keep state
</pre>
  <li>При использовании pf для фильтрации пакетов, проходящих через
  Bridge, действуют только правила для входящих пакетов.
  <li>Если во время работы Bridge, производится перенос какого-нибудь
  компьютера (или другого устройства, имеющего свой Ethernet адрес) с
  одного Ethernet сегмента на другой, следует выполнить команду
<pre>
	# <strong>brconfig bridge0 flush</strong>
</pre>
  (где bridge0 - псевдо-интерфейс Bridge, к которому относится Ethernet
  сегмент, в котором раньше находился компьютер).
</ul>

<p>
<hr>
<a href="index.html"><img height=24 width=24 src="../images/back.gif" border=0 alt="OpenBSD.ru"></a>
<a href="mailto:www@openbsd.ru">www@openbsd.ru</a><br>
<small>$RuOBSD: howto-bridge.html,v 1.15 2005/10/17 16:08:17 form Exp $</small>

</body>
</html>
