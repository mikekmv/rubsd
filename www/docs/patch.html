<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=koi8-r">
<meta http-equiv="Content-Language" content="ru">
<meta name="copyright" content="Copyright (c) 2006 by OpenBSD.ru">
<title>Наложение патчей обновления системы в OpenBSD</title>
</head>

<body bgcolor="#ffffff" text="#000000" link="#23238e">

<h2><font color="#e00000">Наложение патчей обновления системы в OpenBSD</font></h2>
<hr>

<p>
Перевод выполнен Михаилом Сгибневым (msgibnev at gmail dot com), любые
комментарии и замечания просьба высылать автору перевода. Автор оригинального
документа: Брайан Шонхорст.

<p>
В этом документе рассматривается методика наложения патчей, направленных на
исправление ошибок в OpenBSD. Эта статья предназначена для начального круга
читателей, тем, кому не хватает документации на
<a href="http://openbsd.org/">официальном сайте OpenBSD</a>. 

<p>
Наложение на систему патчей безопасности должно быть сделано сразу после
установки. Эти патчи закрывают бреши в системе безопасности, выявленные начиная
с момента выпуска системы. Будет хорошей идеей подписаться на список рассылки
<a href="http://openbsd.org/mail.html">security-announce</a>, для
своевременного получения уведомлений о выходе исправления.

<p>
Официальный список патчей, доступных для OpenBSD, можно найти на узле
<a href="http://openbsd.org/errata.html">Errata</a>. Последний релиз будет
отображен наряду со списком исправления для предыдущих версий. Вы должны будете
установить исправления, отмеченные как для всех архитектур, так и для конкретно
вашей (например, для i386 - это будет "i386 only" и "All architectures").

<p>
Нам потребуются две вещи: исходные тексты для обновления бинарных файлов (или
исходные тексты ОС полностью) и непосредственно сам патч.

<h2>Исходные тексты и бинарные файлы</h2>

<p>
В случае бинарных файлов не возможно внесение исправлений, так как они
находятся в нечитабельном для человека виде и могут быть использованы только
процессором. Вообще, довольно часто выполнимые программы идентифицируются как
двоичные файлы. Например ядро bsd или httpd.

<p>
Исходные тексты могут быть довольно легко прочитаны человеком, поскольку
соответствуют текстовому стандарту ASCII и обычно представляют собой программу,
написанную на одном из языков программирования (C, C++ и т.д). Для превращения
исходных текстов в бинарный вид необходимо провести процесс компиляции.

<p>
Наша задача заключается во внесении исправлений в исходный код программ,
содержащих ошибки, компиляции и установке исправленных версий.

<h2>Установка исходных текстов</h2>

<p>
Чтобы нам было что исправлять, необходимо получить эти самые исходные тексты.
В этом примере мы рассмотрим установку с
<a href="http://openbsd.org/orders.html">официального CD</a>. Для того, чтобы
узнать о других методах, обратитесь к
<a href="http://openbsd.org/faq/faq10.html#Patches">OpenBSD FAQ</a>.

<p>
Вставьте необходимый диск (в 3.4 это диск 3) и примонтируйте его. Нам необходим
архив <font color="#008000">src.tar.gz</font>.

<ul>
<code>
$ sudo mount /dev/cd0c /mnt
</code>
</ul>

<p>
Перейдите в каталог, в который вы хотите установить исходные тексты, и, если
это еще не так, добавьте имя своей учетной записи в группу wsrc, отредактировав
<font color="#008000">/etc/group</font>.

<ul>
<code>
$ cd /usr/src
</code>
</ul>

<p>
Распаковываем архив:

<ul>
<code>
$ sudo tar -xzvf /mnt/src.tar.gz
</code>
</ul>

<p>
Это потребует некоторого времени, после которого полный набор исходных текстов
системы будет установлен на ваш жесткий диск. После завершения процесса
компакт-диск можно отмонтировать.

<ul>
<code>
$ sudo umount /mnt
</code>
</ul>

<h2>Получение патчей</h2>

<p>
Теперь мы должны получить текущий набор исправлений. Вы можете получить их
через ftp или cvs, в нашем примере это будет ftp. Для получения файлов вы
можете выбрать ближайшее к вам зеркало. Они должны находиться в каталоге
<font color="#008000">/pub/OpenBSD/patches</font>. Удостоверьтесь, что
получаете файлы, соответствующие имеющейся у вас версии OpenBSD (в нашем
примере <font color="#008000">3.4.tar.gz</font>).

<ul>
<code>
$ cd /home/bschonho
<p>
$ ftp openbsdmirrorofyourchoice.com
</code>

<pre>
Name: anonymous
Pass: myemail
Logged in anonymously
ftp> cd patches/
ftp> get 3.4.tar.gz
Transfer completed
ftp> quit
</pre>
</ul>

<p>
Распаковываем:

<ul>
<code>
$ tar -xzvf 3.4.tar.gz
</code>
</ul>

<p>
В результате вы получите каталог <font color="#008000">3.4</font>, содержащий
исправления.

<h2>Наложение патчей</h2>

<p>
Наложение патчей заключается в наложении инструкций, находящихся в патче на
исправляемую программу. Так, если вы смотрите в папку исправлений 3.4 (или
иначе, в зависимости от устанавливаемой версии), вы должны увидеть папки для
различных архитектур и одну общую (common) папку. Все базовые системы
устанавливают общие исправления. В нашем случае первый патч устраняет
неточность в документации, поэтому для наглядности мы сразу перейдем ко
второму, где устраняется проблема безопасности OpenSSL.

<p>
Просмотрим его содержимое:

<ul>
<code>
$ less 3.4/common/002_asn1.patch
</code>
</ul>

<p>
Применяем:

<ul>
<code>
cd /usr/src
<p>
patch -p0 < 002_asn1.patch
</code>
</ul>

<p>
Пересобираем и устанавливаем OpenSSL:

<ul>
<code>
cd lib/libssl
<p>
make obj
<p>
make depend
<p>
make
<p>
make install
</code>
</ul>

Собственно, это и все, что необходимо знать. Учтите, что команда
<code>cd lib/libssl</code> подразумевает, что вы уже находитесь в каталоге
<font color="#008000">/usr/src</font>.

<p>
После того, как мы перешли в каталог <font color="#008000">/usr/src</font>,
применим патч, который находится в моем домашнем каталоге:

<ul>
<code>
$ sudo patch -p0 < /home/bschonho/3.4/common/002_asn1.patch
</code>
<pre>
Patching file lib/libssl/src/ssl/s3_srvr.c using Plan A...
Hunk #1 succeeded at 432.
Hunk #2 succeeded at 846.
Hunk #3 succeeded at 860.
Hunk #4 succeeded at 1358.
done
</pre>
</ul>

<p>
Выглядит неплохо! Исходный текст был исправлен. Теперь мы можем
перекомпилировать бинарные файлы для OpenSSL. Удостоверьтесь, что вы можете
использовать sudo, если вы не вошли как root. Некоторые из выполняемых команд
могут занять много времени (10 минут или больше), в зависимости от мощности
машины.

<ul>
<code>
$ cd lib/libssl
<p>
$ sudo make obj
</code>
<pre>
===> crypto
/usr/src/lib/libssl/crypto/obj -> /usr/obj/lib/libssl/crypto
===> ssl
/usr/src/lib/libssl/ssl/obj -> /usr/obj/lib/libssl/ssl
===> man
/usr/src/lib/libssl/man/obj -> /usr/obj/lib/libssl/man
</pre>

<code>
$ sudo make depend
</code>

<pre>
lib/libssl/ssl/../src/ssl/s3_pkt.c /usr/src/lib/libssl/ssl/../src/ssl/ssl_err.c 
/usr/src/lib/libssl/ssl/../src/ssl/t1_meth.c
===> man
</pre>

<code>
$ sudo make
</code>

<pre>
.cat3
( cd `dirname /usr/src/lib/libssl/man/../src/doc/ssl/ssl.pod` && pod2man --section=3 --official
--center='OpenSSL' --release="OpenBSD `uname -r`" `basename /usr/src/lib/libssl/man/../src/doc/ssl/ssl.pod` )
| nroff -Tascii -man > ssl.cat3
</pre>
</ul>

<p>
Устанавливаем новые файлы взамен старых:

<ul>
<code>
$ sudo make install
</code>

<pre>
/usr/share/man/cat3/lh_free.0 -> /usr/share/man/cat3/lhash.0
/usr/share/man/cat3/lh_insert.0 -> /usr/share/man/cat3/lhash.0
/usr/share/man/cat3/lh_new.0 -> /usr/share/man/cat3/lhash.0
/usr/share/man/cat3/lh_retrieve.0 -> /usr/share/man/cat3/lhash.0
</pre>
</ul>

Удостоверьтесь, что наложили все исправления, находящиеся в каталоге.
В результате применения патчей может потребоваться перезапуск некоторых
сервисов. Возможно, вам стоит прочитать статью по 
<a href="http://plumblossom.org/rebuildkernel.html">перекомпиляции ядра</a>.

<p>
<hr>
<a href="index.html"><img height=24 width=24 src="../images/back.gif" border=0 alt="OpenBSD.ru"></a>
<a href="mailto:www@openbsd.ru">www@openbsd.ru</a><br>
<small>$RuOBSD: patch.html,v 1.1 2006/02/11 17:47:14 andrey Exp $</small>

</body>
</html>
