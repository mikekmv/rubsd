# $RuOBSD: mk.conf,v 1.5 2003/11/17 06:39:25 form Exp $

# Настройки собираемой системы.
#
SKEY?=			Yes		# Включать поддержку S/Key
KERBEROS5?=		Yes		# Включать поддержку Kerberos V
YP?=			Yes		# Включать поддержку NIS
TCP_WRAPPERS?=		Yes		# Включать поддержку libwrap и tcpd
AFS?=			Yes		# Включать поддержку AFS

# Настройки suexec для хостинга
#
PATCH_SUEXEC?=		Yes		# Научить suexec понимать login.conf
SUEXEC_DOCROOT?=	/home/www	# Корневой каталог серверов
SETUID_SUEXEC?=		Yes		# Устанавливать как setuid

# Настройки сборки sendmail
#
SENDMAIL_SASL?=		No		# Включить поддержку SASL или SASL2
SENDMAIL_LIBMILTER?=	No		# Включить поддержку libmilter
INSTALL_LIBMILTER?=	No		# Устанавливать libmilter

# Другие хреновины
#
PATCH_MOUNT?=		No		# Патчить mount с целью слегка
#					# укоротить кое-какие надписи
PATCH_LOCALE?=		No		# Подпатчить libc на предмет LC_CTYPE
#					# дабы подружить ru XKB и X программы

# Качать distfiles для портов сначала отсюда
#
MASTER_SITE_OVERRIDE?=	ftp://vell.nsc.ru/OpenBSD/distfiles/$DIST_SUBDIR}/ \
			ftp://pdp11.org.ru/pub/OpenBSD/distfiles/$DIST_SUBDIR}/

PIPE?=			-pipe		# Использовать pipes вместо /tmp при
#					# компиляции

SITEDIR?=		/etc/site	# Где все это лежит
BSDSRCDIR?=		/usr/src	# Где находится src
BSDOBJDIR?=		/usr/obj	# Где находится obj
PORTSDIR?=		/usr/ports	# Где находится ports

# Научка GQmpeg конвертировать windows-1251 заголовки в koi8-r
#
.if ${.CURDIR} == ${PORTSDIR}/audio/gqmpeg
CONFIGURE_ARGS+=	--enable-russian
.endif

# Установка IRC сервера по умолчанию для BitchX и IrcII на pdp11.org.ru
#
.if ${.CURDIR} == ${PORTSDIR}/net/ircII || ${.CURDIR} == ${PORTSDIR}/net/bitchx
CONFIGURE_ARGS+=	--with-default-server=irc.pdp11.org.ru
.endif

# Научка ipfm запускать несколько копий и создавать pidfile в виде
# /var/run/ipfm-<interface>.pid
#
.if ${.CURDIR} == ${PORTSDIR}/net/ipfm
post-patch:
	@${PATCH} ${PATCH_ARGS} < ${SITEDIR}/patches/ipfm.patch
.endif

# Отучка courier-imap писать IPv4->IPv6 mapped адреса в логе (и от IPv6 :)
#
.if ${.CURDIR} == ${PORTSDIR}/mail/courier-imap
CONFIGURE_ARGS+=	--without-ipv6
.endif

# Улучшение SPAM-protect feature в hypermail
#
.if ${.CURDIR} == ${PORTSDIR}/mail/hypermail
post-patch:
	@${ECHO_MSG} "===>  Applying SPAM-protect patch"
	@cd ${WRKSRC} && ${PATCH} -sp0 < ${SITEDIR}/patches/hypermail.patch
.endif

# Грязный хак для sylpheed чтобы subject не поганил
#
.if ${.CURDIR} == ${PORTSDIR}/mail/sylpheed
post-patch:
	@${ECHO_MSG} "===>  Applying ugly charset hack"
	@cd ${WRKSRC} && ${PATCH} -sp0 < \
		${SITEDIR}/patches/sylpheed-charset.patch
.endif

# Разборки с suexec
#
.if ${.CURDIR} == ${BSDSRCDIR}/usr.sbin/httpd && defined(PATCH_SUEXEC) \
    && ${PATCH_SUEXEC:U} == YES && exists(${SITEDIR}/patches/suexec.patch)
prereq:	${.OBJDIR}/config.status
	@if [ -L src/support/suexec.c ]; then \
		echo "Patching suexec"; \
		sh ${SITEDIR}/patches/suexec.sh ${SUEXEC_DOCROOT}; \
#
# Закоментированное нужно только для OpenBSD < 3.4.
#
#		rm -f src/support/suexec.c; \
#		cp ${.CURDIR}/src/support/suexec.c src/support; \
#		patch -sp0 < ${SITEDIR}/patches/suexec.patch; \
#		rm -f src/support/suexec.c.orig; \
	fi
.endif

.if ${.CURDIR} == ${BSDSRCDIR}/usr.sbin && defined(SETUID_SUEXEC) && \
    ${SETUID_SUEXEC:U} == YES
afterinstall:
	@chmod u+s ${DESTDIR}/usr/sbin/suexec
.endif

# Разборки с sendmail
#
.if ${.CURDIR} == ${BSDSRCDIR}/gnu/usr.sbin/sendmail/sendmail && \
    exists(/usr/local/include/sasl/sasl.h) && \
    defined(SENDMAIL_SASL) && ${SENDMAIL_SASL:U} == YES
ENVDEF+=		-DSASL -I/usr/local/include/sasl
.if exists(/usr/local/lib/sasl2)
LDADD+=			-L/usr/local/lib -lsasl2
.else
LDADD+=			-L/usr/local/lib -lsasl
.endif
.endif

.if ${.CURDIR} == ${BSDSRCDIR}/gnu/usr.sbin/sendmail && \
    defined(SENDMAIL_LIBMILTER) && ${SENDMAIL_LIBMILTER:U} == YES
WANT_LIBMILTER=		1
.if !make(install)
SUBDIR:=		libmilter ${SUBDIR}
.elif defined(INSTALL_LIBMILTER) && ${INSTALL_LIBMILTER:U} == YES
SUBDIR:=		libsm libmilter ${SUBDIR} 

afterinstall:
	install -o ${BINOWN} -g ${BINGRP} -d ${DESTDIR}/usr/include/libmilter
	install -o ${BINOWN} -g ${BINGRP} -m ${NONBINMODE} \
		${.CURDIR}/include/libmilter/*.h \
		${DESTDIR}/usr/include/libmilter
.endif
.endif

.if (${.CURDIR} == ${BSDSRCDIR}/gnu/usr.sbin/sendmail/libmilter || \
    ${.CURDIR} == ${BSDSRCDIR}/gnu/usr.sbin/sendmail/sendmail) && \
    defined(SENDMAIL_LIBMILTER) && ${SENDMAIL_LIBMILTER:U} == YES
WANT_LIBMILTER=		1
.endif

# Разборки с mount
#
.if ${.CURDIR} == ${BSDSRCDIR}/sbin/mount && defined(PATCH_MOUNT) && \
    ${PATCH_MOUNT:U} == YES && ${.CURDIR} != ${.OBJDIR}
CFLAGS+=		-I${.CURDIR}
CLEANFILES+=		mount.c

beforedepend:
.if !defined(SITE_REENTER)
	@cp ${.CURDIR}/mount.c ${.OBJDIR} && cd ${.OBJDIR} && \
	    patch -sp0 < ${SITEDIR}/patches/mount.patch && \
	    rm -f mount.c.orig && cd ${.CURDIR} && \
	    ${MAKE} depend SITE_REENTER=Yes
.endif
.endif

# Разборки с локалью
#
.if ${.CURDIR} == ${BSDSRCDIR}/lib/libc && defined(PATCH_LOCALE) && \
    ${PATCH_LOCALE:U} == YES && ${.CURDIR} != ${.OBJDIR}
CLEANFILES+=            setlocale.c ctype_.c tolower_.c toupper_.c

beforedepend:
.if !defined(SITE_REENTER)
	@cp ${.CURDIR}/locale/setlocale.c ${.CURDIR}/gen/ctype_.c \
	    ${.CURDIR}/gen/tolower_.c ${.CURDIR}/gen/toupper_.c ${.OBJDIR} && \
	    cd ${.OBJDIR} && \
	    patch -sp0 < ${SITEDIR}/patches/locale-hack.patch && \
	    rm -f setlocale.c.orig ctype_.c.orig tolower_.c.orig \
		toupper_.c.orig && cd ${.CURDIR} && \
	    ${MAKE} depend SITE_REENTER=Yes
.endif
.endif
