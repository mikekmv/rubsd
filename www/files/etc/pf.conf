# $RuOBSD: pf.conf,v 1.13 2007/04/25 15:07:28 form Exp $
#
# Пример настройки PF для маршрутизатора с трансляцией адресов и
# переадресацией некоторых сервисов во внутреннюю сеть.
#
# Данный пример написан для OpenBSD 4.1 и более новых версий. В старых
# версиях системы нужно добавить "flags S/SA keep state" в pass правила
# с "proto tcp" и "keep state" в остальные pass правила.
#
#   WAN              LAN
#    |      +------------+--------
#    |      |            |
# +-xl0----xl1-+  +--------------+
# |            |  |  10.10.10.2  |
# +------------+  +--------------+


# Внешний и внутренний интерфейсы.
#
ext_if		= "xl0"
int_if		= "xl1"

# TCP/UDP сервисы, обслуживаемые маршрутизатором.
#
tcp_svc		= "ftp ssh domain www https imaps"
udp_svc		= "domain"

# TCP сервисы, обслуживаемые внутренним сервером.
#
tcp_rdr		= "3389"
host_rdr	= "10.10.10.2"

# Хосты, с которыми устанавливаются IPSec тунели.
#
ipsec_peers	= "85.118.226.101 85.118.228.60 89.31.114.53"


# Таблицы белого списка spamd и сетей, не пропускаемых напрямую к
# почтовому серверу.
#
table <spamd-white> persist
table <spamd-bypass> file "/etc/mail/spamd.bypass"

# Черный список адресов (заполняется из sshwatchd или другой программы).
#
table <blocked> persist

# Таблица сетей, доступных через IPSec тунели.
#
table <ipsec-networks> const {	\
	10.0.0.0/24		\
	10.1.0.0/24		\
	10.11.10.0/24		\
	10.11.12.0/24		\
}


# Выключить фильтрацию для loopback и IPsec.
#
set skip on { lo enc0 }


# Выполнить нормализацию всех пакетов.
#
scrub in


# Транслировать внутренние адреса в (основной) адрес внешнего интерфейса.
#
nat on $ext_if from !($ext_if) -> ($ext_if:0)

# Отключить переадресацию для адресов из черного списка.
#
no rdr on $ext_if from <blocked>

# Подключить nat/rdr правила, создаваемые ftp-proxy.
#
nat-anchor "ftp-proxy/*"
rdr-anchor "ftp-proxy/*"

# Пропустить FTP через transparent proxy кроме локального сервера и
# сетей, доступных через IPSec тунели.
#
no rdr on $int_if inet proto tcp to <ipsec-networks> port ftp
rdr on $int_if inet proto tcp to !(self) port ftp -> 127.0.0.1 port 8021

# Перенаправить входящие SMTP сессии в spamd для проверки по greylist.
#
no rdr on $ext_if inet proto tcp from <spamd-bypass> to port smtp
rdr pass on $int_if inet proto tcp from !<spamd-white> to ($ext_if) port smtp \
	-> 127.0.0.1 port spamd

# Переадресовать TCP сервисы, обслуживаемые внутренним сервером.
#
rdr pass on $ext_if inet proto tcp to ($ext_if) port { $tcp_rdr } -> $host_rdr

# Разрешить обращение к переадресованым TCP сервисам из локальной сети.
#
rdr pass on $int_if inet proto tcp to ($ext_if) port { $tcp_rdr } tag LANRDR \
	-> $host_rdr
nat on $int_if tagged LANRDR -> ($int_if:0)


# Защита от IP spoofing.
#
antispoof quick for ($int_if)

# Подключить правила, создаваемые ftp-proxy (для OpenBSD 3.9 и новее).
#
anchor "ftp-proxy/*"

# По умолчанию блокировать все на внешнем интерфейсе. Для входящих
# TCP соединений возвращать RST. Блокировать трафик для адресов из черного
# списка.
#
block log on $ext_if
block return-rst in log on $ext_if inet proto tcp
block in quick on $ext_if from <blocked>

# Разрешить исходящий трафик.
#
pass out on $ext_if inet

# Разрешить входящие ICMP ping'и.
#
pass in on $ext_if inet proto icmp to ($ext_if) icmp-type echoreq code 0

# Разрешить подключения к TCP сервисам.
#
pass in on $ext_if inet proto tcp to ($ext_if) port { $tcp_svc }

# Разрешить SMTP сессии для адресов, прошедший проверку на greylisting.
#
pass in log on $ext_if inet proto tcp to ($ext_if) port smtp

# Разрешить обращение к UDP сервисам.
#
pass in on $ext_if inet proto udp to ($ext_if) port { $udp_svc }

# Разрешить IPSec трафик.
#
pass in on $ext_if inet proto udp from { $ipsec_peers } to ($ext_if) \
	port isakmp
pass in on $ext_if inet proto esp from { $ipsec_peers } to ($ext_if)

# Разрешить входящие TCP соединения для активных ftp сессий,
# инициируемых с маршрутизатора.
#
#pass in on $ext_if inet proto tcp to ($ext_if) port > 49151 user >= 0

# Разрешить входящие TCP соединения для FTP сервера (passive mode).
# Правило рассчитано на то, что FTP сервер обслуживает только anonymous
# подключения. Если планируется использовать FTP сервер для подключения
# реальных пользователей, следует заменить "user ftp" на "user >= 0".
#
pass in on $ext_if inet proto tcp to ($ext_if) port > 49151 user ftp
