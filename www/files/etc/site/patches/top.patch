$RuOBSD: top.patch,v 1.1 2005/03/30 05:30:32 form Exp $

--- display.c.orig	Sun Jun 19 00:35:03 2005
+++ display.c	Sun Jun 19 00:36:58 2005
@@ -51,11 +51,13 @@
 #include <stdio.h>
 #include <ctype.h>
 #include <err.h>
+#include <math.h>
 #include <stdlib.h>
 #include <string.h>
 #include <signal.h>
 #include <term.h>
 #include <time.h>
+#include <tzfile.h>
 #include <unistd.h>
 #include <stdarg.h>
 
@@ -248,6 +250,34 @@
 	/* we should optimize this and only display changes */
 	for (i = 0; i < 3; i++)
 		printf("%s%5.2f", i == 0 ? "" : ", ", avenrun[i]);
+}
+
+void
+i_uptime(struct timeval* bt, time_t *tod)
+{
+	time_t uptime;
+	int days, hrs, mins, secs;
+
+	if (bt->tv_sec != -1) {
+		uptime = *tod - bt->tv_sec;
+		uptime += 30;
+		days = uptime / SECSPERDAY;
+		uptime %= SECSPERDAY;
+		hrs = uptime / SECSPERHOUR;
+		uptime %= SECSPERHOUR;
+		mins = uptime / SECSPERMIN;
+		secs = uptime % SECSPERMIN;
+
+		/*
+		 *  Display the uptime.
+		 */
+		if (smart_terminal)
+			Move_to((screen_width - 24) - (days == 0 ? 0 :
+			    (int)log10f((float)days)), 0);
+		else
+			fputs(" ", stdout);
+		printf(" up %d+%02d:%02d:%02d", days, hrs, mins, secs);
+	}
 }
 
 /*
--- machine.c.orig	Sun Jun 19 00:35:03 2005
+++ machine.c	Sun Jun 19 00:38:14 2005
@@ -232,6 +232,7 @@
 {
 	static int sysload_mib[] = {CTL_VM, VM_LOADAVG};
 	static int vmtotal_mib[] = {CTL_VM, VM_METER};
+	static int boottime_mib[] = {CTL_KERN, KERN_BOOTTIME};
 	struct loadavg sysload;
 	struct vmtotal vmtotal;
 	double *infoloadp;
@@ -295,6 +296,10 @@
 	si->cpustates = cpu_states;
 	si->memory = memory_stats;
 	si->last_pid = -1;
+
+	size = sizeof(si->boottime);
+	if (sysctl(boottime_mib, 2, &si->boottime, &size, NULL, 0) < 0)
+		si->boottime.tv_sec = -1;
 }
 
 static struct handle handle;
--- machine.h.orig	Sun Jun 19 00:35:03 2005
+++ machine.h	Sun Jun 19 00:35:03 2005
@@ -57,6 +57,7 @@
 	int            *procstates;
 	int64_t        *cpustates;
 	int            *memory;
+	struct timeval	boottime;
 };
 
 /*
--- top.c.orig	Sun Jun 19 00:35:03 2005
+++ top.c	Sun Jun 19 00:35:03 2005
@@ -412,9 +412,10 @@
 		/* display the load averages */
 		(*d_loadave)(system_info.last_pid, system_info.load_avg);
 
-		/* display the current time */
+		/* display the current time and uptime */
 		/* this method of getting the time SHOULD be fairly portable */
 		time(&curr_time);
+		i_uptime(&system_info.boottime, &curr_time);
 		i_timeofday(&curr_time);
 
 		/* display process state breakdown */
