<html>
<head>
<meta http-equiv= "Content-type" content= "text/html; charset=koi8-r">
<title>10.0 - Системное Администрирование</title>
<link rev= "made" href= "mailto:www@openbsd.ru">
<meta name= "resource-type" content= "document">
<meta name= "description"   content= "страница OpenBSD FAQ">
<meta name= "keywords"      content= "openbsd,faq">
<meta name= "distribution"  content= "global">
<meta name= "copyright"     content= "This document copyright 1998,1999 by OpenBSD.">
</head>

<body bgcolor= "#ffffff" text= "#000000" link= "#23238E">

<img alt="[OpenBSD]" height=30 width=141 src="../../images/smalltitle.gif">
<p>
<h2><font color=#e00000>10.0 - Системное Администрирование</font><hr></h2>
</p>

<p>
<ul><h3>Содержание</h3>
<li><a href="faq10.html#10.1">
10.1 - Я пытаюсь выполнить su (чтобы получить права root), но получаю
сообщение, что я не принадлежу нужной группе. Почему ?
</a></li>
<li><A HREF="faq10.html#10.2">10.2 - Как сдублировать раздел (файловую 
систему) ?</A></li>
<li><A HREF="faq10.html#10.3">10.3 - Как сделать, чтобы демоны
запускались при старте системы ? (Обзор rc(8))</A></li>
<li><a href="faq10.html#10.4">10.4 - Почему пользовательская почта не
проходит релеингом (relaying) через мою систему OpenBSD ?</a></li>
<li><a href="faq10.html#10.5">10.5 - Я настроил POP, но все равно не
могу получить почту. Что я могу сделать ?</a></li>
<li><a href="faq10.html#10.6">10.6 - Настройка безопасного
HTTP-сервера (веб-сервера) с использованием SSL(8)</a></li>
<li><a href="faq10.html#10.7">10.7 - Я изменил /etc/passwd редактором
vi(1), но все как было, так и осталось ... Почему ?</a></li>
<li><a href="faq10.html#10.8">10.8 - Как добавить пользователя ? и как
удалить ?</a></li>
<li><a href="faq10.html#10.9">10.9 - Как зарегистрировать пользователя
только для FTP (не анонимного !) ?</a></li>
<li><a href="faq10.html#10.10">10.10 - Установка дисковых квот (quota) для
пользователей.</a></li>
<li><a href="faq10.html#10.11">10.11 - Настройка клиента/сервера Kerberos
(не переведено).
</a></li>
<li><a href="faq10.html#10.12">10.12 - Настрока анонимного FTP-сервера.
</a></li>
<li><a href="faq10.html#10.13">10.13 - Ограничение пользователей
FTP их домашними каталогами (ftpd(8)).</a>
<li><a href="faq10.html#10.14">10.14 - Использование патчей (patch)
OpenBSD.</a>
</ul>
</p> 
<hr>

<br>

<p>
<a name= "10.1">
<h2>10.1 - Я пытаюсь выполнить su (чтобы получить права root), но получаю
сообщение, что я не принадлежу нужной группе. Почему ?</h2>
</a>
</p>

<p>
Существующие пользователи должны добавляться в группу 
<kbd>&quot;wheel&quot;</kbd> руками. Это сделано из соображений безопасности.
Вы должны быть осторожны, добавляя пользователей в эту группу,
потому, что в OpenBSD члены группы <kbd>&quot;wheel&quot;</kbd>, 
могут получить права root, используя команду
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=su&apropos=0&sektion=1&format=html">su(1)</a>.
Пользователи не включенные в <kbd>&quot;wheel&quot;</kbd>, не могут
использовать su(1). Ниже, приведена строка <kbd>/etc/group</kbd>,
определяющая принадлежность пользователя <strong>ericj</strong> группе
<kbd>&quot;wheel&quot;</kbd>.
</p> 
<p>
Добавить пользователя в группу <kbd>&quot;wheel&quot;</kbd>, 
также, можно при его регистрации (скриптом 
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&apropos=0&sektion=8&format=html">adduser(8)</a>), 
ответив &quot;wheel&quot; на запрос
<tt>Invite<i> имя </i>into other groups:</tt>.
Так или иначе строка /etc/group, должна принять следующий вид: 
</p>
<ul><pre>
wheel:*:0:root,ericj
</pre></ul>
<p>
Если же вы ищите путь дать пользователям часть привилегий суперпользователя,
не добавляя их в группу <kbd>&quot;wheel&quot;</kbd>, используйте 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sudo&sektion=8&format=html">sudo(8)</a>.
</p>

<p>
<a name= "10.2">
<h2>10.2 - Как сдублировать раздел (файловую систему) ?</h2>
</a>
</p>

<p>
Чтобы сдублировать файловую систему используйте команды
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dump&sektion=8&format=html">dump(8)</a>
и
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=restore&sektion=8&format=html">restore(8)</a>.
Например, чтобы сдублировать все из каталога <kbd>SRC</kbd> в каталог
<kbd>DST</kbd>, выполните:
</p>

<ul>
<pre>
# <strong>cd /SRC; dump 0f - . | (cd /DST; restore -rf - )</strong>
</pre>
</ul>
<p>
Конанда dump создана для полного резервного копирования, и все ее возможности
могут быть избыточными, если вам нужно просто скопировать часть или весь раздел
диска. В этом случае команда 
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=tar&sektion=1&format=html">tar(1)</a>
будет работать быстрее. Формат будет очень похожим:
<UL>
<PRE>
# <strong>cd /SRC; tar cf -  . | (cd /DST; tar xpf - )</strong>
</UL>
</PRE>
<BR>

<p><a name="10.3">
<h2>10.3 - Как сделать, чтобы демоны запускались при старте системы ? 
(Обзор rc(8))</h2>
</a></p>

<p>
Информация о том, какие модули должны быть запушены при старте системы, OpenBSD 
хранит в нескольких файлах, называемых
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc&sektion=8&format=html">rc(8)</a>.
Некоторые из них являются скриптами для исполнения, другие - файлами
конфигурации:
</p>

<ul>
	<li>/etc/rc - Главный скрипт. Не должен редактироваться.
	<li>/etc/rc.conf - Файл конфигурации, для <i>/etc/rc</i>, 
	определяющий, какие системные демоны должны быть загружены при старте
	системы.
	<li>/etc/netstart - Скрипт, для инициализации сети. Не должен редактироваться.
	<li>/etc/rc.local - Скрипт для локального администрирования.
	Именно сюда добавляются строки для запуска новых демонов и
	разнообразных утилит инициализации.
	<li>/etc/rc.securelevel - Скрипт, выполняющий необходимые команды
	перед сменой уровня безопасности (security level) системы. Смотрите
	<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=init&sektion=8&format=html">init(8)</a>
	<li>/etc/rc.shutdown - Скрипт, запускающийся при остановке (shutdown)
	системы. Поместите в этот файл все, что необходимо выполнить перед
	выключением компьютера.	Смотрите
	<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc.shutdown&sektion=8&format=html">rc.shutdown(8)</a>
</ul>

<h3>Как работает система rc(8) ?</h3>
<p>
При администрировании, основное внимание должно уделяться файлам
<i>/etc/rc.conf</i>, <i>/etc/rc.local</i> и <i>/etc/rc.shutdown</i>.
Для общего же представления о работе системы rc(8), ниже представлен порядок
загрузки системы:
</p>

<ul>После загрузки ядра, запускается скрипт <i>/etc/rc</i>, который:
	<li>Проверяет файловые системы. Если вы хотите чтобы
	эта проверка всегда пропускалась
	(хотя, нельзя сказать что это хорошая идея) создайте файл /etc/fastboot.
	Проверки не будет производиться, пока он существует.
	<li>Читает конфигурационные переменные из файла <i>/etc/rc.conf</i>
	<li>Монтирует файловые системы
	<li>Отчищает <i>/tmp</i> и сохраняет несохраненные файлы.
	<li>Конфигурирует сеть через <i>/etc/netstart</i>
		<ul>
		<li>Конфигурирует сетевые интерфейсы.
		<li>Устанавливает имя хоста, домена и т.п.
		</ul>
	<li>Запускает системные демоны
	<li>Выполняет различные проверки (квот (quota's), savecore, и т.п.)
	<li>Запускает локальные демоны - <i>/etc/rc.local</i>
</ul>

<h3>Запуск системных Демонов и Сервисов OpenBSD</h3>

<p>
Для запуска при старте системы, большинства системных (т.е. установленных
вместе с OpenBSD) демонов и сервисов, достаточно  отредактировать
конфигурационный файл <i>/etc/rc.conf</i>. Заглянув в стандартный файл 
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/rc.conf">/etc/rc.conf</a>,
вы увидите нечто похожее:
</p>
<ul><pre>
ftpd_flags=NO           # for non-inetd use: ftpd_flags="-D"
</ul></pre>
<p>
Строка, такая как эта, показывает что демон (ftpd) не запускается 
при старте системы. (По
крайней мере, не запускается через rc(8), больше об этом вы можете прочитать в
секции <a href="faq10.html#10.12">Анонимный FTP, FAQ</a>). Каждая строка, также
имеет коментарий, показывающий какие флаги нужно подставить вместо NO, для
запуска демона или сервиса в обычном (<b>NORMAL</b>) режиме. Вы не обязаны
использовать именно эти флаги - страницы man(1) описывают все возможные флаги
для настройки демона или сервиса, как это будет необходимо. Например, для
httpd(8), по-умолчанию /etc/rc.conf содержит следующую строку:
</p>
<ul><pre>
httpd_flags=NO          # for normal use: "" (or "-DSSL" after reading ssl(8))
</ul></pre>
<p>
Из нее становится очевидным, что обычно httpd запускается без каких-либо флагов,
и для запуска строку необходимо изменить на 
&quot;<b>httpd_flags=""</b>&quot;. Запуск же в режиме ssl (см.
<a href="#10.6">SSL FAQ</a> или
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ssl&sektion=8&format=html">ssl(8)</a>)
требует &quot;<b>httpd_flags="-DSSL"</b>&quot;.
</p>

<h3>Запуск локальных демонов и конфигурация</h3>

<p>
Для запуска демонов установленных из портов (ports) или других источников,
используется скрипт <i>/etc/rc.local</i>. Например, я установил некого демона
/usr/local/sbin/daemonx и хочу чтобы он запускался системой. Для этого я
добавлю в <i>/etc/rc.local</i> следующие команды:
</p>
<ul><pre>
if [ -x /usr/local/sbin/daemonx ]; then
             echo -n ' daemonx';       /usr/local/sbin/daemonx
fi
</ul></pre>
<p>
С этого момента, новый демон будет запускаться системой. При загрузке, вы
увидите ошибки, если таковые были. При безошибочном запуске вы увидите что-то
подобное:
</p>
<ul><pre>
Starting local daemons: daemonx.
</ul></pre>
<h3>rc.shutdown</h3>

<p>
<i>/etc/rc.shutdown</i> - скрипт, запускающийся перед остановкой системы.
Все, что вы хотите выполнить перед выключением компьютера (или переходом в
однопользовательский режим (single user mode)) необходимо добавить в этот файл.
Если ваш компьютер имеет APM (Advanced Power Management - расширенное
управление питанием), вы также можете установить &quot;powerdown=YES&quot;. Что
будет эквивалентно &quot;shutdown -p&quot;. 
[ориг.- If you have apm, you can also set &quot;powerdown=YES&quot;. Which will give you
the equivlent of &quot;shutdown -p&quot;.]
</p>

<p>
<a name="10.4">
<h2>10.4 - Почему пользовательская почта не проходит релеингом (relaying)
через мою систему OpenBSD ?</h2>
</a>
</p>

<p>
Выполните команду:
</p>
<ul>
<pre>
# <strong>cat /etc/mail/sendmail.cf | grep relay-domains</strong>
</pre>
</ul>
<p>
Вы получите имя файла вроде этого:
</p>
<ul>
<pre>
FR-o /etc/mail/relay-domains
</pre>
</ul>
<p>
Если файл не существует, создайте его. В нем сделайте список хостов, для
которых вы хотите пересылать почту, со следующим синтаксисом:
</p>
<ul>
<pre>
.domain.com    #Разрешить пересылку со всех/на все хосты домена domain.com
sub.domain.com #Разрешить пересылку с/на sub.domain.com и любой хост в этом домене
10.2           #Разрешить пересылку со всех хостов IP-сети 10.2.*.* 
</pre>
</ul>
<p>
Не забудьте послать sendmail сигнал <b>H</b>ang<b>UP</b> (сигнал, по которому
большинство демонов перечитывают свои конфигурационные файлы):
</p>
<ul><pre>
# <Strong>kill -HUP `cat /var/run/sendmail.pid`</strong>
</pre></ul>
<p>

<h3>Дополнительное чтение</h3>

<p>
<ul>
<li><a href="http://www.sendmail.org/~ca/email/relayingdenied.html">http://www.sendmail.org/~ca/email/relayingdenied.html</a>
<li><a href="http://www.sendmail.org/tips/relaying.html">http://www.sendmail.org/tips/relaying.html</a>
<li><a href="http://www.sendmail.org/antispam.html">http://www.sendmail.org/antispam.html</a>
</ul>

<a name="10.5">
<h2>10.5 - Я настроил POP, но все равно не могу получить почту. Что я могу
сделать ?</h2>
</a>
</p>

<p>
Большинство проблем POP - проблемы временных файлов или блокировок [lock files].
Если ваш POP-сервер возвращает сообщение об ошибке:
</p>
<ul>
<pre>
-ERR Couldn't open temporary file, do you own it?
</pre>
</ul>
<p>
Попробуйте выставить права (permissions) следующим образом:
<ul>
<pre>
права в каталоге /var
drwxrwxr-x   2 bin     mail     512 May 26 20:08 mail


права в каталоге /var/mail
-rw-------   1 username   username        0 May 26 20:08 username
</pre>
</ul>
<p>
Проверьте, что каждый пользователь действительно владеет (own) своим файлом в
/var/mail. То есть, файлом /var/mail/joe, должен владеть joe, и если это
не так - ждите проблем.
<P>
Конечно, право записи в каталог /var/mail для группы mail,
открывает некоторые неопределенные проблемы безопасности. Но вы, скорее всего,
с ними никогда не столкнетесь, хотя все возможно (особенно, если вы -
высокопрофильный сайт, интернет-провайдер, ...). 
Попробуйте использовать cucipop или другой POP-демон из коллекции портов
(ports) OpenBSD. Может быть вы просто выбрали для POP-демона неправильную опцию
(например dot locking). [?] Или вам просто необходимо изменить каталог,
в котором он блокируется ([?]хотя тогда, блокирование было бы полезно только
для POP-демона).
[ориг.- Or, you may just need to change the directory that it locks in (although
then the locking would only be valueable for the POP daemon.)]
</p>

<p>
<a name="10.6">
<h2>10.6 - Настройка безопасного HTTP-сервера с SSL(8)</h2>
</a>
</p>

<p>
Начиная с релиза 2.6, c OpenBSD поставляется httpd, поддерживающий SSL. Однако
из-за различий в патентах, часть библиотек не могут входить в OpenBSD.
Поэтому, чтобы иметь возможность использовать RSA-сертификаты, вам
необходимо установить на ваш компьютер дополнительные библиотеки. Существуют
два набора этих библиотек, один из которых сертифицирован для использования за
пределами США ("<b>ssl26.tgz</b>"), другой - в США ("<b>sslUSA26.tgz</b>"). 
Установите их используюя утилиту
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pkg_add&sektion=1&format=html">pkg_add(1)</a>.
(<strong>NB:</strong> Эти библиотеки, скорее всего, уже установлены на вашем
компьютере, если вы инсталлировались из сети (FTP-install и др.)). Например, для
установки библиотек (не-США версии) используйте следующую команду (где
${arch} - ваша архитектура; <strong>NB:</strong> Это не распространяется на
Alpha, из-за отсутствия библиотек для нее): 
</p> 
<div style="margin-left: 2em">
<pre>
# <strong>pkg_add ftp://ftp.openbsd.org/pub/OpenBSD/2.6/packages/${arch}/ssl26.tgz</strong>
</pre>
</div>
<p>
Первым делом вы должны создать сертификат для 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=httpd&sektion=8&format=html">httpd(8)</a>
и сохранить его в <i>/etc/ssl/private/</i>. (Приведенные ниже примеры ниже
взяты из страницы man
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ssl&sektion=8&format=html">ssl(8)</a>.
За дополнительной информацией обращайтесь к оригиналу. Данный же раздел FAQ
ставит своей целью обзор процедуры получения RSA сертификата для
веб-сервера (не DSA-сертификата !)).
</p> 
<p>
Итак, мы создаем серверный ключ и сертификат сервера (перед использованием
RSA-функций, необходимо обновить libssl). Создаем ключ используя OpenSSL:
</p>
<div style="margin-left: 2em">
<pre>
# <strong>openssl genrsa -out /etc/ssl/private/server.key 1024</strong>
</pre>
</div>
<p>
Если же вы хотите чтобы ключ был зашифрован паролем, который
будет необходимо набирать при запуске сервера:
</p>
<div style="margin-left: 2em">
<pre>
# <strong>openssl genrsa -des3 -out /etc/ssl/private/server.key 1024</strong>
</pre>
</div>
<p>
Вторым шагом, после генерации ключа, мы должны создать Certificate Singing
Request (запрос на подпись сертификата), который вы будете использовать для
получения Certifying Authority - CA (подтверждение сертификации). Чтобы это
сделать используем команду:
</p>
<div style="margin-left: 2em">
<pre>
# <strong>openssl req -new -key /etc/ssl/private/server.key -out /etc/ssl/private/server.csr</strong>
</pre>
</div>
<p>
Сгенерированный таким образом файл <i>server.csr</i> необходимо передать лицу,
у которого вы будете подписывать ваш сертификат. <b>Thawte Certification</b>
<a href="http://www.thawte.com/">http://www.thawte.com/</a>
является одной из организаций по сертификации. Она может подписать ваши
RSA-ключи. Такая же процедура работает и для DSA-ключей.
</p>
<p>
Если же вы не можете себе этого позволить, вы можете подписать свой сертификат
самостоятельно, как показано ниже.
</p>
<div style="margin-left: 2em">
<pre>
# <strong>openssl x509 -req -days 365 -in /etc/ssl/private/server.csr \
       -signkey /etc/ssl/private/server.key -out /etc/ssl/server.crt</strong>
</pre>
</div>
<p>
С файлами <i>/etc/ssl/server.crt</i> and <i>/etc/ssl/private/server.key</i>,
вы сможете запустить 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=httpd&sektion=8&format=html">httpd(8)</a>
с флагом <b>-DSSL</b>, разрешающим транзакции с вашей машиной на порте 443.
</p> 

<p>
<a name="10.7">
<h2>10.7 - Я изменил /etc/passwd редактором vi(1), но все как было, так и
осталось ... Почему ?</h2>
</a>
</p>

<p>
Нет смысла редактировать файл /etc/passwd, все ваши изменения будут потеряны,
потому что этот файл создается OpenBSD динамически программой
<A HREF="http://www.openbsd.org/cgi-bin/man.cgi?query=pwd_mkdb&sektion=8&apropos=0">pwd_mkdb(8)</a>.
Главным файлом паролей в OpenBSD является файл /etc/master.passwd. Согласно
pwd_mkdb(8):
<ul>
<pre>
FILES
     /etc/master.passwd  текущий файл паролей
     /etc/passwd         файл паролей формата Version 7
     /etc/pwd.db         файл небезопасной БД паролей
     /etc/pwd.db.tmp     временный файл
     /etc/spwd.db        файл безопасной БД паролей
     /etc/spwd.db.tmp    временный файл
</pre>
</ul>
<P>
В традиционном файле паролей Unix - /etc/passwd, вся информация, включая
зашифрованные пользовательские пароли, доступна любому пользователю системы
(и является первичной целью таких программ как Crack). В 4.4BSD впервые
появился файл master.passwd, имеющий расширенный формат (с дополнительными
параметрами, не представленными в /etc/passwd) и доступный для чтения только
root. Для быстрейшего доступа, библиотечные вызовы, обращающиеся
к этим данным обычно читают файлы /etc/pwd.db и /etc/spwd.db.
</P>
<P>
OpenBSD поставляется с со специальной утилитой, для редактирования файла
паролей. Она называется vipw(8). Vipw позволяет вам редактировать файл паролей
/etc/master.passwd редактором vi(1) (или редактором, указаным в переменной
окружения $EDITOR). После завершения редактирования, эта утилита сгенерирует
новые файлы /etc/passwd, /etc/pwd.db и /etc/spwd.db c вашими изменениями.
Vipw также заботится о блокировке этих файлов, так что если кто-то попытается
изменить их в это же время, не получит к ним доступа. 
</p>

<p>
<a name="10.8">
<h2>10.8 - Каков наилучший способ регистрации и удаления пользователя ?</h2>
</a>
</p>

<p>
Для пользователей OpenBSD 2.6 для регистрации пользователей существует команда
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&sektion=8&format=html">adduser(8)</a>.
В OpenBSD 2.7 появилась новая команда
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=user&sektion=8&format=html">user(8)</a>
которой можно и регистрировать и удалять как пользователей так и группы.
<ul>
	<li><a href="#adduser">adduser(8)</a>
	<li><a href="#user">user(8)</a>
</ul>

<a name="adduser"></a>
<p>
Лучшим способом регистрации пользователя в OpenBSD является использование
скрипта
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&sektion=8&format=html">adduser(8)</a>
Вы можете сконфигурировать его по своему желанию, редактируя файл 
<strong>/etc/adduser.conf</strong>. Конечно, можно добавлять пользователей и
руками, используя 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&sektion=8&format=html">vipw(8)</a>,
но это нерекомендуемый способ. adduser(8) позволяет проверить данные на
соответствие данным
<strong>/etc/passwd</strong>, <strong>/etc/group</strong> и базе
шеллов (shells). Также, он создаст новому пользователю домашний каталог и
даже может послать ему приветственное сообщение. Все это может быть изменено,
чтобы соответствовать вашим нуждам. За дополнительными инструкциями о
регистрации пользователей обратитесь к странице man
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser_proc&sektion=8&format=html">adduser_proc(8)</a>.
Вот пример регистрации пользователя <b>testuser</b> с домашним каталогом
<i>/home/testuser</i>, группой <b>guest</b> и шеллом <i>/bin/ksh</i>.
</p>

<ul><pre>
# <strong>adduser</strong>
Use option ``-silent'' if you don't want to see all warnings and questions.

Reading /etc/shells
Check /etc/master.passwd
Check /etc/group

Ok, let's go.
Don't worry about mistakes. I will give you the chance later to correct any input.
Enter username [a-z0-9_]: <strong>testuser</strong>
Enter full name []: <strong>Test FAQ User</strong>
Enter shell csh ksh nologin sh [ksh]: <strong>ksh</strong>
Uid [1002]: <strong>&lt;Enter&gt;</strong>
Login group testuser [testuser]: <strong>guest</strong>
Login group is ``guest''. Invite testuser into other groups: guest no
[no]: <strong>no</strong>
Enter password []: 
Enter password again []:

Name:     testuser
Password: ****
Fullname: Test FAQ User
Uid:      1002
Gid:      31 (guest)
Groups:   guest
HOME:     /home/testuser
Shell:    /bin/ksh
OK? (y/n) [y]: <strong>y</strong>
Added user ``testuser''
Copy files from /usr/share/skel to /home/testuser
Add another user? (y/n) [y]: <strong>n</strong>
Goodbye!
</pre></ul>

<p>
Для удаления пользователя вы можете использовать утилиту 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rmuser&sektion=8&format=html">rmuser(8)</a>.
Она удалит все связанное с пользователем - задания
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=crontab&sektion=1&format=html">crontab(1)</a>,
домашний каталог (если пользователь им владел), всю почту пользователя. И,
конечно, она также удалит записи <strong>/etc/passwd</strong> и
<strong>/etc/group</strong>. Теперь мы удалим пользователя,
зарегистрированного в предыдущем примере. Обратите внимание, на то, что утилита
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rmuser&sektion=8&format=html">rmuser(8)</a>
запрашивает имя пользователя и спрашивает надо ли удалять его домашний каталог.
</p>
<ul><pre>
# <strong>rmuser</strong>
Enter login name for user to remove: <strong>testuser</strong>
Matching password entry:

testuser:$2a$07$ZWnBOsbqMJ.ducQBfsTKUe3PL97Ve1AHWJ0A4uLamniLNXLeYrEie:1002:31::0:0:Test FAQ User:/home/testuser:/bin/ksh

Is this the entry you wish to remove? <strong>y</strong>
Remove user's home directory (/home/testuser)? <strong>y</strong>
Updating password file, updating databases, done.
Updating group file: done.
Removing user's home directory (/home/testuser): done.
</pre></ul>

<a name="user"></a>
<h3>10.8.2 - Команды user(8)</h3>
</a>
<p>
В OpenBSD 2.7 было добавлено много команд для работы с пользователями
и группами. Они менее интерактивны, нежели
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&sektion=8&format=html">adduser(8)</a>,
зато это позволяет использовать их в скриптах.
</p>

<ul>Список добавленных команд:
	<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=group&sektion=8&format=html">group(8)</a>
	<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=groupadd&sektion=8&format=html">groupadd(8)</a>
	<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=groupdel&sektion=8&format=html">groupdel(8)</a>
	<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=groupinfo&sektion=8&format=html">groupinfo(8)</a>
	<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=groupmod&sektion=8&format=html">groupmod(8)</a>
	<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=user&sektion=8&format=html">user(8)</a>
	<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=useradd&sektion=8&format=html">useradd(8)</a>
	<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=userdel&sektion=8&format=html">userdel(8)</a>
	<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=userinfo&sektion=8&format=html">userinfo(8)</a>
	<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=usermod&sektion=8&format=html">usermod(8)</a>
</ul>

<h4>10.8.2.1 - Регистрация пользователя</h4>

<p>
Команды user(8), неинтерактивны, и поэтому наиболее простым методом эффективной
регистрации пользователя все-таки остается adduser(8). Реальная команда 
<i>/usr/sbin/user</i> является только фасадом - средством для обращения к
командам <i>/usr/sbin/user*</i>. Поэтому можно использовать <b>user add</b>
или <b>useradd</b>, формат команды от этого не изменяется.
</p>
<p>
В этом примере мы добавляем того же пользователя (с теми же параметрами) что
добавляли <a href="#adduser">выше</a>. Использование useradd(8) гораздо
проще, если вы знаете пользовательские установки по-умолчанию. Эти установки
расположены в файле <i>/etc/usermgmt.conf</i>, их можно просмотреть так:
</p>
<ul><pre>
$ <strong>user add -D</strong>
group           users
base_dir        /home
skel_dir        /etc/skel
shell           /bin/csh
inactive        0
expire          Null (unset)
range           1000..60000
</pre></ul>
<p>
Эти установки будут даны пользователю, если вы не определите других ключами
командной строки. Например, в нашем случае, мы хотим дать пользователю
группу <b>guest</b> (а не <b>users</b>). Единственным минусом является
необходимость определения пароля в командной строке, зашифрованного пароля.
И это означает, что предварительно вы должны зашифровать пароль командой
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=encrypt&sektion=1&format=html">encrypt(1)</a>.
По умолчанию OpenBSD шифрует пароли алгоритмом Blowfish в 6 проходов, сделать
это можно так:
</p>
<ul><pre>
$ <strong>encrypt -p -b 6</strong>
Enter string:
$2a$06$YOdOZM3.4m6MObBXjeZtBOWArqC2.uRJZXUkOghbieIvSWXVJRzlq
</pre></ul>
<p>
Полученную строку и надо указать после ключа <b>-p</b> в команде user(8).
</p>
<ul><pre>
# <strong>user add -p '$2a$06$YOdOZM3.4m6MObBXjeZtBOWArqC2.uRJZXUkOghbieIvSWXVJRzlq' -u 1002 \
-s /bin/ksh -c "Test FAQ User" -m -g guest testuser</strong>
</pre></ul>
<p>
<b>NB:</b> Убедитесь что пароль заключен в 'апострофы', а не 
&quot;кавычки&quot; иначе шелл, нежелательным образом, интерпретирует эти
символы
перед тем как передать в команду user(8). Также убедитесь что вы определили
ключ <b>-m</b>, чтобы инициализировать домашний каталог пользователя из
каталога <i>/etc/skel</i>.
</p>
<p>
Чтобы убедиться, что все создано правильно, вы можете использовать
различные утилиты. Ниже приведены несколько таких команд.
</p>
<ul><pre>
$ <strong>ls -la /home</strong>
total 14
drwxr-xr-x   5 root      wheel   512 May 12 14:29 .
drwxr-xr-x  15 root      wheel   512 Apr 25 20:52 ..
drwxr-xr-x  24 ericj     wheel  2560 May 12 13:38 ericj
drwxr-xr-x   2 testuser  guest   512 May 12 14:28 testuser
$ <strong>id testuser</strong>
uid=1002(testuser) gid=31(guest) groups=31(guest)
$ <strong>finger testuser</strong>
Login: testuser                         Name: Test FAQ User
Directory: /home/testuser               Shell: /bin/ksh
Last login Sat Apr 22 16:05 (EDT) on ttyC2
No Mail.
No Plan.
</pre></ul>
<p>
В дополнение к этим командам, user(8) имеет собственную утилиту для просмотра
данных о пользователе - userinfo(8).
</p>
<ul><pre>
$ <strong>userinfo testuser</strong>
login   testuser
passwd  *
uid     1002
groups  guest
change  Wed Dec 31 19:00:00 1969
class
gecos   Test FAQ User
dir     /home/testuser
shell   /bin/ksh
expire  Wed Dec 31 19:00:00 1969
</pre></ul>

<h4>10.8.2.2 - Удаление пользователя</h4>

<p>
Для удаления пользователей группа команд user(8) имеет утилиту userdel(8). Это
предельно простая и вполне удобная команда. Чтобы удалить того пользователя,
регистрации которого посвящена добрая половина данного раздела FAQ, просто
наберите:
</p>
<ul><pre>
# <strong>userdel -r testuser</strong>
</pre></ul>
<p>
Учтите, что для удаления домашнего каталога вы должны определить ключ
<b>-r</b>. Напротив, если вы не хотите ничего удалять, а хотите только
заблокировать аккаунт, укажите ключ <b>-p</b> (и не указывайте <b>-r</b>).
</p>

<p>
<a name="10.9">
<h2>10.9 - Как зарегистрировать пользователя только для FTP (не анонимного !) ?
</h2>
</a>
</p>

<p>
Чтобы сделать это, есть несколько способов, но, наиболее часто, это делают,
указывая пользователю в качестве шелла <i>/usr/bin/false</i> (не забыв добавить
эту строку в файл <strong>/etc/shells</strong>). После этого пользователь не
сможет залогинится в систему, но сможет использовать ftp. 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&sektion=8&format=html">adduser(8)</a>
создаст пользователю домашний каталог в одноименном каталоге ветки
<i>/home</i>, вместо него вы можете указать произвольный каталог. Также, вы
можете сделать, чтобы пользователь не мог видеть файлов вне своего домашнего
каталога, добавив его имя в <i>/etc/ftpchroot</i>. Используя же ключ
<b>-A</b> при запуске 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&sektion=8&format=html">ftpd(8)</a>,
вы можете разрешить работу только анонимного ftp.
</p>

<p>
<a name="10.10">
<h2>10.10 - Установка дисковых квот (quota).</h2>
</a>
</p>

<p>
Квоты используются для ограничения доступного пользователю дискового
пространства на ваших дисках. Это может быть очень полезным в ситуации, когда
вы ограничены в ресурсах. Квоты могут устанавливатся двумя разными путями.
</p>
<p>
<ul>
<li>Квоты для пользователя</li>
<li>Квоты для группы</li>
</ul>
</p>
<p>
Первым шагом, убедитесь что конфигурация вашего ядра имеет строку
<tt>option QUOTA</tt>. Если вы используете ядро GENERIC (в котором эта опция
есть), вы можете пропустить этот шаг. Далее, в <i>/etc/fstab</i> пометьте
файловые системы, для которых вы будете определять квоты, используя ключевые
слова <tt>userquota</tt> и <tt>groupquota</tt>.
По-умолчанию корне каждой файловой системы будут созданы файлы
<b>quota.user</b> и <b>quota.group</b> для хранения данных о квотах.
Если вы хотите хранить их в другом месте, вы должны явно определить
местоположение файлов, например <tt>userquota=/var/quotas/quota.user</tt>.
Вот пример строки /etc/fstab, с разрешеним квот для одной из файловых систем.
</p>
<ul>
<pre>
/dev/wd0a / ffs rw,userquota=/var/quotas/quota.user 1 1
</pre>
</ul>
<p>
Теперь установим, собственно, сами квоты. Чтобы сделать это используйте
утилиту
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=edquota&sektion=8&format=html">edquota(8)</a>.
Простейший способ - просто набрать <strong>edquota &lt;имя&gt;</strong>.
edquota(8) использует vi(1) для редактирования квот (если только переменной
окружения EDITOR не определен другой редактор). Например:
</p>
<ul>
</pre>
# <strong>edquota ericj</strong>
</pre>
</ul>
<p>
Врезультате мы увидим вот что:
</p>
<ul>
<pre>
Quotas for user ericj:
/: blocks in use: 62, limits (soft = 0, hard = 0)
	inodes in use: 25, limits (soft = 0, hard = 0)
</pre>
</ul>
<p>
Что значит - лимитов не установлено. Для установки лимитов, отредактируйте
строки, чтобы они выглядели так:
</p>
<ul>
<pre>
Quotas for user ericj:
/: blocks in use: 62, limits (soft = 1000, hard = 1050)
	inodes in use: 25, limits (soft = 0, hard = 0)
</pre>
</ul>
<p>
Тем самым, мы определяем мягкий лимит в 1000 блоков и жесткий лимит в 1050
блоков. Переходя мягкий лимит, пользователь будет предупрежден о его превышении
и сможет работать с таким превышением некоторое время (grace period). Grace
period можно установить edquota(8) с ключом <strong>-t</strong>. По окончанию
grace period мягкий лимит обрабатывается как жесткий. Жесткий же лимит вызывает
сообщения об отсутствии дискового пространства.
</p>
<p>
Квоты установлены, теперь необходимо их активировать. Для этого используют
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=quotaon&sektion=8&format=html">quotaon(8)</a>.
Например:
</p>
<ul>
<pre>
# <strong>quotaon -a</strong>
</pre>
</ul>
<p>
quotaon(8) просмотрит файл /etc/fstab и активирует квоты для всех помеченных
файловых систем. Теперь, когда квоты активированы вы можете посмотреть их
утилитой
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=quota&sektion=1&format=html">quota(1)</a>.
Набрав <strong>quota &lt;имя&gt;</strong> вы получите информацию о квотах
указанного пользователя. Без параметров вы увидите информацию о собственных
квотах. Например:
</p>
<ul>
<pre>
# <Strong>quota ericj</strong>
Disk quotas for user ericj (uid 1001): 
     Filesystem  blocks   quota   limit   grace   files   quota   limit   grace
              /      62    1000    1050              27       0       0        
</pre>
</ul>
<p>
По-умолчанию квоты установленные в /etc/fstab активируются при загрузке. Чтобы
их выключить используйте 
<ul><pre># <strong>quotaoff -a</strong></pre></ul>
</p>

<p>
<a name="10.11">
<h2>10.11 - Настройка сервера/клиента Kerberos под OpenBSD (не переведено)</h2>
</a>
</p>

<p>
As a user/administrator of OpenBSD systems, you are fortunate that
KerberosIV is an pre-installed component of the default system. Here is
a guide to setting up both the Kerberos realm server, as well as a
client.
</p>

<p>
An *EXTREMELY* important point to remember is that Kerberos clients
and servers must have their system clocks synchronized. If there is
more than a 5 minute time skew, you will receive wierd errors that
do not immediately reveal themselves to be caused by time skew, such as:
</p>

<ul>
<pre>
kinit: Can't send request (send_to_kdc) 
</pre>
</ul>

Another more accurate error is:

<ul>
<pre>
kauth: Time is out of bounds (krb_rd_req) 
</pre>
</ul>

<p>
An easy way to synchronize system clocks is with xntpd, available in the ports tree at
<strong>/usr/ports/sysutils/xntpd/</strong>.
</p>

This FAQ entry assumes you have prior knowledge of the Kerberos concepts.
For a great, easy to understand, reference, see:

<ul>
<li><a href="http://www.freebsd.org/handbook/kerberos.html">The FreeBSD handbook</a> </li>
<li>Use the command <strong>info kth-krb</strong></li>
<li><a href="http://web.mit.edu/kerberos/www/dialogue.html">Designing an Authentication System: a Dialogue in Four Scenes</a></li>
<li><a href="http://web.mit.edu/kerberos/www/papers.html#krb4">Papers and Documentation Describing KerberosIV</a></li>
</ul>Or the book<ul>
<li><a href="http://www.amazon.com/exec/obidos/ASIN/0130614661/qid%3D930594963/">Network Security Private Communication in a Public World [Kaufman, Perlman, Speciner, 1995]</a></li> 
</ul>
</ul>

<h3>How to setup the Kerberos IV REALM and SERVER</h3>

<p>
We will be setting up the CIARASYSTEMS.COM realm, with avalanche.ciarasystems.com as the main server.
</p>

<p>
To start off, we will need to edit our configuration files. These files are located at <tt>/etc/kerberosIV/</tt>.
The two files we are concerned about are <i>krb.realms</i> and <i>krb.conf</i>. Let's start off with <i>krb.conf</i>.
</p>

<ul>
<pre>
[root@avalanche kerberosIV] <strong>cat krb.conf</strong>
CIARASYSTEMS.COM
CIARASYSTEMS.COM avalanche.ciarasystems.com admin server
</pre>
</ul>

<p>
As you can see, this tells kerberos that the domain is CIARASYSTEMS.COM (or logical realm) and that
within that domain, avalanche is the administration server. Next we will look at <i>krb.realms</i>. For more information
on this refer to <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=krb.conf&sektion=5&format=html">krb.conf</a>.
</p>

<ul>
<pre>
[root@avalanche kerberosIV] <strong>cat krb.realms</strong>
avalanche.ciarasystems.com      CIARASYSTEMS.COM
.ciarasystems.com               CIARASYSTEMS.COM
</pre>
</ul>

<p>
krb.realms provides a translation from a hostname to the Kerberos realm name for the services provided by that host.
Each line of the translation file is in one of the following forms (domain_name should be  of  the  form  .XXX.YYY).
So in this example, avalanche is the hostname of a computer on the CIARASYSTEMS.COM realm. And
.ciarasystems.com is the domain name on the realm CIARASYSTEMS.COM. Again, for further information read
the <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=krb.realms&sektion=5&format=html">krb.realms</a>. man page.
</p>

<p>
Next we will run <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=kbd_init&sektion=8&format=html">kdb_init(8)</a> 
to create the initial Kerberos database.
</p>

<ul>
<pre>
[root@avalanche kerberosIV] <strong>kdb_init</strong>
Realm name [default  NO.DEFAULT.REALM ]: CIARASYSTEMS.COM
You will be prompted for the database Master Password.
It is important that you NOT FORGET this password.

Enter Kerberos master password: <strong>not shown</strong>
Verifying password -
Enter Kerberos master password:
</pre>
</ul>

<p>
Next we need to use <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=kstash&sektion=8&format=html">kstash(8)</a> 
which is used to save the Kerberos key distribution center (KDC) database master key in the master key cache file.
</p>

<ul>
<pre>
[root@avalanche kerberosIV] <strong>kstash</strong>
Enter Kerberos master password:

Current Kerberos master key version is 1.

Master key entered.  BEWARE!
Wrote master key to /etc/kerberosIV/master_key
</pre>
This saves the encrypted master password in /etc/kerberosIV/master_key.<p>

Next, we need two principals to be added to the database for each
system that will be secured with Kerberos. Their names are
<i>kpasswd</i> and <i>rcmd</i>. These two principals are made for
each system, with the instance being the name of the individual system. 

These daemons, <i>kpasswd</i> and <i>rcmd</i> allow other systems
to change Kerberospasswords and run commands like <i>rcp, rlogin</i> 
and <i>rsh</i>. 


<pre>
# <b>kdb_edit</b>
Opening database...
    
Enter Kerberos master key:
    
Current Kerberos master key version is 1.
    
Master key entered.  BEWARE!

Previous or default values are in [brackets] ,
enter return to leave the same, or new value.

Principal name: <strong>passwd</strong>
Instance: <strong>avalanche</strong>

&lt;Not found&gt;, Create [y] ? <strong>y</strong>

Principal: passwd, Instance: avalanche, kdc_key_ver: 1
New Password:                <strong>&lt;----- Use 'RANDOM' as password</strong>
Verifying password -
New Password:

Random password [y] ? <strong>y</strong>

Principal's new key version = 1
Expiration date (enter yyyy-mm-dd) [ 1999-12-31 ] ? <strong>2001-12-31</strong>
Max ticket lifetime (*5 minutes) [ 255 ] ?
Attributes [ 0 ] ?
Edit O.K.


Principal name: <strong>rcmd</strong>
Instance: <strong>avalanche</strong>

&lt;Not found&gt;, Create [y] ? <strong>y</strong>
Principal: rcmd, Instance: avalanche, kdc_key_ver: 1
New Password:                 <strong>&lt;----- Use 'RANDOM' as password</strong>
Verifying password -
New Password:

Random password [y] ? <Strong>y</strong>

Principal's new key version = 1
Expiration date (enter yyyy-mm-dd) [ 1999-12-31 ] ? <strong>2001-12-31</strong>
Max ticket lifetime (*5 minutes) [ 255 ] ?
Attributes [ 0 ] ?
Edit O.K.
Principal name:               <strong>&lt;----- Hit &lt;ENTER&gt; to end</strong>

</pre>
</ul>

<p>
A srvtab file is the service key file. These must be extracted from the  Kerberos key  distribution center database in
order for services to authenticate using Kerberos. For  each  hostname  specified  on
the command line, <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ext_srvtab&sektion=8&format=html">ext_srvtab(8)</a>
creates the service key file hostname-new-srvtab, containing all the entries in the database with an instance field of
hostname.
</p>

<ul>
<pre>
[root@avalanche kerberosIV] <Strong>ext_srvtab avalanche</strong>

Enter Kerberos master password:

Current Kerberos master key version is 1.

Master key entered.  BEWARE!
Generating 'avalanche-new-srvtab'....

[root@avalanche kerberosIV] <strong>mv avalanche-new-srvtab srvtab</strong>
[root@avalanche kerberosIV] <strong>chmod 600 srvtab</strong>
</pre>
</ul>

<p>
Now we can add users to our database.
</p>

<ul>
<pre>
[root@avalanche kerberosIV] <strong>kdb_edit</strong>
Opening database...
    
Enter Kerberos master key:
    
Current Kerberos master key version is 1.
    
Master key entered.  BEWARE!
Previous or default values are in [brackets] ,
enter return to leave the same, or new value.
    
Principal name: <strong>jeremie</strong>
Instance:
    
&lt;Not found&gt;, Create [y] ? <strong>y</strong>
    
Principal: jeremie, Instance: , kdc_key_ver: 1
New Password:                &lt;---- enter a secure password here
Verifying password
    
New Password:                &lt;---- re-enter the password here
Principal's new key version = 1
Expiration date (enter yyyy-mm-dd) [ 2000-01-01 ] ?
Max ticket lifetime (*5 minutes) [ 255 ] ?
Attributes [ 0 ] ?
Edit O.K.
Principal name:          &lt;---- null entry here will cause an exit
			       or you can add more entries.
</pre>
</ul>

<p>
So now all the Kerberos particulars are setup. All that is left is to enable
boot-time loading of the Kerberos server and to enable Kerberized-daemons.
</p>

<p>
In /etc/rc.conf, set:
<ul>
<tt>kerberos_server=YES</tt>
</ul>

In /etc/inetd.conf, uncomment:
<UL>
<pre>
telnet       stream  tcp     nowait  root    /usr/libexec/telnetd    telnetd -k
klogin       stream  tcp     nowait  root    /usr/libexec/rlogind    rlogind -k
kshell       stream  tcp     nowait  root    /usr/libexec/rshd       rshd -k
kauth        stream  tcp     nowait  root    /usr/libexec/kauthd     kauthd
</pre>
</ul>

Then, either reboot, or:
<ul>
<pre>
[root@avalanche /] <Strong>kill -HUP `cat /var/run/inetd.pid`</strong>
[root@avalanche /] <Strong>/usr/libexec/kerberos >> /var/log/kerberos.log &</strong>
[root@avalanche /] <strong>/usr/libexec/kadmind -n >> /var/log/kadmind.log &</strong>
</pre>
</ul>
</p>

<p>
Note: this is a rather simple server setup. Usually, redundant servers
are setup (as slave servers) so that if one server goes down, all the
services that depend on Kerberos don't go down. We can also add 'su'
privileges to a specific principal, see <a href="http://www.freebsd.org/handbook/kerberos.html#AEN4957">the FreeBSD Handbook</a>.
</p>

<h3>How to kerberize your client workstation</h3>

<p>
We will be setting the workstation named <i>gatekeeper</i> to be in the
CIARASYSTEMS.COM realm, with avalanche.ciarasystems.com as the main server.
</p>

<p>
To start off, we need to setup our <i>krb.conf</i> and <i>krb.realms</i> like the above machine. This is so
<i>gatekeeper</i> will know what server is the KDC and what domain it is on. Again here are the file contents.
</p>

<ul>
<pre>
[root@gatekeeper kerberosIV] <strong>cat krb.conf</strong>
CIARASYSTEMS.COM
CIARASYSTEMS.COM avalanche.ciarasystems.com admin server

[root@gatekeeper kerberosIV] <strong>cat krb.realms</strong>
avalanche.ciarasystems.com      CIARASYSTEMS.COM
.ciarasystems.com               CIARASYSTEMS.COM
</pre>
</ul>

<p>
Now that is set up, we need to initialize kerberos. To obtain a ticket you use <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=kinit&sektion=1&format=html">kinit(1)</a>.
</p>

<ul>
<pre>
xyz:jeremie% <Strong>kinit</strong>
The OpenBSD Project (gatekeeper)
Kerberos Initialization
Kerberos name: <strong>jeremie</strong>
Password:
</pre></strong>
</ul>

<p>
Now we have identified we can list our tickets with <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=klist&sektion=1&format=html">klist(1)</a>.
</p>

<ul>
<pre>
xyz:jeremie$ <strong>klist</strong>
Ticket file:    /tmp/tkt1000
Principal:      jeremie@CIARASYSTEMS.COM

  Issued           Expires          Principal
Jun 28 01:03:25  Jun 28 11:03:25  krbtgt.CIARASYSTEMS.COM@CIARASYSTEMS.COM
</pre>
</ul>

<p>
Looks like we are set now. All that's left to do is test it. Here we will test it with rlogin(1) and telnet(1).
</p>

<ul>
<pre>
xyz:jeremie% <Strong>telnet avalanche</strong>
Trying 192.168.0.38...
Connected to avalanche.
Escape character is '^]'.
[ Trying mutual KERBEROS4 ... ]
[ Kerberos V4 accepts you ]
[ Kerberos V4 challenge successful ]
Last login: Sun Jun 27 22:52:25 on ttyp1 from gatekeeper
Warning: no Kerberos tickets issued.
OpenBSD 2.5 (AVALANCHE) #5: Tue Apr  6 01:18:16 EDT 1999
</pre></ul>

and 
<ul><pre>
xyz:jeremie% <Strong>rlogin avalanche</strong>
Last login: Sun Jun 27 22:53:39 on ttyp1 from gatekeeper
Warning: no Kerberos tickets issued.
OpenBSD 2.5 (AVALANCHE) #5: Tue Apr  6 01:18:16 EDT 1999
</pre></strong>
</ul>

<p>
We can tell that it is indeed using Kerberos to authenticate the rlogin
session. To get rid of any tickets issued, you would use <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=kdestroy&sektion=1&format=html">kdestroy(1)</a>.
For example:
</p>

<ul>
<pre>
xyz:jeremie% <strong>kdestroy</strong>
Tickets destroyed.
xyz:jeremie% <Strong>rlogin avalanche</strong>
krcmd: No ticket file (tf_util)
rlogin: warning, using standard rlogin: can't provide Kerberos auth data.
avalanche: Connection refused
</pre>
</ul>

<p>
Do not worry about 'Warning: no Kerberos tickets issued.' This is because
we're only doing kerberos authentication, not ticket passing. If you want
ticket passing, use <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ssh&sektion=1&format=html">OpenSSH</a> which has support.
Stock KerberosIV  doesn't have support for tgt passing, either - only the AFS kaserver's implementation of krb4,
since the regular KerberosIV kdc checks client IP address listed in the ticket.
</p>

<p>
<a name="10.12">
<h2>10.12 - Настрока анонимного FTP-сервера.</h2>
</a>
</p>

<p>
Анонимный FTP позволяет пользователям без аккаунтов получать доступ к файлам
на вашем компьютере через протокол передачи файлов (File Transfer Protocol).
В этом разделе мы сделаем обзор установки анонимного FTP сервера, логов и др. 
</p>

<h3>Добавляем аккаунт ftp</h3>

<p>
Для начала, вам необходим аккаунт "ftp". Этот аккаунт не должен позволять
входа в систему. Хоть, ниже, мы и установим домашним каталогом для этого
аккаунта /home/ftp, вместо него можно использовать произвольный каталог.
Демон, обслуживающий сервис анонимного ftp, блокирует (chroot) себя в домашнем
каталоге пользователя ftp. Дополнительную информацию об этом можно найти в 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&sektion=8&format=html">ftp(8)</a>
и 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=chroot&sektion=2&format=html">chroot(2)</a>
Ниже приведен пример регистрации пользователя <i>ftp</i>, используя
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&sektion=8&format=html">adduser(8)</a>.
Также, мы должны добавить /usr/bin/false в файл <i>/etc/shells</i>. Сделать это
можно командой <i>echo /usr/bin/false &gt;&gt; /etc/shells</i>. Тем самым мы
добавляем несуществующий шелл для того чтобы не позволить входа в систему под
именем ftp, даже если пароль будет пустым. Если вы, кроме этого, хотите чтобы
чтобы этот "шелл" появлялся в подсказке adduser(8), вам необходимо
модифицировать <i>/etc/adduser.conf</i>.
</p>
<ul>
<pre>
oshibana# <strong>adduser</strong>
Use option ``-silent'' if you don't want see all warnings & questions.

Reading /etc/shells
Check /etc/master.passwd
Check /etc/group

Ok, let's go.
Don't worry about mistakes. I will give you the chance later to correct any input.
Enter username [a-z0-9_]: <strong>ftp</strong>
Enter full name []: <strong>anonymous ftp</strong>
Enter shell csh false ksh nologin sh tcsh zsh [sh]: <strong>false</strong>
Uid [1002]:
Login group ftp [ftp]:
Login group is ``ftp''. Invite ftp into other groups: guest no
[no]: <strong>no</strong>
Enter password []:
Use an empty password? (y/n) [y]: <strong>y</strong>

Name:     ftp
Password: ****
Fullname: anonymous ftp
Uid:      1002
Gid:      1002 (ftp)
Groups:   ftp
HOME:     /home/ftp
Shell:    /usr/bin/false
OK? (y/n) [y]: <strong>y</strong>
Added user ``ftp''
Copy files from /usr/share/skel to /home/ftp
Add another user? (y/n) [y]: <strong>n</strong>
Goodbye!
</pre>
</ul>

<h3>Настройка каталогов</h3>

<p>
Теперь мы подготовим домашний каталог ftp, для использования под анонимный
FTP. Об этих изменениях также можно прочитать в 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&sektion=8&format=html">ftp(8)</a>.
</p>
<ul>
Нет <b>никакой</b> необходимости создавать каталоги /home/ftp/usr и /home/ftp/bin.
<BR>
<li><i>/home/ftp</i> - Главный каталог. Он должен принадлежать root с правами
555.</li>
<li><i>/home/ftp/etc</i> - Вцелом необязательный и нерекомендуемый каталог.
Существует только для того, чтобы файлы на анонимном ftp могли принадлежать
реальным пользователям. Для этого сюда необходимо скопировать файлы
/etc/pwd.db и /etc/group (для преобразования UID/GID в имена). Права для
каталога необходимо выставить в 511, а для файлов - 444. В файле pwd.db нет
паролей, но они есть в spwd.db, поэтому не копируйте его сюда !
</li>
<li><i>/home/ftp/pub</i> - Стандартный каталог для файлов. Поместите сюда
ваши файлы. Каталог должен иметь права 555.
</ul>
<p> 
Все эти каталоги должны принадлежать root. Следующий листинг показывает, как
они должны выглядеть после создания: 
</p>
<ul>
<pre>
oshibana# pwd 
/home
oshibana# ls -laR ftp
total 5
dr-xr-xr-x  5 root  ftp    512 Jul  6 11:33 .
drwxr-xr-x  7 root  wheel  512 Jul  6 10:58 ..
dr-x--x--x  2 root  ftp    512 Jul  6 11:34 etc
dr-xr-xr-x  2 root  ftp    512 Jul  6 11:33 pub

ftp/etc:
total 43
dr-x--x--x  2 root  ftp    512 Jul  6 11:34 .
dr-xr-xr-x  5 root  ftp    512 Jul  6 11:33 ..
-r--r--r--  1 root  ftp    316 Jul  6 11:34 group
-r--r--r--  1 root  ftp  40960 Jul  6 11:34 pwd.db

ftp/pub:
total 2
dr-xr-xr-x  2 root  ftp  512 Jul  6 11:33 .
dr-xr-xr-x  5 root  ftp  512 Jul  6 11:33 ..
</pre>
</ul>
<h3>Запуск сервера и логи</h3>
<p>
Вы можете выбрать запускать ftpd из-под inetd или rc-скриптами. Эти примеры
показывают как настроить
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/inetd.conf">inetd.conf</a>,
для старта из-под inetd. Cначала разберемся с некоторыми ключами ftpd. Стандартная строка из 
<i>/etc/inetd.conf</i> выглядит так:
</p>
<ul><pre>
<strong>ftp             stream  tcp     nowait  root    /usr/libexec/ftpd       ftpd -US</strong>
</pre></ul>
<p>
Здесь ftpd запускается с ключами <i>-US</i>. С этими ключами демон будет вести
логи анонимных соединений в <i>/var/log/ftpd</i> и логи конкурентных сеансов
(concurrent sessions) в <i>/var/run/utmp</i>. Это позволяет видеть эти сеансы
командой who(1). Если вы хотите разрешить пользователями только анонимный
ftp, запустите ftpd с ключом <i>-A</i>. В данном примере ftpd запускается только
для анонимных соединений. Он также использует ключ <i>-ll</i> для ведения лога
в syslog, отдельно для get, retrieve и других ftp-команд.
</p>
<ul><pre>
<strong>ftp             stream  tcp     nowait  root    /usr/libexec/tcpd       ftpd -llUSA</strong>
</pre></ul>
<p>
Для сервера с БОЛЬШОЙ нагрузкой, запускать ftpd через inetd.conf может быть
нецелесообразным. В этом случае лучшим решением будет запускать ftpd через
rc, для чего закомментировать ftpd-строку в inetd.conf, а в файле rc.conf,
в качестве опций ftpd указать <i>-D</i>. Будучи запущеным rc, ftpd будет
меньше загружать машину, нежели запускаемый из-под inetd. Пример строки
rc.conf: 
</p>
<ul><pre>
ftpd_flags="-DllUSA"           # for non-inetd use: ftpd_flags="-D"
</ul></pre>

<h3>Другие файлы для анонимного FTP</h3>

<p>
<ul>
<li><i>/etc/ftpwelcome</i> - Этот файл содержит приветственное сообщение
пользователям, появляющееся перед запросом логина.</li>
<li><i>/etc/motd</i> - Этот файл содержит "сообщение дня" выдаваемое
пользователю после успешной аутентификации.</li>
<li><i>.message</i> - Файл с таким именем может быть помещен в любой каталог,
он содержит сообщение, выдаваемое пользователю при входе в этот каталог.</li>
</ul>


<p>
<a name="10.13">
<h2>10.13 - Ограничение пользователей FTP их домашними каталогами (ftpd(8)).</h2>
</a>
</p>

<p>
В стандартной конфигурации 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&sektion=8&format=html">ftpd(8)</a> 
это можно сделать очень легко - через файл <strong>/etc/ftpchroot</strong>. Не
всегда желательно, чтобы пользователи личного ftp имели доступ ко всему диску,
и тогда доступ ftp можно ограничить домашним каталогом пользователя. Это
ограничение не используется по умолчанию ! и его нужно определять специально.
Например, по-умолчанию пользователь видит ваш диск так:
</p>
<ul><pre>
$ <strong>ftp localhost</strong>
Connected to localhost.
220 oshibana FTP server (Version 6.4/OpenBSD) ready.
Name (localhost:ericj): <strong>ericj</strong>
331 Password required for ericj.
Password: <strong>*********</strong>
230- OpenBSD 2.6 (GENERIC) #690: Fri Oct 29 16:32:17 MDT 1999
230- 
230- Welcome to OpenBSD: The proactively secure Unix-like operating system.
230- 
230- Please use the sendbug(1) utility to report bugs in the system.
230- Before reporting a bug, please try to reproduce it with the latest
230- version of the code.  With bug reports, please try to ensure that
230- enough information to reproduce the problem is enclosed, and if a
230- known fix for it exists, include that as well.
230- 
230 User ericj logged in.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> <strong>cd /</strong>
250 CWD command successful.
ftp> <strong>ls</strong>
227 Entering Passive Mode (127,0,0,1,60,7)
150 Opening ASCII mode data connection for 'file list'.
altroot
bin
dev
etc
home
mnt
root
sbin
stand
tmp
usr
var
bsd
sys
boot
226 Transfer complete.
ftp> <strong>quit</strong>
221 Goodbye.
</ul></pre>
<p>
Как вы можете видеть, пользователю разрешен доступ ко всем файлам на сервере
(для которых у него есть права). Это не всегда может быть желательным. Чтобы
ограничить доступ пользователю, просто добавьте его имя в файл
<strong>/etc/ftpchroot</strong>, вот пример этого файла с ограничением для
пользователя &quot;ericj&quot;:
</p>
<ul><pre>
$ <strong>cat /etc/ftpchroot</strong>
#       $OpenBSD: faq10.html,v 1.49 2000/10/18 15:15:29 ericj Exp $
#
# list of users (one per line) given ftp access to a chrooted area.
# read by ftpd(8).
ericj
</ul></pre>
<p>
Этого достаточно, чтобы помешать ericj выйти выше своего домашнего каталога.
Как вы увидите в следующем примере, домашний каталог стал для пользователя
корневым !
</p>
<ul><pre>
$ <strong>ftp localhost</strong>
Connected to localhost.
220 oshibana FTP server (Version 6.4/OpenBSD) ready.
Name (localhost:ericj): <strong>ericj</strong>
331 Password required for ericj.
Password: <strong>*********</strong>
230 User ericj logged in.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> <strong>cd /</strong>
250 CWD command successful.
ftp> <strong>ls</strong>
227 Entering Passive Mode (127,0,0,1,92,171)
150 Opening ASCII mode data connection for 'file list'.
.login
.mailrc
.profile
.rhosts
.ssh
.cshrc
work
mail
src
226 Transfer complete.
ftp> <strong>quit</strong>
221 Goodbye.
</ul></pre>

<p>
<a name="10.14">
<h2>10.14 - Использование патчей OpenBSD</h2>
</a>
</p>

<p>
Дерево исходных кодов OpenBSD постоянно изменяется и улучшается, вместе с этим
находятся решения появляющихся проблем и выпускаются патчи (patches). Эти
патчи появляются на странице errrata, расположенной в
<a href="../errata.html">http://www.openbsd.org/ru/errata.html</a>,
(оригинал - в
<a href="http://www.openbsd.org/errata.html">http://www.openbsd.org/errata.html</a>)
рассортированые по архитектурам или архитектурно-независимые патчи.
</p>
<p>
Патчи не добавляют в OpenBSD новых возможностей, они призваны исправлять важные
ошибки и просчеты, для повышения надежности и решения проблем безопасности.
Решение об использовании или неиспользовании патча, всегда остается за
системным администратором.
</p>

<p>
Для примера я использую патч полученный с errata.html для
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=talkd&sektion=8">talkd(8)</a>
(коррекция проблемы безопасности).
</p>

<h3>Как эти патчи отличаются от того что я могу найти в дереве CVS ?</h3>

<p>
Все патчи опубликованные на 
<a href="../errata.html">http://www.openbsd.org/ru/errata.html</a> (оригинал -
<a href="http://www.openbsd.org/errata.html">http://www.openbsd.org/errata.html</a>)
являются патчами для исходного кода последнего релиза. Последние же исходные
коды из дерева CVS могут содержать также и другие изменения,
нежелательные в релизной системе.
</p>

<h3>Подготовка системы к патчам</h3>

<p>
Патчи для Операционной Системы OpenBSD поставляются в виде diff-файлов - 
текстовых файлов, содержащих отличия от оригинального исходного кода. Патчи
<b>НЕ ПОСТАВЛЯЮТСЯ</b> в бинарной форме. Это значит, что для того чтобы
использовать патч, вам необходим исходный код <b>РЕЛИЗНОЙ</b> версии OpenBSD.
Это не значит, что вам необходимы ВСЕ исходные коды, но вы должны иметь на
руках, как минимум, коды того модуля, для которого этот патч сделан. Например,
если это патч какой-то утилиты - необходим весь ее код, если же вы патчите
один из драйверов ядра, необходимо иметь на руках весь исходный код ядра.
</p>
<p>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=cvs&sektion=1">cvs(1)</a>
- удобный инструмент, используя его можно забрать только те исходные коды,
которые вам нужны, через анонимные cvs-сервера расположенные
по всему миру. Их список вы можете найти на странице
<a href="http://www.openbsd.org/ru/anoncvs.html">http://www.openbsd.org/ru/anoncvs.html</a>.  
</p>
<p>
Забрать исходный код текущего релиза (для talkd), используя
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=cvs&sektion=1">cvs(1)</a>,
можно так:
</p>

<div style="margin-left: 2em">
<pre>
$ <b>cvs -danoncvs@anoncvs5.usa.openbsd.org:/cvs co -rOPENBSD_2_7_BASE src/libexec/talkd/</b>
cvs server: Updating src/libexec/talkd
U src/libexec/talkd/announce.c
U src/libexec/talkd/talkd.c
U src/libexec/talkd/talkd.h
</pre>
</div>
<p>
Тропу к нужной ветви дерева СVS можно найти в строке патча <i>Index:</i>.
В нашем случае эта тропа <i>src/libexec/talkd/</i>. Всегда проверяйте версию
[в теге] OPENBSD_номер_версии_BASE. Если в нем отсутствует &quot;BASE&quot;,
[<b>дословно:</b> вам необходимо проверить ветвь -stable, которая может
содержать другие необходимые изменения] [.?.] [В любом случае, на странице
<a href="../plus.html">http://www.openbsd.org/ru/plus.html</a> (оригинал -
<a href="http://www.openbsd.org/plus.html">http://www.openbsd.org/plus.html</a>)
вы всегда можете проверить, какие патчи включены в ветвь патчей. Если необходмые
вам патчи туда не включены, заберите исходные коды последнего релиза, используя
команды обозначенные выше.] 
<br> <b>Оригинал:</b> <br> 
To find the CVS path to the code that you need, you can find this in the patch
on the <i>Index:</i> line. In this case, the CVS path was
<i>src/libexec/talkd/</i>. Always check out the revision of
OPENBSD_version_number_BASE. Without &quot;BASE&quot; you will be checking out
the stable branch, which might contain other changes that will interfere. If
you are already tracking the patch branch, the patches should already be in
that source, however you should always check and make sure. You can always
look at <a href="../plus.html">http://www.openbsd.org/plus.html</a>
to see which patches have been applied to the patch branch. If the patches
haven't been applied yet, you will need to grab the latest release source
using the commands above.
</p>
<p>
Пользователи, имеющие официальный компакт-диск OpenBSD, могут взять
исходный код релиза непосредственно с него, не прибегая к услугам анонимных
CVS-серверов.
</p>
<ul><pre>
Для накладывания патча мы будем использовать команды:
        cd /usr/src
        patch -p0 < 026_talkd.patch
        cd libexec/talkd
        make obj && make depend && make && make install

Index: libexec/talkd/announce.c <b>&lt;------ Тропа к исходникам</b>
===================================================================
RCS file: /cvs/src/libexec/talkd/announce.c,v
retrieving revision 1.8
retrieving revision 1.9
diff -u -r1.8 -r1.9
--- libexec/talkd/announce.c    1998/08/18 03:42:10     1.8
+++ libexec/talkd/announce.c    2000/07/06 00:01:45     1.9
@@ -160,6 +160,6 @@
                *(bptr++) = '\n';
        }
        *bptr = '\0';
-       fprintf(tf, big_buf);
+       fprintf(tf, "%s", big_buf);
        fflush(tf);
 }
</pre></ul>
<p>
Получив исходные коды, вы должны забрать патч и поместить его в каталог
<i>src/</i>
</p>

<h3>Накладывание патча</h3>

<p>
<div style="margin-left: 2em">
<pre>
$ <b>cd /usr/src</b>
$ <b>patch -p0&lt;/path/to/026_talkd.patch</b>
Hmm...  Looks like a unified diff to me...
The text leading up to this was:
--------------------------
|Apply by doing:
|       cd /usr/src
|       patch -p0 < 026_talkd.patch
|       cd libexec/talkd
|       make obj && make depend && make && make install
|
|Index: libexec/talkd/announce.c
|===================================================================
|RCS file: /cvs/src/libexec/talkd/announce.c,v
|retrieving revision 1.8
|retrieving revision 1.9
|diff -u -r1.8 -r1.9
|--- libexec/talkd/announce.c   1998/08/18 03:42:10     1.8
|+++ libexec/talkd/announce.c   2000/07/06 00:01:45     1.9
--------------------------
Patching file libexec/talkd/announce.c using Plan A...
Hunk #1 succeeded at 160. <b>&lt;------------ Патч успешно наложен</b>
done
$ <b>cd /usr/src/libexec/talkd/</b>
$ <b>ls</b>
CVS             announce.c      print.c         table.c         talkd.c
Makefile        announce.c.orig process.c       talkd.8         talkd.h
$ <b>make obj && make depend && make</b>
making /home/ericj/lsrc/src/libexec/talkd/obj
mkdep -a /home/ericj/lsrc/src/libexec/talkd/talkd.c /home/ericj/lsrc/src/libexec/talkd/announce.c /home/ericj/lsrc/src/libexec/talkd/process.c /home/ericj/lsrc/src/libexec/talkd/table.c /home/ericj/lsrc/src/libexec/talkd/print.c
cc -O2     -c /home/ericj/lsrc/src/libexec/talkd/talkd.c
cc -O2     -c /home/ericj/lsrc/src/libexec/talkd/announce.c
cc -O2     -c /home/ericj/lsrc/src/libexec/talkd/process.c
cc -O2     -c /home/ericj/lsrc/src/libexec/talkd/table.c
cc -O2     -c /home/ericj/lsrc/src/libexec/talkd/print.c
cc   -o ntalkd talkd.o announce.o process.o table.o print.o
nroff -Tascii -mandoc /home/ericj/lsrc/src/libexec/talkd/talkd.8 > talkd.cat8
$ <b>sudo make install</b>
install -c -s -o root -g bin  -m 555 ntalkd /usr/libexec
install -c -o root -g bin -m 444 talkd.cat8 /usr/share/man/cat8/talkd.0
/usr/share/man/cat8/ntalkd.0 -> /usr/share/man/cat8/talkd.0
</pre>
</div>

<p>
Теперь вы можете перезапустить talkd.
</p>

<p>
<font color= "#0000e0">
<a href= "index.html">[Назад в Главный Индекс]</a>
<a href= "faq9.html">[К секции 9.0 - Переход из Linux-а]</a>
<a href= "faq11.html">[К секции 11.0 - Настройка оптимальной
производительности]</a>
</font>
</p>
<p>
<hr>
<a href= "index.html"><img height= "24" width= "24" src="../../images/back.gif" border= "0" alt="[назад]"></a>
<a href="mailto:www@openbsd.ru">www@openbsd.ru</a>
<br>
<small>
$RuOBSD$<br>
$Translation$<br>
$OpenBSD$
</small>
</p>
</body>
</html>

