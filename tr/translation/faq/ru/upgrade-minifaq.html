<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=koi8-r">
    <title>Mini-FAQ по обновлению OpenBSD</title>
  </head>

  <body bgcolor="#FFFFFF" text="#000000" link="#23238E">

    <h1>Mini-FAQ: Обновляем OpenBSD</h1>

    <h2>Последний релиз - 3.3</h2>

    <address>
      <p>Kjell Wooding 
	&lt;<a href="mailto:kjell@openbsd.com">kjell@openbsd.org</a>&gt;<br>
	Обновлен: 
	$OpenBSD: upgrade-minifaq.html,v 1.172 2003/07/14 20:15:56 nick Exp $</p>
    </address>
    <br>
    
    <blockquote>
     
      <p>Этот Mini-FAQ - попытка собрать наиболее часто задаваемые 
      вопросы, при обновлении на новый релиз, 
      или с релиза на <em>-current</em>. Хотя его трудно назвать 
      <em>Mini</em>, все же документ носит это название для 
      согласованности и в силу исторических соображений. 
      Информацию по старым версиям вы можете найти в <a href=
      "../upgrade-old.html">отдельном документе</a>.</p>
    </blockquote>

    <p>
      Upgrade-MiniFAQ рассчитан на <b>продвинутых пользователей</b>. 
      Если вы новичок или <b>недостаточно уверены в своих силах</b>, 
      тогда обновление с исходников <b>не для вас</b>. Вместо этого 
      установите релиз или снапшот и после обновите
      <tt>/etc</tt>, используя соответствующую инструкцию.
    </p>

    <h2>Общие вопросы</h2>
    
    <p>
      <a href="#1.1">1.1: Терминология. Что такое <em>-current</em>? 
    Что такое снапшоты? Что такое <em>-stable</em>?</a><br>
      
      <a href="#1.2">1.2: Как легче всего перейти на 
	<em>-current</em>?</a><br>
      
      <a href="#1.3">1.3: Я не нашел нужных снапшотов на FTP. 
    Куда они делись?</a><br>
      
      <a href="#1.4">1.4: Как получить последнюю версию исходного 
    кода?</a><br>
      
      <a href="#1.5">1.5: У меня есть дерево исходников. 
    Как мне их собрать?</a><br>
      
      <a href="#1.6">1.6: Моя сборка прервалась на полпути. 
    Нужно ли начинать с самого начала?</a><br>
      
      <a href="#1.7">1.7: Возникают ошибки в процессе сборки. 
    Что я должен делать?</a><br>
      
      <a href="#1.8">1.8: Есть ли стандартный путь для обновления 
    компилятора, <em>gcc</em>?</a><br>
      
      <a href="#1.9">1.9: Как лучше всего обновить 
	<tt>/etc</tt>, <tt>/var</tt> и <tt>/dev</tt>?</a><br>
      
      <a href="#1.10">1.10: Как удалить все лишнее из моего дерева
    исходников?</a><br>
      
      <a href="#1.11">1.11: Должен ли я иметь root привилегии для выполнения 
    <em>make build</em>?</a><br>
      
      <a href="#1.12">1.12: Почему я не вижу новых устройств?</a><br>
      
      <a href="#1.13">1.13: Как проще обновить иерархию файлов?</a><br>

      <a href="#1.14">1.14: После обновления <em>ps</em> выдает 
    "proc size mismatch."</a><br>

      <a href="#1.15">1.15: Как обновиться со снапшотов?</a><br>
    </p>
    
    <h2>Обновляем с 3.3</h2>

    <p>
      <a href="#3.3.1">3.3.1: Поддержка W^X на i386</a><br>
      <a href="#3.3.2">3.3.2: Изменение системного вызова mquery</a><br>
      <a href="#3.3.3">3.3.3: Изменение базового адреса и MAXDSIZ у исполняемых файлов, для i386</a><br>
      <a href="#3.3.4">3.3.4: Изменение config</a><br>
      <a href="#3.3.5">3.3.5: Использование __attribute__((bounded)) в 
        определенных функциях</a><br>
    </p>
    
    <h2>Обновляем с 3.2</h2>
    
    <p>
      <a href="#3.2.1">3.2.1: Новый Perl</a><br>
      <a href="#3.2.2">3.2.2: Новые группы _radius, _token и _shadow</a><br>
      <a href="#3.2.3">3.2.3: Важные изменения в компиляторе</a><br>
      <a href="#3.2.4">3.2.4: Новые пользователь и группа _spamd</a><br>
      <a href="#3.2.5">3.2.5: Псевдоним для ipv6-icmp</a><br>
      <a href="#3.2.6">3.2.6: Новая группа _lkm</a><br>
      <a href="#3.2.7">3.2.7: Новая libpthread</a><br>
      <a href="#3.2.8">3.2.8: Изменения компоновщика на ELF архитектурах</a><br>
      <a href="#3.2.9">3.2.9: Удаление /var/at и изменения crontab</a><br>
    </p>
    
    <h2>Обновляем с 3.1</h2>
    
    <p>
      <a href="#3.1.1">3.1.1: Новые пользователи и группы</a><br>
      <a href="#3.1.2">3.1.2: Новая группа для crontab(1) и at(1)</a><br>
      <a href="#3.1.3">3.1.3: Новые Binutils</a><br>
      <a href="#3.1.4">3.1.4: Новая конфигурация S/Key</a><br>
      <a href="#3.1.5">3.1.5: Новые разрешения для lp*</a><br>
      <a href="#3.1.6">3.1.6: atrun(8) больше не используется</a><br>
      <a href="#3.1.7">3.1.7: nat.conf перенесен в pf.conf</a><br>
      <a href="#3.1.8">3.1.8: Новая запись в fbtab для xdm</a><br>
      <a href="#3.1.9">3.1.9: Использование __attribute__((sentinel)) в 
        определенных функциях</a><br>
    </p>

    <h2>Обновляем с 3.0</h2>
    
    <p>
      <a href="#3.0.1">3.0.1: mtree(8) поддерживает новое ключевое слово</a><br>
      <a href="#3.0.2">3.0.2: Удаление libdl на ELF платформах</a><br>
      <a href="#3.0.3">3.0.3: Новый регрессивный каркас</a><br>
      <a href="#3.0.4">3.0.4: Конфигурационные файлы ssh перенесены в /etc/ssh/</a><br>
    </p>
    
    <h2>Обновляем с 2.9</h2>

    <p>
      <a href="#2.9.1">2.9.1: Новые пользователи и группы - <em>proxy</em>,
	<em>smmsp</em> и <em>popa3d</em></a><br>

      <a href="#2.9.2">2.9.2: Новый пакетный фильтр: <em>pf</em></a><br>

      <a href="#2.9.3">2.9.3: Изменение <em>make</em></a><br>

      <a href="#2.9.4">2.9.4: Изменения в KerberosV, препятствуют 
        процессу сборки</a><br>

      <a href="#2.9.5">2.9.5: Новая версия <em>sendmail'а</em></a><br>

      <a href="#2.9.6">2.9.6: Переименование <tt>/etc/primes</tt></a>

    </p>
    

    <h2>Обновление с более ранних версий</h2>

    <p>Информация по обновлению OpenBSD версий с 2.3 по 2.8 
      вынесена в <a href="../upgrade-old.html">отдельный 
	  документ</a>.</p>


    &nbsp;<hr width="30%">

    <a name="1.0"></a> 
    <h2>Общие вопросы</h2>

    <a name="1.1"></a> 
    <h3>1.1: Терминология. Что такое <em>-current</em>? 
      Что такое снапшоты? Что такое <em>-stable</em>?</h3>
    
    <p>До версии 2.7 весь код OpenBSD располагался в единой 
      ветке репозитория, позже была введена 
      <a href="../../ru/stable.html">ветка исправлений</a>, названная 
      <em>-stable</em>. В ней содержится базовый релиз 
      и наиболее важные исправления (важными считаются патчи ошибок
      и некоторые другие, по разным причинам не попавшие в список
      ошибок и исправлений).</p>
    
    <p>Каждые полгода выходит <em>релиз</em>, номера <em>релизам</em>
      присваиваются обычным образом (2.x, 3.x). Номер последнего
      <em>релиза</em> указан в начале этого документа.</p>
    
    <p><em>-current</em>, сокращение от <em>openbsd-current</em>, 
      указывает на ветку, содержащую самый последний код, хранящийся в CVS 
      репозитории. Обычно этой веткой пользуются разработчики OpenBSD. 
      В <em>-current</em> содержится весь код, который планируют 
      поместить в следующий релиз. Время от времени, смельчаки переходят 
      с релизов на <em>current</em>, обычно для того, что бы получить 
      преимущества, которых еще нет в последнем релизе. Обновление до 
      -current не рекомендовано нетехническим пользователям, так как 
      система может оказаться нестабильной.</p>
    
    <p>Между релизами, становятся доступны 
      <a href="ftp://ftp.openbsd.org/pub/OpenBSD/snapshots/">выпуски 
      <em>снапшотов</em></a>. <em>Снапшоты</em> - тестовые релизы 
      <em>-current</em> дерева. Поскольку они являются отражением текущего 
      статуса разработки, нет никаких гарантий, что они будут работать 
      корректно (или вообще будут работать). <em>Снапшоты</em> наиболее 
      полезны при обновлении с релиза (или старой версии <em>-current</em>) 
      до <em>-current</em>. Если вы используете <em>-current</em>, 
      настоятельно рекомендуется подписаться на список рассылки 
      <em>source-changes</em>, сюда приходят сообщения обо всех наиболее 
      важных изменениях.</p>
    
    <p><a href="../../ru/ports.html">Дерево портов</a> является 
      неотъемлемой частью системы, так что обновлять их нужно синхронно. 
      То есть у вас должны быть -stable порты на -stable системе 
      и -current порты на -current системе.</p>

    <a name="1.2"></a>
    <h3>1.2: Как легче всего перейти на 
	<em>-current</em>?</h3>
    
    <p>В связи с изменением основных библиотек, напрямую обновляться 
      до <em>-current</em> не совсем простой путь. Более безболезненный
      метод, это <a href="#1.15">обновление последними снапшотами</a>. 
      После того как снапшоты установлены, можно <a href="#1.4">взять</a>
      последнюю версию кода и выполнить <a href="#1.5">пересборку</a> 
      системы. Этот путь должен устранить большинство проблем с утилитами
      и библиотеками.</p>

    <a name="1.3"></a> 
    <h3>1.3: Я не нашел нужных снапшотов на FTP. 
    Куда они делись?</h3>
    
    <p>Снапшоты удаляются по мере их устаревания. Если вы действительно
      не обнаружили снапшотов, обновитесь до последнего релиза и, 
      получив последнюю версию кода, пересоберите систему.</p>

    <a name="1.4"></a> 
    <h3>1.4: Как получить последнюю версию исходного 
      кода?</h3>

    <p>Короткий ответ: 
      <a href="../../ru/anoncvs.html">http://www.openbsd.org/ru/anoncvs.html</a></p>
    
    <p>Например, для извлечения всего дерева через CVS: (используется 
      оболочка ksh. В других случаях может потребоваться замена 
      <em>export</em> на <em>setenv</em>)</p>

<pre>
  # export CVSROOT=anoncvs@anoncvs.ca.openbsd.org:/cvs
  # export CVS_RSH=/usr/bin/ssh
  # cd /usr
  # cvs -q get -P src
</pre>

    <p>Этот пример вытягивает -current. Если требуется что-то другое, 
      можно воспользоваться ключом <tt>-r</tt>. 
      Вот пример, получения 3.2-stable:</p>

<pre>
  # cvs -q get -rOPENBSD_3_2 -P src
</pre>

    <a name="1.5"></a> 
    <h3>1.5: У меня есть дерево исходников. 
      Как мне их собрать?</h3>
    
    <p>Основные инструкции находятся в  
      <a href="http://www.openbsd.org/cgi-bin/cvsweb/src/Makefile"
	 ><tt>/usr/src/Makefile</tt></a>.
      Здесь приводится расширенная справка.</p>
    
    <ol>
      <li>
        <p>Удаляем старые объектные файлы.</p>
	
        <p>Если вы создали отдельную /usr/obj директорию, очистите 
          ее и перестройте символические ссылки:</p>

<pre>
  # rm -rf /usr/obj/*
  # cd /usr/src
  # make obj
</pre>

        <p>Если вы делаете это достаточно часто, более быстрым способом 
          будет, поместить /usr/obj в отдельный раздел и использовать 
          <em>newfs</em> взамен <em>rm</em>. Для примера можно делать 
          так:</p>

<pre>
  # umount /usr/obj
  # newfs wd0h
  # mount /usr/obj
  # make obj
</pre>

        <p>Если вас беспокоит наличие объектных файлов в дереве исходников,
          сделайте следущее:</p>

<pre>
  # cd /usr/src
  # find . -type l -name obj | xargs rm
  # make cleandir
  # rm -rf /usr/obj/*
  # make obj
</pre>

      </li>
      
      <li>
        <p>Выполняем зависимые от версии изменения. Например пользовали 
          2.3 должны добавить пользователя и группу <em>named</em>,
          прежде чем переходить на версию 2.4 или более позднюю. 
          Обратитесь к конкретному разделу Mini-FAQ'а в соответствии 
          с вашей версией.</p>
      </li>
      
      <li>
        <p>Убедитесь, что созданы все требуемые директории. Особенно это 
          касается перехода от старых версии, хотя иногда требуется и в 
          нескольких других случаях. Наиболее простой путь для этого:</p>
<pre>
  # cd /usr/src/etc &amp;&amp; make DESTDIR=/ distrib-dirs
</pre>

      </li>

      <li>
        <p>Компилируем новое ядро.</p>
<pre>
  # cd /usr/src/sys/arch/`machine`/conf
</pre>

        <p>Большинству пользователей подойдет GENERIC:</p>
<pre>
  # config GENERIC
  # cd ../compile/GENERIC
</pre>

        <p><strong>ЗАМЕЧАНИЕ:</strong> Настоящие мазохисты могут собрать 
          специфичное ядро. В этом случае обычно лучше взять GENERIC и 
          приспособить его под свои нужды. Выполните следующую процедуру:</p>
<pre>
  # cp GENERIC MYKERNEL
  # vi MYKERNEL
  (отредактируйте MYKERNEL по вашему усмотрению)
  # config MYKERNEL
  # cd ../compile/MYKERNEL
</pre>

        <p>Дальше в любом случае,</p>
<pre>
  # make clean &amp;&amp; make depend &amp;&amp; make
  (для архитектуры arc) скопируйте bsd.ecoff на ваш FAT раздел
  # cp /bsd /bsd.old &amp;&amp; cp bsd /bsd
  # chown root:wheel /bsd (если вы компилировали не под root'ом)
  (перезагружаемся)
</pre>
      </li>

      <li>
        <p>Собираем систему.</p>
<pre>
  # cd /usr/src
  # make build
</pre>
      </li>

      <li>
        <p>Вручную обновите <tt>/etc</tt> и <tt>/dev</tt>, так как они не 
          обновляются автоматически. Выберите директорию, в которой хватит 
          места для хранения /, /dev, /var и /etc, можно использовать 
          <em>/home/newroot</em></p>
<pre>
  # mkdir /home/newroot          
  # export DESTDIR=/home/newroot
  # cd /usr/src/etc &amp;&amp; make distribution-etc-root-var
</pre>

        <p>Теперь сравните файлы из /home/newroot с их установленными 
          аналогами. В случае необходимости замените или обновите 
          последние.</p>
<pre>
  # rm -rf /home/newroot   (когда закончите)
</pre>
      </li>

      <li>
        <p>Перезагрузитесь, чтобы убедиться, что новые файлы /etc не 
          содержат ошибок.</p>
      </li>
    </ol>

    <a name="1.6"></a> 
    <h3>1.6: Моя сборка прервалась на полпути. 
      Нужно ли начинать с самого начала?</h3>

    <p>Рекомендуется, но если вы действительно хотите продолжить с того 
      места, где остановились в прошлый раз, сделайте следующее:</p>
<pre>
  # cd /usr/src
  # make -n build
</pre>

    <p>Это покажет вам что делает make build. Например может 
      получиться следущее:</p>
<pre>
  (cd /usr/src/share/mk &amp;&amp;  make install)
  (cd /usr/src/include; make prereq;  make includes)
  make cleandir
  (cd /usr/src/lib &amp;&amp; make depend &amp;&amp; make &amp;&amp;   make install)
  (cd /usr/src/gnu/lib &amp;&amp; make depend &amp;&amp; make &amp;&amp;   make install)
  (cd /usr/src/kerberosIV/lib &amp;&amp; make depend &amp;&amp; make &amp;&amp;   make install)
  (cd /usr/src/gnu/usr.bin/perl &amp;&amp;  make -f Makefile.bsd-wrapper config.sh &amp;&amp;  make -f Makefile.bsd-wrapper depend &amp;&amp;  make -f Makefile.bsd-wrapper perl.lib &amp;&amp;
  make -f Makefile.bsd-wrapper install.lib)
  make depend &amp;&amp; make &amp;&amp;  make install
</pre>

    <p>Чтобы продолжить, просто выполните те команды, на которых
      вы остановились в прошлый раз.</p>
    
    <p>Если это кажется вам утомительным, можно создать новую цель в вашем 
      makefile'е. Просто скопируйте содержимое цели <em>build</em> (например в 
      <em>build-noclean</em>) и удалите ссылки на <em>make cleandir</em>.</p>

    <a name="1.7"></a> 
    <h3>1.7: Возникают ошибки в процессе сборки. 
      Что я должен делать?</h3>
    
    <p>Если выполнение команды <em>make build</em> заканчивается ошибкой,
      возможно, что перед сборкой вы не удалили старые объектные файлы. 
      Обратитесь к разделу <a href="#1.5">1.5</a> за более подробной 
      информацией.</p>

    <p>Если после этого ошибка повторяется, то могло произойти следующее:</p>
    
    <ol>
      <li>Вам встретилась известная проблема при обновлении. Убедитесь, что 
         вы прочли соответствующий раздел этого документа, и тщательно 
         выполнили его инструкции.</li>
      
      <li>Вам встретилась новая проблема при обновлении. Попробуйте поискать 
         решение своей проблемы в рассылках 
         <a href="../../ru/mail.html">misc@ и tech@</a>.</li>
      
      <li>Кто-то временно повредил дерево исходников. Это случается крайне 
         редко, и обычно немедленно исправляется. Попробуйте подождать 
         несколько часов и опять обновить дерево исходников. Если вы не 
         можете ждать, попробуйте вытянуть дерево одно-двухдневной давности</li>
    </ol>

    <p>Если вы перепробовали все вышеуказанные способы и ваша проблема 
      остается неразрешенной в течении нескольких дней, напишите о ней 
      в misc@openbsd.org. Убедитесь, что вы включили в письмо соответствующее 
      сообщение об ошибке и всю специфичность вашей установки.</p>

    <a name="1.8"></a> 
    <h3>1.8: Есть ли стандартный путь для обновления компилятора 
      (<em>gcc</em>)?</h3>

    <p>Поскольку проблема обновления компилятора сродни вопросу о 
      курице-и-яйце, изменения в дереве компилятора требуют немного большего 
      внимания. В общем, вам нужно выполнить следующие шаги:</p>

    <p>(замечание: сборку нужно действительно выполнить два раза)</p>

<pre>
  # rm -r /usr/obj/gnu/egcs/gcc/*
  # cd /usr/src/gnu/egcs/gcc
  # make -f Makefile.bsd-wrapper clean
  # make -f Makefile.bsd-wrapper obj
  # make -f Makefile.bsd-wrapper depend
  # make -f Makefile.bsd-wrapper 
  # make -f Makefile.bsd-wrapper install
  # make -f Makefile.bsd-wrapper clean
  # make -f Makefile.bsd-wrapper depend
  # make -f Makefile.bsd-wrapper 
  # make -f Makefile.bsd-wrapper install
</pre>

    <p>И потом нормально запустить <em>make build</em>.</p>

    <p>Вы можете ускорить этот процесс, используя процедуру BOOTSTRAP:</p>

<pre>
  # cd /usr/src/gnu/egcs/gcc
  # make -f Makefile.bsd-wrapper clean
  # make -f Makefile.bsd-wrapper obj
  # make -f Makefile.bsd-wrapper -DBOOTSTRAP
  # make -f Makefile.bsd-wrapper -DBOOTSTRAP install
  # make -f Makefile.bsd-wrapper clean
  # make -f Makefile.bsd-wrapper
  # make -f Makefile.bsd-wrapper install
</pre>

    <a name="1.9"></a> 
    <h3>1.9: Как лучше всего обновить 
	   <tt>/etc</tt>, <tt>/var</tt> и <tt>/dev</tt>?</h3>
    
    <p><strong>Короткий ответ</strong>: Вручную.</p>
    
    <p><strong>Подробный ответ</strong>:</p>

    <p>Согласно политике OpenBSD, программное обеспечение не изменяет 
      файлов в <tt>/etc</tt> автоматически. Это значит, что <em>все нужные
      изменения</em> должен делать администратор. Обновление не 
      исключение. Перед обновлением этих директорий, определите различие 
      новых фалов с базовыми, и далее вручную проделайте изменения.</p>

    <p>Например, для просмотра недавно измененных файлов, сделайте:</p>

<pre>
  # cd /usr/src/etc
  # ls -lt |more
</pre>

    <p>Для просмотра различий в <tt>/etc</tt> между двумя релизами можно 
      воспользоваться <a href="../../ru/anoncvs.html">CVS</a>. Например, различие 
      между 3.1 и 3.2 можно увидеть так:</p>

<pre>
  # cd /usr/src/etc
  # cvs diff -u -rOPENBSD_3_1 -rOPENBSD_3_2
</pre>

    <p>После определения изменений, обновите свою директорию /etc, 
      сохраняя нужные вам настройки.</p>

    <p>Ниже приведены типичные изменения в <tt>/etc</tt> между 
      двумя релизами:</p>
     
    <ul>
      <li>Дополнения в <tt>/etc/protocols</tt> и <tt>/etc/services</tt></li>
      <li>Новое в sysctl. (смотрим <tt>/etc/sysctl.conf</tt>)</li>
      <li>Изменения в стандартных задачах cron'а. 
         Смотрим <tt>/etc/daily</tt>, <tt>/etc/weekly</tt>, 
         <tt>/etc/monthly</tt> и <tt>/etc/security</tt>
      </li>
      <li>Все rc скрипты, включая netstart</li>
      <li>Изменения устройств. Смотрим
    <a href="#1.12">1.12</a>
      </li>
      <li>Изменение файловой иерархии в <tt>/etc/mtree</tt>. Смотрим 
	<a href="#1.13">1.13</a>
      </li>
      <li>
    Новые пользователи (<tt>/etc/passwd</tt>) и группы (<tt>/etc/group</tt>) 
      </li>
    </ul>


    <a name="1.10"></a> 
    <h3>1.10: Как удалить все лишнее из моего дерева
       исходников?</h3>
    
    <p>Наиболее важная вещь которую вы можете сделать это очистить ваши obj 
      директории. Вот процедура обновления исходников и очистки от старых 
      объектов:</p>

<pre>
  # cd /usr/src
  # cvs -q -d anoncvs@some.anon.server:/cvs up -Pd
  # find . -type l -name obj | xargs rm
  # make -k cleandir
  # rm -rf /usr/obj/*
  # make obj
</pre>

    <p>Если у вас все еще возникают проблемы, вы можете попробовать добавить 
      ключи <tt>-I ! -I CVS -I obj</tt> к вашей команде CVS update. Это выявит 
      дополнительный мусор в ваших исходниках.</p>

    <a name="1.11"></a> 
    <h3>1.11: Должен ли я иметь root привилегии для выполнения 
       <em>make build</em>?</h3>

    <p>Хоть некоторые этапы работы команды make build и требуют root 
      привилегий, она использует команду 
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sudo&amp;sektion=8"
     >sudo(8)</a>, делая процесс сборки сравнительно простым.</p>

    <p>Если ваш файл <tt>/etc/sudoers</tt> правильно сконфигурирован, 
      вы можете использовать sudo следующим образом:</p>
    
    <ul>
      <li>установить SUDO=/usr/bin/sudo в вашем окружении перед началом 
         сборки, или</li>

      <li>добавить строку "SUDO=/usr/bin/sudo" в ваш файл 
	<tt>/etc/mk.conf</tt>.</li>
    </ul>

    <a name="1.12"></a> 
    <h3>1.12: Почему я не вижу новых устройств?</h3>
    
    <p>Скрипт <tt>/dev/MAKEDEV</tt> не обновляется автоматически при 
      работе команды <em>make build</em>. Хорошей идеей будет скопировать 
      и запустить этот скрипт из дерева исходников:</p>

<pre>
  # cd /dev
  # cp /usr/src/etc/etc.`machine`/MAKEDEV ./
  # ./MAKEDEV all
</pre>

    <a name="1.13"></a> 
    <h3>1.13: Как проще обновить иерархию файлов?</h3>

    <p>Время от времени в файловой иерархии могут произойти изменения, 
      связанные с удалением и добавлением новых файлов и директорий или 
      изменением собственной информации частей файловой системы. Чтобы 
      убедиться, что ваша файловая иерархия обновлена, воспользуйтесь утилитой 
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8">
      mtree(8)</a>.</p>
    
    <p>Сначала получите последнюю версию исходников, а затем проделайте 
      следующее:</p>

<pre>
  # cd /usr/src/etc/mtree
  # install -c -o root -g wheel -m 600 special /etc/mtree
  # install -c -o root -g wheel -m 444 4.4BSD.dist /etc/mtree
  # mtree -qdef /etc/mtree/4.4BSD.dist -p / -u
</pre>

    <p>Теперь ваша файловая иерархия обновлена.</p>

    <a name="1.14"></a> 
    <h3>1.14: После обновления <em>ps</em> выдает 
       "proc size mismatch."</h3>

    <p>
      Такое происходит, если не синхронизированы ядро и пользовательские 
      программы. Пересборка ядра и пользовательских программ с одних 
      исходников решит эту проблему.
    </p>
    
    <p>
      Поскольку вы уже допустили одну ошибку, самое время перечитать 
      этот документ с начала, что бы убедится в том, что вы больше 
      ничего не упустили.
    </p>


    <a name="1.15"></a>
    <h3>1.15: Как обновиться со снапшотов?</h3>

    <p>
      Установка снапшотов - хороший способ поддерживать обновление 
      системы. Мы заинтересованы в тестировании снапшотов, особенно 
      бета-версий, что бы убедиться, что следующий релиз получится 
      качественным. К тому же этот способ гораздо проще, чем обновление 
      исходниками.
    </p>

    <p>
      Простейший способ что б получить <em>-current</em> - взять 
      загрузочный образ и подготовиться как описано в 
      <a href="faq4.html">FAQ</a>. После загрузки, выбираем 
      &quot;(U)pgrade&quot; и следуем инструкциям.
    </p>

    <p>
      Есть несколько способов запустить обновление системы. Наиболее 
      простой - загрузится с дискеты или CD-ROM или поместить ядро 
      -current <a href="faq4.html#bsd.rd">bsd.rd</a> в / и загрузить
      его вместо <tt>/bsd</tt>. 
      Остальные опции позволяют загрузиться с сети или с ленточного 
      устройства. Не каждый из этих методов доступен на всех архитектурах, 
      для получения подробной информации обратитесь к инструкции 
      по установке.
    </p>

    <p>
      Хотя обновление во время работы системы иногда и срабатывает, его лучше 
      избегать. Единственный безопасный способ обновления - загрузиться с 
      нового установочного носителя, как описано выше. 
    </p>

    <p>
      В любом случае, вы должны вручную обновить 
      <a href="#1.9">/etc, /var и /dev</a>
    </p>

    <a name="3.3"></a>
    <h2>
      Обновляем с 3.3
    </h2>
    
    <a name="3.3.1"></a>
    <h3>
      3.3.1: Поддержка W^X на i386 (2003/04/16)
    </h3>

    <p>Что бы задействовать Writable xor eXecute на платформе i386, 
      в OpenBSD/i386 был изменен исполняемый формат с a.out на ELF. 
      Гибкость ELF позволяет обеспечить лучший контроль над исполняемым 
      форматом, который учитывает поддержку W^X. Совместимость с a.out 
      осталась только в урезанной форме. Статические a.out бинари будут 
      работать как раньше, а динамические БОЛЕЕ НЕ ПОДДЕРЖИВАЮТСЯ.
    </p>
    <p>ОБНОВЛЕНИЕ ИСХОДНИКАМИ С a.out -> ELF НЕ БУДЕТ ПОДДЕРЖИВАТЬСЯ. 
      УСТАНОВИТЕ СНАПШОТ и, после этого, пересоберите систему. Все 
      вышесказанное применимо только к архитектуре i386, остальные 
      остались не затронутыми.
    </p>

    <a name="3.3.2"></a>
    <h3>
      3.3.2: Изменение системного вызова mquery (2003/04/28)
    </h3>

    <p>Параметры системного вызова mquery изменились в соответствии с mmap().
      Это требует обновить систему в правильном порядке: 

      <pre>
      1. Собрать и загрузить новое ядро.
      2. (cd /usr/src && sudo make includes)
      3. (cd /usr/src/libexec/ld.so && make && sudo make install)
      4. 'make build'
      </pre>

      mquery используется только на i386 архитектуре, так что остальные 
      архитектуры могут проигнорировать этот порядок.

    <a name="3.3.3"></a>
    <h3>
      3.3.3: Изменение базового адреса и MAXDSIZ у исполняемых 
      файлов, для i386 (2003/05/05)
    </h3>

    <p>Чтобы позволить MAXDSIZ изменится обратно до 1G, базовый
      адрес всех исполняемых модулей изменился с 0 на 0x1c000000. 
      Комбинация этих изменений требует обновления снапшотом. 
      Обновление исходниками не поддерживается. Только для i386.
    </p>

    <a name="3.3.4"></a>
    <h3>
      3.3.4: Изменение <tt>config</tt> (2003/05/23)
    </h3>

    <p>Перемещение swapgeneric.c вызвало изменение 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=config&amp;sektion=8">config(8)</a>.
    Перед сборкой нового ядра, вы должны собрать и установить обновленный config(8):
<pre>
  # cd /usr/src/usr.sbin/config
  # make clean
  # make obj
  # make
  # make install
</pre>
      Теперь, сконфигурируйте ядро и выполните "<tt>make depend</tt>" в
      директории компиляции ядра как описано <a href="#1.5">выше</a>.

   <a name="3.3.5"></a>
   <h3>
    3.3.5: Использование __attribute__((bounded)) в 
        определенных функциях (2003/06/26)
   </h3>
      
   <p>
     __attribute__((bounded)) теперь используется для определения 
     неверных аргументов в функциях принимающих длину буфера, 
     как один из параметров.
     <br><br>Вы должны пересобрать gcc, следуя указаниям раздела 
     <a href="#1.8">1.8</a>,
     прежде чем выполнить <tt>make build</tt>.
   </p>

    <a name="3.2"></a>
    <h2>
      Обновляем с 3.2
    </h2>

    <a name="3.2.1"></a>
    <h3>
      3.2.1: Новый Perl (2002/11/05)
    </h3>

    <p>Perl был обновлен до версии 5.8.0.<br>
      В Perl 5.8.0, в API модуля XS, stdio заменен на PerlIO 
      (смотрите ман perldelta для подробной информации). 
      Это значит что все XS модули (perl'овские .so файлы), 
      которые у вас установлены, <strong>должны</strong> быть 
      пересобраны. Если вы столкнетесь с ошибкой типа 
      <em>Undefined symbol "perl_get_sv"</em> это будет вашей проблемой. 
      Если все XS модули вы устанавливали с пакетов или портов, 
      вы можете проверить их наличие командой:
      <pre>
	# grep '\.so' /var/db/pkg/p5-*/+CONTENTS | cut -d: -f1 | sort -u
      </pre>
      Далее вы можете удалить эти модули, используя команду 
      <em>pkg_delete -f</em>, и пересобрать/установить их с портов.

    <a name="3.2.2"></a>
    <h3>
      3.2.2: Новые группы _radius, _token и _shadow (2002/11/21)
    </h3>
    <p>Было добавлено несколько новых групп:
      <ul>
      <li>Группа <em>_radius</em> создана для доступа "только-чтение" к файлу 
	  <tt>/etc/raddb/servers</tt>.
      <li>Группа  <em>_token</em> создана для доступа "только-чтение" к базам 
      данных используемых
	  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tokeninit&amp;sektion=8">tokeninit(8)</a>,
	  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tokenadm&amp;sektion=8">tokenadm(8)</a> и
	  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=login_token&amp;sektion=8">login_token(8)</a>.
      <li>Группа <em>_shadow</em> создана для доступа "только-чтение"
	  к базе данных теневых паролей.
      </ul>

      Вам требуется добавить эти группы и установить права на некоторые 
      файлы перед запуском &quot;make build&quot;. Следующие команды, 
      запущенные от имени root'а, сделают это:
	<pre>
	  # groupadd -g 63 _radius
	  # chgrp _radius /etc/raddb /etc/raddb/servers
	  # chmod g+x /etc/raddb
	  # chmod g+r /etc/raddb/servers

	  # groupadd -g 64 _token
	  # chgrp _token /etc/activ.db /etc/crypto.db /etc/snk.db
	  # chmod 0640 /etc/activ.db /etc/crypto.db /etc/snk.db

	  # groupadd -g 65 _shadow
	  # chgrp _shadow /etc/spwd.db
	  # chmod 0640 /etc/spwd.db
	</pre>
      Не беспокойтесь в ответ на ошибки, указывающие на то, что некоторые 
      из файлов не найдены. Это значит, что у вас не установлена 
      аунтефикация <em>token</em> или <em>radius</em>.

    <a name="3.2.3"></a>
    <h3>
      3.2.3: Важные изменения в компиляторе (2002/12/02)
    </h3>
    <p>В <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=gcc-local&amp;sektion=1"
      >gcc</a> было добавлено <a href="http://www.trl.ibm.com/projects/security/ssp">
      нововведение</a>
      для защиты стека. Это требует несколько изменить сценарий обновления:
      <ul>
      <li>Пока <b>не</b> собирайте новое ядро.
      <li>Пока <b>не</b> пересобирайте gcc.
      <li>Соберите и установите новый динамический загрузчик ld.so, если в вашей системе 
         используются общие библиотеки.
        <pre>
	  # cd /usr/src
	  # make obj
          Для ELF платформ (alpha, macppc, sparc, sparc64):
          # cd /usr/src/libexec/ld.so
          # make depend &amp;&amp; make &amp;&amp; make install
	  Для a.out платформ (amiga, hp300, i386, mac68k, mvme68k):
          # cd /usr/src/gnu/usr.bin/ld/rtld
          # make depend &amp;&amp; make &amp;&amp; make install
	</pre>
      <li>Пересоберите и установите новую libc, следуя  
         первым командам из <i>make build</i>.
	<pre>
          # cd /usr/src/include
	  # make prereq &amp;&amp; make includes
	  # cd /usr/src/lib/libc
	  # make depend &amp;&amp; make NOMAN=1 &amp;&amp; make NOMAN=1 install
	</pre>
	Если ваш компилятор слишком стар, собрать libc не получится. 
	В этом случае обновитесь снапшотом.
      <li>Пересоберите и установите gcc, как описано в разделе 
         <a href="#1.8">1.8</a>.
      <li>Теперь вы можете перекомпилировать ядро. 
        Убедитесь, что запустили 
        <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=config&amp;sektion=8"
	>config</a> для регенерации Makefile ядра.
      <li>Перезагрузитесь с новым ядром и выполните <i>make build</i> 
         для получения преимуществ защиты стека.
      </ul>

    <a name="3.2.4"></a>
    <h3>
      3.2.4: Новые пользователь и группа _spamd (2002/12/24)
    </h3>
    <p>Были добавлены новый пользователь и группа _spamd для работы демона  
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=spamd&amp;sektion=8"
      >spamd(8)</a>.
      Добавьте эту группу, выполнив:
<pre>
  # groupadd -g 62 _spamd
</pre>
      от имени root'а, и далее добавьте пользователя, используя
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">vipw(8)</a>:
<pre>
  _spamd:*:62:62::0:0:Spam daemon:/var/empty:/sbin/nologin
</pre>

    <a name="3.2.5"></a>
    <h3>
      3.2.5: Псевдоним для ipv6-icmp (2002/12/30)
    </h3>

    <p>Новый псевдоним для ipv6-icmp, <em>icmp6</em>, был добавлен в 
      <tt>/etc/protocols</tt>. Если вы хотите использовать псевдоним 
      <em>icmp6</em> (используется при регрессионном тестировании
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8">pfctl(8)</a>
      ), то вы 
      должны изменить строку <em>ipv6-icmp</em> в <tt>/etc/protocols</tt>, добавив 
      <em>icmp6</em> перед символом #. Строка должна выглядеть так:
    </p>
<pre>
  ipv6-icmp 58    IPv6-ICMP icmp6 # ICMP for IPv6 
</pre>

    <a name="3.2.6"></a>
    <h3>
      3.2.6: Новая группа _lkm (2003/01/05)
    </h3>

    <p>Группа <em>_lkm</em> создана для доступа к <tt>/dev/lkm</tt>.
	  <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=modstat&amp;sektion=8">modstat(8)</a>
          теперь работает с идентификатором группы _lkm.
    <p>
      Вы должны добавить эту группу и установить права на <tt>/dev/lkm</tt> 
      перед запуском &quot;make build&quot;. Следующие команды, запущенные 
      от имени root'а, сделают это: 
<pre>
  # groupadd -g 61 _lkm
  # chgrp _lkm /dev/lkm
</pre>

    <a name="3.2.7"></a>
    <h3>
      3.2.7: Новая libpthread (2003/01/14)
    </h3>

    <p><em>libc_r</em> и <em>libnpthread</em> были удалены и заменены 
    новой библиотекой <em>libpthread</em>. Программы, использующие потоки 
    по-прежнему должны компилироваться с опцией -pthread, компилятор 
    сам сделает правильный выбор. 

    <p>Перед удалением <em>libc_r</em> и <em>libnpthread</em>, приложения
    использующие потоки должны быть пересобраны, используя <em>libpthread</em>.
    Рекомендованная последовательность сборки: 

    <ol>
      <li>
        <p>собираем gcc, следуя указаниям раздела <a href="#1.8">1.8</a>.
      <li>
        <p>пересобираем систему, следуя указаниям раздела 
          <a href="#1.5">1.5</a>.
      <li>
        <p>пересобираем все порты использующие потоки.
      <li>
        <p>удаляем более не используемые библиотеки:
<pre>
  # rm /usr/lib/libc_r* /usr/lib/libnpthread*
</pre>
    </ol>

    <a name="3.2.8"></a>
    <h3>
      3.2.8: Изменения компоновщика на ELF архитектурах (2003/01/17)
    </h3>

    <p>ld из коллекции binutils изменился для ввода нового средства 
    безопасности в исполняемые модули ELF. Теперь формат компоновщика 
    изменился так, что бы помечать, как исполняемые, только соответствующие 
    секции образа программы, вместо того, чтобы позволять ему помечать 
    также и секции даты в программах и общих библиотеках. Все изменения 
    применимы только к архитектурам базирующимся на ELF: alpha, sparc, 
    sparc64, macppc. 
    <p>
    Рекомендуется пересобрать binutils прежде остальной части системы.
    <p>
<pre>
  # cd /usr/src/gnu/usr.bin/binutils
  # make -f Makefile.bsd-wrapper cleandir
  # make -f Makefile.bsd-wrapper obj
  # make -f Makefile.bsd-wrapper depend
  # make -f Makefile.bsd-wrapper
  # make -f Makefile.bsd-wrapper install
</pre>
    <p>
    И далее пересобрать систему следуя указаниям раздела <a href="#1.5">1.5</a>

    <a name="3.2.9"></a>
    <h3>
      3.2.9: Удаление /var/at и изменения crontab (2003/02/19)
    </h3>

    <p>Содержимое <tt>/var/at</tt> было перенесено в <tt>/var/cron</tt>, 
      так как <em>at</em> теперь встроен в <em>cron</em>. Кроме того, 
      <em>cron</em>'овские файлы управления доступом были переименованы 
      в cron.allow и cron.deny для совместимости с POSIX и согласования 
      с at.allow и at.deny.
    <p>
    Прежде всего пересоберите систему, как описано в разделе 
    <a href="#1.5">1.5</a>. 
    А потом переместите существующие файлы и перезапустите cron:
    <p>
<pre>
  # mv /var/at/* /var/cron
  # mv /var/cron/jobs /var/cron/atjobs
  # mv /var/cron/allow /var/cron/cron.allow
  # mv /var/cron/deny /var/cron/cron.deny
  # rm -rf /var/at 
  # kill `cat /var/run/cron.pid`
  # /usr/sbin/cron
</pre>
    <p>
    Проигнорируйте все предупреждения об отсутствии файлов allow и deny. 
    Не все они существуют в стандартной установке.
    <p>
    Если у вас до сих пор нет файла cron.deny 
    (он не устанавливался до релиза 3.3), вы должны будете запустить 
    <em>crontab</em> не как суперпользователь.
<pre>
  # install -c -o root -g crontab -m 660 /dev/null /var/cron/cron.deny
</pre>

    <a name="3.1"></a>
    <h2>
      Обновляем с 3.1
    </h2>
    
    <a name="3.1.1"></a>
    <h3>
      3.1.1: Новые пользователи и группы 
    </h3>

    <p>Было добавлено несколько новых групп и пользователей. 
      Одна из них нужна для поддержки 
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=authpf&amp;sektion=8"
      >authpf(8)</a>, для поддержки разделения привелигий 
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sshd&amp;sektion=8">sshd(8)</a>, 
      были добавлены пользователь и группа <em>sshd</em>. Также было 
      добавленно большое число новых пользователей для системных 
      служб, все они начинаются с префикса &quot;_&quot;. Добавьте перечисленных 
      ниже пользователей, используя
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">vipw(8)</a>:
    </p>
<pre>
  sshd:*:27:27::0:0:sshd privsep:/var/empty:/sbin/nologin
  _portmap:*:28:28::0:0:portmap:/var/empty:/sbin/nologin
  _identd:*:29:29::0:0:identd:/var/empty:/sbin/nologin
  _rstatd:*:30:30::0:0:rpc.rstatd:/var/empty:/sbin/nologin
  _rusersd:*:32:32::0:0:rpc.rusersd:/var/empty:/sbin/nologin
  _fingerd:*:33:33::0:0:fingerd:/var/empty:/sbin/nologin
  _x11:*:35:35::0:0:X server:/var/empty:/sbin/nologin
</pre>
    
    <p>Добавьте перечисленные ниже группы в <tt>/etc/group</tt>:</p>
       
<pre>
  sshd:*:27:
  _portmap:*:28:
  _identd:*:29:
  _rstatd:*:30:
  _rusersd:*:32:
  _fingerd:*:33:
  _sshagnt:*:34:
  _x11:*:35:
  authpf:*:72:
</pre>

    <a name="3.1.2"></a>
    <h3>
      3.1.2: Новая группа для crontab(1) и at(1) 
    </h3>

    <p>
      Комманды  
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=crontab&amp;sektion=1">
      crontab(1)</a> и
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=at&amp;sektion=1">
      at(1)</a>более не работают от имени root'а, теперь они работают с 
      идентификатором группы <em>crontab</em>.

    <p>
      Прежде чем выполнить &quot;make build&quot;, вам нужно добавить 
      группу <em>crontab</em>.
       Вставьте сроку подобную нижеприведенной в ваш файл <tt>/etc/group</tt>:
       </p>

<pre>
  crontab:*:66:
</pre>

<p>
      Комманда &quot;make build&quot; установит для вас некоторые 
      (но не все) права. После завершения &quot;make build&quot;, 
      вы должны вручную выполнить следующие комманды 
      (подразумевается использование <tt>/bin/csh</tt>):
</p>

<pre>
  # chgrp crontab /var/at/at.{allow,deny} /var/cron/{allow,deny}
  # chmod 0640 /var/at/at.{allow,deny} /var/cron/{allow,deny}
  # foreach f ( /var/cron/tabs/* )
	  set u=`basename $f`
 	  chown $u:crontab $f
    end
</pre>

<p>
      Возможно у вас не будет некоторых из перечисленных файлов, 
      это не проблема.
</p>

    <a name="3.1.3"></a>
    <h3>
      3.1.3: Новые Binutils 
    </h3>

<p>
Новые binutils (2.11.2) попали в дерево, требуя обновленной 
<em>libiberty</em>. Для сборки этой библиотеки, выполните 
следующие шаги: 
</p>
  
<pre>
  # cd /usr/src/gnu/egcs/libiberty
  # make -f Makefile.bsd-wrapper cleandir
  # make -f Makefile.bsd-wrapper obj
  # make -f Makefile.bsd-wrapper depend
  # make -f Makefile.bsd-wrapper
  # make -f Makefile.bsd-wrapper install
</pre>

    <a name="3.1.4"></a>
    <h3>
      3.1.4: Новая конфигурация S/Key
    </h3>

    <p>
      Старый файл базы данных S/Key, <tt>/etc/skeykeys</tt>, был заменен на 
      директорию <tt>/etc/skey</tt>, в которой каждая запись является файлом,
      принадлежащим соответствующему пользователю.
      Вы можете сконвертировать <tt>/etc/skeykeys</tt> в новый формат, 
      выполнив (от имени root'а): 
    </p>
<pre>
  # skeyinit -C
  # mv /etc/skeykeys /etc/skeykeys.OLD
</pre>

<p>
      Все программы третьих лиц, которые напрямую используют S/Key, 
      должны быть перекомпилированы.
</p>

    <a name="3.1.5"></a>
    <h3>
      3.1.5: Новые разрешения для lp* 
    </h3>

    <p>
      Директории спула, используемые lpd, теперь должны быть 
      записываемыми для группы daemon, для того, что бы lpr 
      мог буферизовать файлы. Вдобавок файлы находящиеся внутри 
      спуловых директорий должны принадлежать пользователю и группе daemon. 
      Это требование может быть выполнено следующими командами:
    </p>
<pre>
 # find /var/spool/output /var/spool/lpd -type d \
	-execdir chgrp daemon {} \; -execdir chmod g+rwx {} \;
 # find /var/spool/output /var/spool/lpd -type f \
	-execdir chown daemon:daemon {} \;
</pre>

    <a name="3.1.6"></a>
    <h3>
      3.1.6: atrun(8) больше не используется
    </h3>

    <p>
      Команда 
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=atrun&amp;sektion=8">atrun(8)</a>
      больше не нужна. Ее функциональность включена в 
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=cron&amp;sektion=8">cron(8)</a>.
      Вы должны удалить задачу <tt>/usr/libexec/atrun</tt> из root'овского
      crontab'а выполнив, как root, следующие команды: 
    </p>
    <pre>
      # crontab -e
    </pre>

    <p>
      Вы также можете удалить <tt>/usr/libexec/atrun</tt>,
      <tt>/usr/share/man/cat8/atrun.0</tt> и директорию <tt>/var/at/spool</tt>
    </p>

    <a name="3.1.7"></a>
    <h3>
      3.1.7: nat.conf перенесен в pf.conf 
    </h3>

    <p>
    <tt>/etc/nat.conf</tt> теперь перенесен в <tt>/etc/pf.conf</tt>. 
    Вы должны вставить ваши NAT правила в pf.conf после очищающих 
    и перед фильтрующими правилами. 
    </p>
    <p>
    В
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8">pfctl(8)</a> 
    был добавлен ключ для загрузки правил, -f, а опции -R и -N теперь 
    имеют новое значение. Удостоверьтесь, что вы проверили страницы 
    манов и обновили ваш <tt>/etc/rc</tt>. 
    </p>

    <a name="3.1.8"></a>
    <h3>
     3.1.8: Новая запись в fbtab для xdm 
    </h3>

    <p>
Для
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=login&amp;sektion=1">
login(1)</a> требуется сделать нового пользователя _x11 владельцем 
/dev/wsmouse, который используется xdm'ом, исключительно для ревокационных 
привилегий, на многих архитектурах. Изменения в <tt>/etc/fbtab</tt> 
архитектурно зависимые. Файл создан посредством следующего процесса 
(подразумевается, что исходники лежат в /usr/src): 
    </p>
<pre>
  # cat /usr/src/etc/fbtab.head > /etc/fbtab
  # cat /usr/src/etc/etc.`uname -m`/fbtab >> /etc/fbtab
  # cat /usr/src/etc/fbtab.tail >> /etc/fbtab
</pre>
<p>
Если у вас есть собственные изменения в <tt>/etc/fbtab</tt>, вы должны 
добавить их туда вручную.
</p>
   <a name="3.1.9"></a>
   <h3>
    3.1.9: Использование __attribute__((sentinel)) в определенных функциях
   </h3>

   <p>
     __attribute__((sentinel)) теперь используется для определения 
     <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=exec&amp;sektion=3">
     exec(3)</a>
     функций, которые используются без завершающего нулевого указателя. 
     <br><br>Вы должны пересобрать gcc, как описано в разделе 
     <a href="#1.8">1.8</a>,
      прежде чем выполнить <tt>make build</tt>.
   </p>

    <a name="3.0"></a>
    <h2>
      Обновляем с 3.0
    </h2>
    
    <a name="3.0.1"></a>
    <h3>
      3.0.1: mtree(8) поддерживает новое ключевое слово
    </h3>

    <p>
      Вы должны собрать и установить новую версию утилиты
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8">
      mtree(8)</a>, прежде чем выполнить &quot;make build&quot;.
    </p>
<pre>
  # cd /usr/src/usr.sbin/mtree
  # make cleandir
  # make obj
  # make depend
  # make
  # make install
</pre>

    <a name="3.0.2"></a>
    <h3>
      3.0.2: Удаление libdl на ELF платформах
    </h3>
    
    <p>
      ELF платформы (alpha, macppc и sparc64) больше не используют libdl. 
      Обновление libdl-системы на не-libdl лучше выполнить 
      описанными ниже шагами: 
    </p>

    <ul>
      <li>
	<p>Пересобрите систему:</p>
<pre>
  # cd /usr/src
  # make build
</pre>
      </li>

      <li>
	<p>
	  Если команда &quot;make build&quot; завершилась удачно, 
	  вы можете перейти к следующему шагу и удалить libdl. 
	  Пакеты которые использовали libdl должны быть переустановлены 
	  заново. Если вы не готовы проделать это, можете пока 
	  пропустить этот шаг. Снапшоты с исправленными пакетами будут 
	  сделаны доступными. 
	</p>
<pre>
  # rm -f /usr/lib/libdl.* /usr/lib/libdl_pic.a
</pre>
	</li>
      <li>
	<p>
	  После удаления libdl, регенерируйте кеш ваших общих библиотек:
	</p>
	
<pre>
  # ldconfig -R
</pre>
      </li>
    </ul>

    <a name="3.0.3"></a>
    <h3>
      3.0.3: Новый регрессивный каркас
    </h3>
    
    <p>
      Была введена новая инфраструктура для регрессионного тестирования и, 
      вместе с ней, был добавлен файл <tt>bsd.regress.mk</tt>. 
      Вы должны установить этот файл, прежде чем выполнить <em>make obj</em>. 
    </p>

<pre>
  # cd /usr/src/share/mk
  # make install
</pre>

    <a name="3.0.4"></a>
    <h3>
      3.0.4: Конфигурационные файлы ssh перенесены в /etc/ssh/
    </h3>

    <p>
      Для начала вы должны создать директорию /etc/ssh/, смотрите раздел
      <a href="#1.13">1.13</a>
    </p>

    <p>
      Пересобрите систему:
    </p>
<pre>
  # cd /usr/src
  # make build
</pre>

    <p>
      Переместите все файлы /etc/ssh*_* в только что созданную 
      директорию /etc/ssh/:
    </p>
<pre>
  # cd /etc
  # mv ssh*_* ssh/
</pre>

    <p>
      Также вы должны учесть эти 
      <a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/rc.diff?r1=1.188&amp;r2=1.189">
      изменения в ваших <tt>rc</tt> скриптах</a>.
    </p>

    <p>
      Обновите все строки <tt>HostKey</tt> в вашем sshd_config, указав в них 
      новый путь. Для примера:
    </p>
<pre>
  HostKey /etc/ssh_host_key
</pre>

    <p>должен быть заменен на:</p>

<pre>
  HostKey /etc/ssh/ssh_host_key
</pre>

    <p>
      После этого вы можете перезапустить демон sshd.
    </p>

    <a name="2.9"></a> 
    <h2>Обновляем с 2.9</h2>

    <a name="2.9.1"></a> 
    <h3>2.9.1: Новые пользователи и группы - <em>proxy</em>, <em>smmsp</em> и
      <em>popa3d</em>.</h3>

    <p>
      Во-первых, новые пользователь и группа <em>proxy</em> были добавлены
      в систему, в дополнение к новому пакетному фильтру 
      <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4">
      pf(4)</a>, и его части <a href=
	 "http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8"
      >ftp-proxy(8)</a>. Для внесения этих изменений, добавьте следующую 
      строку, используя <a href=
	 "http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">
      vipw(8)</a>:</p>
<pre>
proxy:*:71:71::0:0:Proxy Services:/nonexistent:/sbin/nologin
</pre>

    <p>Также добавьте группу <em>proxy</em> в /etc/group:</p>

<pre>
proxy:*:71:
</pre>
    <p>Во-вторых, в связи с обновлением Sendmail 8.12, sendmail 
    больше не работает от имени root'а, в связи с этим в систему 
    добавили пользователя и группу <em>smmsp</em>.
    Добавьте следующую стоку в ваш файл <tt>/etc/group</tt>:</p>
<pre>
smmsp:*:25:
</pre>

    <p>Далее, запустите 
      <a href=
	 "http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">
	vipw(8)</a> и добавьте пользователя <em>smmsp</em>:</p>

<pre>
smmsp:*:25:25::0:0:Sendmail Message Submission Program:/nonexistent:/sbin/nologin
</pre>

    <p>Убедитесь что эта строка расположена выше любых <a href=
      "http://www.openbsd.org/cgi-bin/man.cgi?query=yp&amp;sektion=8">
      yp(8)</a> строк.</p>

    <p>И наконец, новые пользователь и группа, для сервера 
      Solar Designer's popa3d, стали частью системы.
      Добавьте следующее в <tt>/etc/group</tt>:</p>

<pre>
popa3d:*:26:
</pre>

    <p>И, используя <a href=
      "http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">
      vipw(8)</a>, добавьте</p>
<pre>
popa3d:*:26:26::0:0:POP3 server:/var/empty:/sbin/nologin
</pre>

    <a name="2.9.2"></a> 
    <h3>2.9.2: Новый пакетный фильтр: <em>pf</em></h3>

    <p>Файервол IPF, использовавшийся в ранних версиях OpenBSD, 
      был заменен на абсолютно новый файервол, названный <a href=
      "http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4">
      pf(4)</a>. В результате этой замены, нужно проделать некоторые
      изменения.</p>

    <p>Во-первых, <em>pf</em> работает с новым устройством. Что бы быть 
    уверенным, что это устройство создано, проделайте следующее:</p>

<pre>
  # cd /dev
  # cp /usr/src/etc/etc.`machine`/MAKEDEV ./
  # ./MAKEDEV all
</pre>

    <p>Во-вторых, произошло несколько изменений в файловой структуре. 
    Приведенные ниже приложения были заменены:</p>

<pre>
СТАРЫЕ:
/sbin/ipf /sbin/ipfstat /sbin/ipnat /usr/sbin/ipfs
/usr/sbin/ipftest /usr/sbin/ipmon /usr/sbin/ipresend
/usr/sbin/ipsend /usr/sbin/iptest
НОВЫЕ:
/sbin/pfctl
/usr/libexec/ftp-proxy
</pre>

    <p>Аналогично для устройств:</p>

<pre>
СТАРЫЕ: /dev/ipl /dev/ipnat /dev/ipstate /dev/ipauth
НОВЫЕ: /dev/pf
</pre>

    <p>И наконец, файлы настроек фильтра:</p>

<pre>
СТАРЫЕ: /etc/ipf.rules /etc/ipnat.rules
НОВЫЕ: /etc/pf.conf /etc/nat.conf
</pre>
    <p>Старые примеры настроек ipfilter'а могут быть удалены:
    </p>
<pre>
  # rm -rf /usr/share/ipf
</pre>

    <p>Механизм запуска <em>pf</em> находится в файлах <tt>/etc/rc</tt> и
      <tt>/etc/rc.conf</tt>. Поэтому данные файлы нужно обновить.
      Если вы хотите задействовать <em>pf</em>, установите PF=YES 
      в <tt>/etc/rc.conf</tt>.</p>

    <a name="2.9.3"></a> 
    <h3>2.9.3: Изменение <em>make</em></h3>

    <p>В <a href=
    "http://www.openbsd.org/cgi-bin/man.cgi?query=make&amp;sektion=1">
    make(1)</a> и ее файлах данных произошли изменения, 
    поэтому процесс сборки может осложниться. Обычно это обнаруживается, 
    в виде ошибок из <em>bsd.own.mk</em> в процессе сборки. 
    Для устранения этих неприятностей, обновите файлы с данными:</p>
<pre>
  # cd /usr/src/share/mk
  # make install
</pre>

    <p>И затем соберите и установите новый make.</p>

<pre>
  # cd /usr/src/usr.bin/make
  # make clean &amp;&amp; make obj &amp;&amp; make depend &amp;&amp; make
  # make install
</pre>

    <p>Теперь можно продолжить обновление.</p>
    
    <a name="2.9.4"></a>
    <h3>2.9.4: Изменения в KerberosV, препятствуют процессу сборки</h3>

    <p>Перед сборкой системы, нужно собрать KerberosV.</p>

    <p>Если у вас до сих пор нет новой директории <tt>/etc/KerberosV</tt>, 
      созданной для хранения конфигурации KerberosV, воспользуйтесь утилитой
      <a href=
      "http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8">
      mtree(8)</a>, описанной в разделе <a href="#1.13">1.13</a>, 
      что бы создать ее:</p>

    <p>После этого соберите KerberosV</p>

<pre>
  # cd /usr/src/kerberosV
  # make obj
  # cd lib/roken
  # make 
  # cd ../../usr.bin/asn1_compile
  # make
  # make install
</pre>

    <p>Так же может понадобиться обновить ваш login.conf, в связи с переименованием файла 
    <tt>/usr/libexec/auth/login_krb-or-pwd</tt> в 
    <tt>login_krb<strong>4</strong>-or-pwd</tt>.</p>

    <a name="2.9.5"></a> 
    <h3>2.9.5: Новая версия <em>sendmail'а</em></h3>

    <p><a href=
      "http://www.openbsd.org/cgi-bin/man.cgi?query=sendmail&amp;sektion=8">
      sendmail(8)</a> был обновлен до версии 8.12. Так как в этой версии 
      он больше не работает от имени root'а, произошли значимые 
      изменения.</p>

    <ol>
      <li>Были добавлены пользователь и группа <em>smmsp</em>.
        Если у вас их до сих пор нет, выполните интсрукции  
        раздела <a href="#2.9.1">2.9.1</a>.</li>

      <li>Произошло несколько изменений в файловой структуре, 
      появилась новая директория <tt>/var/spool/clientmqueue</tt> и 
      новые разрешения для <tt>/var/spool/mqueue</tt>. Все эти изменения 
      можно произвести, используя <a href=
      "http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8">
      mtree(8)</a>, как описано в разделе <a href="#1.13">1.13</a>.</li>

      <li>
        <p>Добавьте нижеприведенное в root'овский <a href=
        "http://www.openbsd.org/cgi-bin/man.cgi?query=crontab&amp;sektion=1">
        crontab(1)</a>. Это необходимо, поскольку <em>sendmail</em> 
        более не работает от имени root'а и полагается на эту запись 
        для выполнения части работы:</p>

<pre>
# sendmail clientmqueue runner
*/30    *       *       *       *       /usr/sbin/sendmail -L sm-msp-queue -Ac -q
</pre>

      </li>
      
      <li>
        <p>Обновляем sendmail:</p>

<pre>
  # cd /usr/src/gnu/usr.sbin/sendmail
  # make clean &amp;&amp; make obj &amp;&amp; make depend &amp;&amp; make &amp;&amp; make install
</pre>

        <p><strong>Замечание:</strong> В директорию <tt>/etc/mail</tt>
      установлены файлы <tt>submit.cf</tt> и <tt>localhost.cf</tt>. 
      Первый из них, <tt>submit.cf</tt> (известный как "клиентский" 
      конфигурационный файл, в текущей документации к sendmail'у), 
      используется почтовыми агентами, которые отправляют локальную почту, 
      посредством sendmail'а. В связи с изменениями разрешений, описанными 
      выше, данное действие не требует root'овских привилегий; sendmail 
      работает с идентификатором группы smmsp. Второй файл, 
      <tt>localhost.cf</tt>, это OpenBSD-ism, с которым sendmail слушает
      соединения только на локальном интерфейсе, принимая только локальные 
      подключения (для внешних подключений вы можете использовать, 
      <a href=
      "http://www.openbsd.org/cgi-bin/man.cgi?query=smtpd&amp;sektion=8">
      smptd(8)</a>, слушающего порт SMTP на внешнем интерфейсе). За 
      подробной информацией обратитесь к файлу <tt>SECURITY</tt> в 
      <tt>/usr/src/gnu/usr.sbin/sendmail/sendmail</tt>.</p>

        <p>Настоятельно рекомендуется регенерировать и обновить 
      конфигурационные файлы sendmail'а, в <tt>/etc/mail</tt>. 
      Примеры нескольких рабочих конфигураций вы можете найти в 
      <tt>/usr/share/sendmail/cf</tt>. <tt>localhost.cf</tt> был 
      сгенерирован из <tt>openbsd-localhost.mc</tt>.</p>
      </li>

      <li>
        <p>Если вы запускали sendmail без опции <tt>-bd</tt> в 
      <tt>/etc/rc.conf</tt>, которая установлена по умолчанию, 
      вам нужно будет использовать <tt>localhost.cf</tt>. 
      Отредактируйте <tt>rc.conf</tt> следующим образом:</p>
<pre>
# For normal use: "-L sm-mta -bd -q30m"
sendmail_flags="-L sm-mta -C/etc/mail/localhost.cf -bd -q30m"
</pre>
      </li>

      <li>
        <p>После того, как ваши конфигурационные файлы готовы, 
        завершите работу sendmail'а, используя <a href=
         "http://www.openbsd.org/cgi-bin/man.cgi?query=kill&amp;sektion=1">
        kill(1)</a>:</p>
<pre>
  kill `sed 1q /var/run/sendmail.pid`
</pre>

        <p>Запустите новый sendmail с нужными вам опциями, например:</p>
<pre>
  /usr/sbin/sendmail -L sm-mta -bd -q30m
</pre>

        <p>для конфигурации, принимающей почту извне, или</p>

<pre>
  /usr/sbin/sendmail -L sm-mta -C/etc/mail/localhost.cf -bd -q30m
</pre>

        <p>только для локальной почты.</p>
	
        <p><strong>Замечание:</strong>
      флаг <tt>-bd</tt> теперь требуется в обоих случаях.</p>
      </li>
    </ol>

    <p>Теперь новый <em>sendmail</em> должен работать.</p>

    <a name="2.9.6"></a> 
    <h3>2.9.6: Переименование <tt>/etc/primes</tt></h3>

    <p>Файл <tt>/etc/primes</tt> был переименован в <tt>/etc/moduli</tt>. 
    Просто скопируйте файл из его старого места или из 
    <tt>/usr/src/etc</tt>.</p>


    <hr width="30%">

    <address>
      <p>Правами на оригинальный текст владеет Kjell Wooding<br>
         Все комментарии, вопросы и обсуждения, на английском языке, присылайте по адресу <a
          href="mailto:kjell@openbsd.org">kjell@openbsd.org</a></p>
    </address>
    <small>
    Originally [OpenBSD: upgrade-minifaq.html,v 1.172]<br>
    $RuOBSD$<br>
    $Translation$<br>
    $OpenBSD$
    </small>
  </body>
</html>

