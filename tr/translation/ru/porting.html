<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=koi8-r">
  <meta name="resource-type" content="document">
  <meta name="description" CONTENT="How to make an OpenBSD port">
  <meta name="keywords" content="openbsd,ports">
  <meta name="distribution" content="global">
  <meta name="copyright" content="This document copyright 1997-2004 by OpenBSD">
  <title>Портирование под OpenBSD</title>
  <link rev="made" href="mailto:www@openbsd.org">
 </head>
 <body text="#000000" bgcolor="#FFFFFF" link="#23238E">

<a href="index.html"><img alt="[OpenBSD]" height="30" width="141"
	src="../images/smalltitle.gif" border="0"></a>

  <h2><font color="#e00000">Портирование под OpenBSD</font></h2>

   Итак, вы скомпилировали ваше любимое приложение под OpenBSD. Чтобы
   усилия не пропали даром, вам хочется поделиться успехом и создать
   порт программы. Что для этого необходимо сделать?

  <p>

   Самое важное - <strong>не молчать</strong>. Спросите в конференции
   <a href="mailto:ports@openbsd.org">ports@openbsd.org</a>, не ведется
   ли работа над этим портом. Напишите о создании порта автору программы,
   сообщите о проблемах, которые вам удалось найти. Если сведения о
   лицензии  некорректны, сообщите ему об этом. Если для того, чтобы
   собрать порт, вам пришлось пройти огонь, воду и медные трубы, расскажите
   автору программы, что в ней нужно исправить. И, наконец, если автор
   программы пишет только под Linux и не думает, что пользователи других
   систем заслуживают внимания, постарайтесь переубедить его.

  <p>

   Прежде всего прочитайте информацию на этой странице. После этого
   обратитесь к смежным документам, в особенности к
   <a href="../checklist.html">списку требований</a> к портированным приложениям.

  <p>

   Наконец, проведите как можно более тщательное тестирование порта!

  <p>

   После этого порт можно отсылать. Запакуйте директорию, в которой хранятся
   файлы порта, tar-ом и gzip-ом. Выложите архив на FTP или веб-сервере и
   пошлите ссылку на него в конференцию
   <a href="mailto:ports@openbsd.org">ports@openbsd.org</a>.
   Вы можете также послать в конференцию сам файл в кодировке MIME,
   если вам так удобнее.

<h3><font color="#0000e0">Разделы документа</font></h3>
<ul>
<li><a href="#Avail">Доступная информация по портированию</a></li>
<li><a href="#Policy">Правила портирования на OpenBSD</a></li>
<li><a href="#Security">Рекомендации по безопасности</a></li>
<li><a href="#Generic">Общие советы</a></li>
<li><a href="#Other">Другая полезная информация</a></li>
</ul>

  <h3><font color="#0000e0">
  <a name="Avail">Доступная информация по портированию</a></font></h3>

  <ul>
   <li>
    <a href="../checklist.html">Список требований</a> к портированным приложениям.

   <li>
    Страница руководства <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=bsd.port.mk&amp;sektion=5">bsd.port.mk(5)</a>.
    Это документация по makefile из инфраструктуры портов. Он подключается в
    каждом отдельном порте. Работа над этим руководством все еще не завершена,
    но большинство полезной информации документирована.

   <li>
    Отличия от других систем портов BSD, в основном,
    <a href="../porting/diffs.html">отличия в инфраструктуре</a>.

   <li>
    <a href="../porting/libraries.html">Использование разделяемых библиотек
    в портах OpenBSD</a>. Описываемые в документе правила
    <strong>очень важны</strong> при использовании разделяемых библиотек,
    особенно с учетом появления в перспективе pkg_update.

   <li>
    <a href="../audio-port.html">Портирование приложений для работы с
    аудио на OpenBSD</a>.

   <li>
    <a href="http://www.netbsd.org/Documentation/software/packages.html">Документация по системе пакетов NetBSD</a>.
    В этом весьма полезном документе описывается NetBSD-версия системы
    портов FreeBSD.

   <li>
    <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/porters-handbook/index.html">Руководство по портированию приложений на FreeBSD</a>.
    Это основной документ, используемый при переносе приложений на эту систему.

   <li>
    Список рассылки <a href="mailto:ports@openbsd.org">ports@OpenBSD.ORG</a>.

  </ul>

  <h3><font color="#0000e0">
  <a name="Policy">Правила портирования на OpenBSD</a></font></h3>

  <ul>
   <li>
    В OpenBSD не используется подсистема <code>/usr/local/etc/rc.d</code>.<br>
    <code>/usr/local</code> часто экспортируется по NFS и используется
    несколькими машинами. По этой причине конфигурационные файлы для каждой
    отдельной машины хранятся не в <code>/usr/local</code>, а в
    <code>/etc</code>. Еще одним правилом OpenBSD является то, что файлы в
    <code>/etc</code> никогда не обновляются автоматически. Если для порта
    требуется выполнение каких-либо действий при загрузке системы, то вместо
    автоматической правки файлов в <code>/etc</code>, администратору должны
    быть предоставлены сведения о том, что необходимо сделать. 
   <li>
    В OpenBSD не производится сжатие страниц руководства.
   <li>
    В OpenBSD не требуется <code>-lcrypt</code>.<br>
    Шифрование по алгоритму DES является частью стандартной библиотеки
    <code>libc</code>.
   <li>
    В OpenBSD есть отдельное пространство имен для пользователей и групп,
    создаваемых портами. Посмотрите
    <code>/usr/ports/infrastructure/db/user.list</code>.
   <li>
    В OpenBSD огромную роль играет безопасность. Внимательно прочтите 
     <a href="#Security">раздел по безопасности</a> на этой странице. 
   <li>
    Добавьте в Makefile CVS-тэг <code>&#36;OpenBSD&#36;</code>.
    Если программа портируется с другой системы, оставьте в Makefile
    тэг этой системы. Однако тэг <code>&#36;Id&#36;</code> для FreeBSD
    должен быть заменен на <code>&#36;FreeBSD&#36;</code>. 
   <li>
    В идеале все портированные приложения должны поддерживать OpenBSD.
    Чтобы добиться этого, вам <strong>необходимо</strong> отправить все
    проделанные изменения лицу, занимающемуся поддержкой этой программы.
  </ul>

  <h3><font color="#0000e0">
  <a name="Security">Рекомендации по безопасности</a></font></h3>

  Как разработчик порта, вы должны принимать во внимание множество вопросов,
  связанных с безопасностью. Если у вас возникают сомнения, обратитесь в
  <a href="mailto:ports@openbsd.org">список рассылки, посвященный портам</a>.

  <ul>
   <li>
    <em>Не используйте</em> альфа- или бета-версию программы для портирования.
    Это должна быть последняя стабильная версия или версия с исправлениями
    (patch release).

   <li>
    Приложения-сервера нужно тщательно проанализировать на предмет
    переполнения буфера. В особенности, на использование небезопасных
    функций <code>strcat/strcpy/strcmp/sprintf</code>.
    <code>sprintf</code> должен быть заменён на <code>snprintf</code>.

   <li>
    Для обеспечения безопасности системы не используйте временные файлы с
    жестко заданными именами. Может получиться так, что вы не сможете
    контролировать их. Например, злоумышленник, имеющий пользовательский
    доступ в систему, может заменить файлы в каталоге <code>/tmp</code>
    символическими ссылками на более важные системные файлы, например,
    <code>/etc/master.passwd</code>.

   <li>
    Например, <code>fopen</code> и <code>freopen</code> создают новый файл
    или открывают существующий файл для записи. Злоумышленник может создать
    символическую ссылку <code>/tmp/addrpool_dump</code> на файл
    <code>/etc/master.passwd</code>. Как только ссылка будет открыта, файл
    паролей будет поврежден. Даже если перед открытием вы вызовете функцию
    <code>unlink</code>, этим вы просто ограничите вероятность атаки.
    Вместо <code>fopen</code> и <code>freopen</code> рекомендуется
    использовать <code>open</code> с <code>O_CREAT|O_EXCL</code> и
    <code>fdopen</code>.
                 
   <li>
    Еще одна часто встречающаяся проблема заключается в использовании функции
    <code>mktemp</code>. Если линковщик bsd выдает предупреждения по поводу ее
    использования, внесите необходимые поправки в исходный код.
    Это не просто <code>s/mktemp/mkstemp/g</code>.<br>
    Обратитесь к странице руководства <code>mktemp(3)</code> за более
    подробной информацией. Правильное использование <code>mkstemp</code>
    можно увидеть в исходном коде <code>ed</code> и <code>mail</code>.
    Редким случаем правильного использования <code>mktemp</code>
    является порт <code>rsync</code>.

   <li>
    Факт наличия прав на чтение файла не означает то, что программа должна
    его читать. Известный случай уязвимости такого рода был в
    <code>startx</code>. Поскольку это была setuid-программа, то ее можно
    было запускать с любым файлом в роли скрипта. Если файл не был скриптом,
    выдавалось сообщение о синтаксической ошибке в выводилась первая
    строка этого файла без проверки прав доступа. Это позволяло, например,
    получить первую строку из файла паролей, который обычно начинается с
    записи root. Не следует также открывать файл, а затем смотреть с
    помощью <code>fstat</code>, возможно ли открытие (злоумышленник может
    воспользоваться этим, чтобы получить доступ к /dev/rst0 и перемотать
    ленту). Вместо этого, открывайте файл с заведомо правильными uid, gid
    и списком групп.

   <li>
    Setuid-программы не должны порождать shell пока не сбросят привилегии.
    Это относится к <code>popen</code> и <code>system</code>. Вместо них
    используйте <code>fork</code>, <code>pipe</code> и <code>execve</code>.

   <li>
    Передавайте внешним программам дескрипторы открытых файлов вместо имен
    во избежание race condition. Если программа не может принять файловый
    дескриптор, используйте их именной аналог, например <code>/dev/fd/0</code>.

   <li>
    Права доступа передаются вместе с файловыми дескрипторами. Если вам
    необходимо использовать setuid для получения прав на открытие файла,
    откройте его, а затем сбросьте привилегии. Вы по-прежнему сможете
    обращаться к открытому файлу, однако, проблем, связанных с привилегиями,
    будет меньше. Но даже после сброса привилегий все равно следует
    внимательно следить за дескрипторами открытых файлов.

   <li>
    Избегайте setuid для root. С правами root можно выполнять любые действия
    в системе, но эти привилегии требуются очень редко. Исключением, возможно,
    является создания сокета с номером порта меньше 1024. Вероятно лучшим
    решением будет передать это под управление <code>inetd</code> и просто
    добавить необходимые записи в <code>inetd.conf</code>. Для написания
    таких сервисов, необходимы специальные знания, а без них лучше и не
    пытаться писать setuid-программы.

   <li>
    Используйте setgid вместо setuid. За исключением особых файлов,
    используемых setgid-программами, большинство файлов не доступны для
    записи группе. Поэтому уязвимость в setgid-программе не будет опасна
    для системы в целом. Самое худшее, что сможет сделать взломщик, это,
    например, изменить данные в файле с результатами игры и т.п.

   <li>
    Не доверяйте файлам, доступным для записи группе. Несмотря на то, что
    setgid программы прошли аудит, они не рассматриваются как объекты
    повышенной опасности. Поэтому в данных, которыми они оперируют не
    должна содержаться важная информация.

   <li>
    Не полагайтесь на переменные окружения! Это касается переменной
    <code>PATH</code> (не используйте <code>system</code> с неопределенным
    именем, избегайте использования <code>execvp</code>), а также более
    тонких вещей вроде локали, часового пояса, настроек терминала и так
    далее. Помните о том, что даже если вы приняли все меры предосторожности,
    программы которые вы вызываете - нет. <strong>Никогда</strong> не
    используйте <code>system</code> в привилегированных программах.
    Полностью создавайте строку исполнения программы, переменные окружения
    и только тогда вызывайте <code>execve</code>. Прочитайте страницу
    руководства <code>perlsec</code>, в котором хорошо освещен данный вопрос.

   <li>
    Никогда не используйте setuid shell-скрипты. Они не безопасны.
    Запускайте их только внутри программы на C, которая обеспечит
    соответствующее окружение. Хотя, с другой стороны, в OpenBSD
    используются вполне безопасные скрипты на perl.

   <li>
    Не забывайте о загрузчике динамических библиотек. Если вы работаете
    с setuid, то помните, что он использует только библиотеки, проверенные
    ldconfig. Использования setgid в данном случае недостаточно.

   <li>
    Ряд сложностей возникает с динамическими библиотеками, а также с кодом
    на C++. Проблема заключается в том, что код этих библиотек, в зависимости
    от установленного окружения, может выполняться до того, как основная
    часть программы начнет проверять свой setuid статус. С точки зрения
    разработчиков библиотек этим вопросом в OpenBSD занимается issetugid.
    Мы не рекомендуем вам портировать библиотеки, если вы не полностью
    понимаете весь ход этого процесса.
  </ul>

  <h3><font color="#0000e0">
  <a name="Generic">Общие советы</a></font></h3>

  <ul>
   <li>
    Ограничьте использование директивы <code>__OpenBSD__</code> или вообще
    откажитесь от нее. Использование конструкции вроде
     <pre>
          #if defined(__NetBSD__) || defined(__FreeBSD__)
     </pre>
    редко уместно. Мы не советуем вам просто добавлять к этому списку
    <code>__OpenBSD__</code>. Вместо этого выясните, использование какой
    функциональности за этим стоит. Помощь в этом вам могут оказать страницы
    руководства, из которых можно узнать, когда та или иная функциональность
    была впервые введена в BSD. Обычно правильное решение - это сравнение
    переменной <code>BSD</code> с номерами релизов. За дополнительной
    информацией обратитесь к <a href="ftp://ftp.netbsd.org/pub/NetBSD/packages/pkgsrc/Packages.txt">NetBSD package guide</a>.

   <li>
    Не определяйте сами параметр <code>BSD</code>. Вместо этого подключите
    <code>sys/param.h</code>. Это определит параметр <code>BSD</code> и
    присвоит ему верное значение. Фрагмент правильного кода:
     <pre>
         #if (defined(__unix__) || defined(unix)) &amp;&amp; !defined(USG)
         #include &lt;sys/param.h&gt;
         #endif
     </pre>

   <li>
    Тестируйте возможности, а не совместимость с операционными системами.
    В конце концов лучше выяснить, работает ли <code>tcgetattr</code>, чем
    определять выполняется ли программа под BSD 4.3 или SystemVR4. Тесты
    такого рода лишь вносят путаницу. Проведите тестирование под одной
    конкретной системой, установите значение <code>HAVE_TCGETATTR</code>,
    после чего переходите к другой системе. Бывает, что портирующий программу
    человек, чтобы сэкономить время, добавляет набор определений
    <code>-DHAVE_XXX</code> в Makefile. Или пишет конфигурационный скрипт,
    который проверяет наличие какой-либо функции и автоматически ее добавляет.
    Отрицательный пример - исходный код порта nethack 3.2.2, в котором очень
    много зависимостей от типа ОС. Большинство из них неактуальны: более
    удобно использовать POSIX функции, чем старые несовместимые функции BSD
    и SystemV. Тем более, что поддержка традиционных bsd функций сейчас
    осуществляется только через библиотеки совместимости.

   <li>
    Избегайте использование include файлов, которые включают другие include
    файлы. Во-первых, это неэффективно. Ваш проект кончит тем, что будет
    включать файл который подключает все остальное. Это делает некоторые
    проблемы трудно разрешимыми. И в один прекрасный момент станет сложно
    убрать из включений определенный файл.

   <li>
    Избегайте нестандартных операций с макросами. Не следует удалять макрос,
    определенный в заголовочном файле. Не следует также определять макрос
    для получения определенного поведения из include файла. Если необходимо
    соответствие с POSIX, определите <code>#define POSIX_C_SOURCE</code> для
    всего проекта, а не там где вы этого захотите.

   <li>
    Не нужно писать прототипы системных функций. Во всех современных системах,
    включая OpenBSD, для них существует стандартное место. Например, файлы
    <code>unistd.h</code>, <code>fcntl.h</code> или <code>termios.h</code>.
    Об их местоположении написано на соответствующей странице руководства.
    Для включения нужного файла вам может понадобиться набор из макросов
    <code>HAVE_XXX</code>. Даже если файл будет включен дважды, ничего
    страшного не произойдет.<br>
    Если для какой-то отдельной системы все таки необходимо написать прототип,
    не распространяйте это на все остальные системы. Такие прототипы могут
    привести к ошибке, поскольку в них могут использоваться типы данных
    которые не поддерживаются на других системах (например,
    <code>unsigned long</code> вместо <code>size_t</code>). К тому же,
    некоторые компиляторы, как gcc в OpenBSD, могут работать эффективнее
    с часто используемыми функциями, как <code>strlen</code>, если подключен
    правильный файл заголовка.

   <li>
    Не используйте имена стандартных функций для ваших собственных.
    Присваивайте им уникальное имя. Если позже возникнет необходимость
    использовать стандартную системную функцию, вам потребуется лишь
    закомментировать ваш код и определить макрос указывающий на системную
    функцию. Ниже приведен фрагмент правильного кода:

<pre>
       /* prototype part */
       #ifdef USE_OWN_GCVT
       char *foo_gcvt(double number, size_t ndigit, char *buf);
       #else
       /* include correct file */
       #include &lt;stdlib.h&gt;
       /* use system function */
       #define foo_gcvt  gcvt
       #endif

       /* definition part */
       #ifdef USE_OWN_GCVT
       char *foo_gcvt(double number, size_t ndigit, char *buf)
          {
          /* proper definition */
          }

       /* typical use */
       s = foo_gcvt(n, 15, b);
       </pre>
  </ul>

  <h3><font color="#0000e0">
  <a name="Other">Другая полезная информация</a></font></h3>

  <ul>
<!--
   FEEL FREE TO TRANSLATE ONLY IF YOU FULLY UNDERSTANDS THIS

   <li>Recent versions of <code>bsd.port.mk</code> set the installers
       path. Specifically, they set <code>/usr/bin</code> and
       <code>/bin</code> to be searched <em>before</em>
       <code>/usr/local/bin</code> and <code>/usr/X11R6/bin</code>.
-->

   <li>
    Не следует создавать разделяемые библиотеки (shared libs) если
    определена переменная <code>${NO_SHARED_LIBS}</code> (но будьте
    внимательны, она может быть определена только после включения
    <code>bsd.port.mk</code>). Если ваш порт использует GNU configure,
    добавьте строку
    <code>CONFIGURE_ARGS += ${CONFIGURE_SHARED}</code> в Makefile.

   <li>
    Допускается использовать функции, появившиеся в последних версиях
    <code>bsd.port.mk</code>, поскольку предполагается, что пользователи
    должны обновлять все дерево портов, в том числе и <code>bsd.port.mk</code>.
    NEED_VERSION более не используется.

   <li>
    В OpenBSD, <code>curses.h/libcurses/libtermlib</code> относятся к
    ``new curses''. Замените <code>ncurses.h</code> на <code>curses.h</code>.
    Чтобы использовать ``old (BSD) curses'', определите
    <code>_USE_OLD_CURSES_</code> перед включением файла <code>curses.h</code>
    (обычно в Makefile) и делайте линковку с параметром <code>-locurses</code>.

   <li>
    В OpenBSD организация терминала изменилась со старой BSD <code>sgtty</code>
    на новую <code>tcgetattr</code> семейства POSIX. Не рекомендуется
    использовать старую организацию в новых версиях программ. В некоторых
    случаях <code>tcgetattr</code> может определяться как синоним к
    <code>sgtty</code>, но в OpenBSD это может рассматриваться лишь в
    качестве временной меры. Отрицательным примером в данном случае может
    служить исходный код xterm. Правильно представьте функциональность
    системы: вам необходим тип данных, который запоминает состояние
    термианала (возможно typedef), необходима функция которая извлечет
    текущее состояние и функция которая установит новое состояние терминала.
    Функции, которые изменяют состояние более сложны, поскольку они различны
    в разных системах. Помните, что вам необходимо обработать случаи,
    при которых программа не соединена с терминалом; не забывайте и о
    сигналах, причем не только о сигнале завершения, но и о сигнале
    перевода процесса в фоновый режим (<code>SIGTSTP</code>). Программа
    должна возвращать терминал в нормальное состояние. Протестируйте свою
    программу под старой оболочкой, например sh, которая не возвращает
    терминал в исходное состояние.

   <li>
    Новые версии termcap/terminfo и curses, из поставки OpenBSD, содержат
    стандартные процедуры управления цветными терминалами. По возможности
    рекомендуется пользоваться ими, на других системах используйте
    стандартные ANSI коды. Однако, описания некоторых терминалов еще не
    обновились, и вам, возможно, придется вводить эти коды вручную. По
    такому принципу работает vim. Но это не является обязательным. Кроме
    случаев с привилегированными программами, возможно изменить
    переменную <code>TERMCAP</code> для корректной работы.

   <li>
    Семантика сигналов сложна и различна на разных системах. Обратитесь
    к странице руководства по <code>sigaction</code> за дополнительной
    информацией.
  </ul>

<hr>
<a href="index.html">
<img height="24" width="24" src="../back.gif" border="0" alt="OpenBSD"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>

<br>
<small>
Originally [OpenBSD: porting.html,v 1.47 ]<br>
$RuOBSD: porting.html,v 1.1 2004/02/16 20:24:59 dfa Exp $<br>
$Translation$<br>
$OpenBSD$
</small>

</body>
</html>
