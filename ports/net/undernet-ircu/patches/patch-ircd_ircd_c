$RuOBSD$
--- ircd/ircd.c.orig	Mon Jan  9 19:29:29 2006
+++ ircd/ircd.c	Mon Jan  9 19:33:47 2006
@@ -60,6 +60,7 @@
 #include <assert.h>
 #include <errno.h>
 #include <fcntl.h>
+#include <login_cap.h>
 #include <netdb.h>
 #include <pwd.h>
 #include <stdio.h>
@@ -71,7 +72,12 @@
 #include <unistd.h>
 
 
+#ifndef IRCD_USER
+#define IRCD_USER	"_ircd"
+#endif
 
+
+
 /*----------------------------------------------------------------------------
  * External stuff
  *--------------------------------------------------------------------------*/
@@ -577,12 +583,18 @@ static void set_core_limit(void) {
  * set_userid_if_needed()
  *--------------------------------------------------------------------------*/
 static int set_userid_if_needed(void) {
-  if (getuid() == 0 || geteuid() == 0 ||
-      getgid() == 0 || getegid() == 0) {
-    fprintf(stderr, "ERROR:  This server will not run as superuser.\n");
-    return 0;
-  }
+  struct passwd *pw;
 
+  if (geteuid() == 0) {
+    if ((pw = getpwnam(IRCD_USER)) == NULL) {
+      fprintf(stderr, "No passwd entry for %s!\n", IRCD_USER);
+      return 0;
+    }
+    if (setusercontext(NULL, pw, pw->pw_uid, LOGIN_SETALL) < 0) {
+      fprintf(stderr, "Can's set user context to %s!\n", IRCD_USER);
+      return 0;
+    }
+  }
   return 1;
 }
 
