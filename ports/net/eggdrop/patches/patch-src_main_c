$RuOBSD$
--- src/main.c.orig	Thu Jan  3 09:25:52 2002
+++ src/main.c	Wed Apr 24 00:29:05 2002
@@ -34,6 +34,8 @@
 #include "main.h"
 #include <fcntl.h>
 #include <time.h>
+#include <login_cap.h>
+#include <pwd.h>
 #include <errno.h>
 #include <signal.h>
 #include <netdb.h>
@@ -83,6 +85,7 @@ extern jmp_buf		 alarmret;
 
 char	egg_version[1024] = "1.6.8";
 int	egg_numver = 1060800;
+int	runasroot = 0;
 
 char	notify_new[121] = "";	/* Person to send a note to for new users */
 int	default_flags = 0;	/* Default user flags and */
@@ -94,7 +97,7 @@ int	con_chan = 0;		/* Foreground: consta
 				   stats? */
 int	term_z = 0;		/* Foreground: use the terminal as a party
 				   line? */
-char	configfile[121] = "eggdrop.conf"; /* Name of the config file */
+char	configfile[121] = ""; /* Name of the config file */
 char	helpdir[121];		/* Directory of help files (if used) */
 char	textdir[121] = "";	/* Directory for text files that get dumped */
 int	keep_all_logs = 0;	/* Never erase logfiles, no matter how old
@@ -771,9 +774,24 @@ int main(int argc, char **argv)
       do_arg(argv[i]);
   printf("\n%s\n", version);
 
-  /* Don't allow eggdrop to run as root */
-  if (((int) getuid() == 0) || ((int) geteuid() == 0))
-    fatal("ERROR: Eggdrop will not run as root!", 0);
+  /* Change user context to eggdrop if running as root */
+  if (!geteuid() || !getuid()) {
+    struct passwd *pw;
+
+    if ((pw = getpwnam("eggdrop")) == NULL) {
+      fprintf(stderr, "ERROR: invalid account: eggdrop\n");
+      exit(1);
+    }
+    if (setusercontext(NULL, pw, pw->pw_uid, LOGIN_SETALL) < 0) {
+      fprintf(stderr, "ERROR: couldn't set user context\n");
+      exit(1);
+    }
+    runasroot = 1;
+  }
+  if (!configfile[0])
+    strncpyz(configfile,
+     (runasroot ? "@eggdropdir@/eggdrop.conf" : "eggdrop.conf"),
+     sizeof(configfile));
 
   init_dcc_max();
   init_userent();
@@ -805,7 +823,8 @@ int main(int argc, char **argv)
   cache_miss = 0;
   cache_hit = 0;
   if (!pid_file[0])
-  egg_snprintf(pid_file, sizeof pid_file, "pid.%s", botnetnick);
+    egg_snprintf(pid_file, sizeof pid_file, "%s%s.pid",
+     (runasroot ? "@eggdropdir@/" : ""), botnetnick);
 
   /* Check for pre-existing eggdrop! */
   f = fopen(pid_file, "r");
