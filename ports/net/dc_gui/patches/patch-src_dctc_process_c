$OpenBSD$
--- src/dctc_process.c.orig	Sat Jan 26 16:33:33 2002
+++ src/dctc_process.c	Sun Nov 13 20:54:47 2005
@@ -22,6 +22,9 @@
 #include "gui_define.h"
 #include "search.xpm"
 
+#include "koi82win.h"
+#include "win2koi8.h"
+
 GPtrArray *op_array=NULL;
 
 /******************************************************************************/
@@ -125,6 +128,7 @@ static GString *get_dctc_line(void)
 	GString *s;
 	int n;
 	char c;
+	const char *str;
 
 	if(current_dctc==NULL)
 		return NULL;
@@ -146,6 +150,12 @@ static GString *get_dctc_line(void)
 			return NULL;
 		}
 
+		if(c&0x80)
+		{
+			str=win2koi8[c&0x7F];
+			c = *str;
+		}
+
 		s=g_string_append_c(s,c);
 	}while(c!='\n');
 
@@ -3340,9 +3350,18 @@ void process_data_to_dctc(gpointer data,
 void send_data_to_dctc(char *str)
 {
 	char *tm;
+	char *p;
+	const char *s;
 
 	if(current_dctc==NULL)
 		return;
+
+	for(p=str;*p;p++)
+		if(*p&0x80)
+		{
+			s=koi82win[*p&0x7F];
+			*p = *s;
+		}
 
 	/* if the wait_q is empty, we try to send the string without queueing */
 	/* else the string is queued and gdk_input handler is enabled */
